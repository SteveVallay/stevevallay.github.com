<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Zhibin's blog]]></title>
  <link href="http://SteveVallay.github.io/atom.xml" rel="self"/>
  <link href="http://SteveVallay.github.io/"/>
  <updated>2014-12-05T16:03:02+08:00</updated>
  <id>http://SteveVallay.github.io/</id>
  <author>
    <name><![CDATA[zhibin]]></name>
    <email><![CDATA[zhibinwang.q@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[android memory leak]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/11/17/memory-leak/"/>
    <updated>2014-11-17T14:27:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/11/17/memory-leak</id>
    <content type="html"><![CDATA[<p>Record fix issue &ldquo;<strong>Could not allocate CursorWindow &lsquo;/data/data/com.android.providers.telephony/databases/mmssms.db&rsquo; of size 2097152 due to error -12</strong>&rdquo; issue.</p>

<!-- more -->


<h3>Issue born</h3>

<p>One day, we met an issue caused Messages application force close.</p>

<p>This issue happen when do a simple Message case (new a message &ndash;> send &ndash;> delete all, then repeat many times)  more than 10 hours.</p>

<p>Logcat info as below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>E/CursorWindow( 1350): Could not allocate CursorWindow '/data/data/com.android.providers.telephony/databases/mmssms.db' of size 2097152 due to error -12.
</span><span class='line'>E/JavaBinder( 1350): *** Uncaught remote exception!  (Exceptions are not yet supported across processes.)
</span><span class='line'>E/JavaBinder( 1350): android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # Open Cursors=4 (# cursors opened by pid 16143=4)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.CursorWindow.&lt;init&gt;(CursorWindow.java:107)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.AbstractWindowedCursor.clearOrCreateWindow(AbstractWindowedCursor.java:198)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.sqlite.SQLiteCursor.fillWindow(SQLiteCursor.java:139)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.sqlite.SQLiteCursor.getCount(SQLiteCursor.java:133)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.CursorToBulkCursorAdaptor.getBulkCursorDescriptor(CursorToBulkCursorAdaptor.java:148)
</span><span class='line'>E/JavaBinder( 1350):  at android.content.ContentProviderNative.onTransact(ContentProviderNative.java:118)
</span><span class='line'>E/JavaBinder( 1350):  at android.os.Binder.execTransact(Binder.java:404)
</span><span class='line'>E/JavaBinder( 1350):  at dalvik.system.NativeStart.run(Native Method)</span></code></pre></td></tr></table></div></figure>


<h3>Guess root cause</h3>

<p>Our experience told us there were some <code>Cursor</code> not close in this application. Then we checked the code , search keywords <code>cursor</code> , but seems all <code>Cursor</code> were <strong>closed correctly</strong>.</p>

<p>We searched <a href="www.google.com">Google</a> and  <a href="www.stackoverflow.com">StackOverflow</a> , some <strong>similar</strong> issues founded :</p>

<ol>
<li><a href="http://stackoverflow.com/questions/17495713/could-not-allocate-cursorwindow">Could not allocate CursorWindow</a></li>
<li><a href="http://stackoverflow.com/questions/11340257/sqlite-android-database-cursor-window-allocation-of-2048-kb-failed">SQLite Android Database Cursor window allocation of 2048 kb failed</a></li>
</ol>


<p>They all said you need close cursor in finally, but actually cursor already closed in finally.</p>

<p>Then we find our issue&rsquo;s log really has some difference with issues from <a href="www.stackoverflow.com">StackOverflow</a></p>

<ul>
<li>log of our issue:</li>
</ul>


<p>E/JavaBinder( 1350): android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # <strong>Open Cursors=4</strong> (# cursors opened by pid 16143=4)</p>

<ul>
<li>log of <a href="www.stackoverflow.com">StackOverflow</a> issue:</li>
</ul>


<p>android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # <strong>Open Cursors=861</strong> (# cursors opened by this proc=861)</p>

<p>Opened cursor number is totally different, our is <strong>4</strong>, issue of <a href="www.stackoverflow.com">StackOverflow</a> &rsquo;s is <strong>861</strong>. If opened cursor number is large (hundreds of), we believe your code opened many cursors without close them, but this is not our case.</p>

<h3>Check code detail</h3>

<p>Failed to create new <code>CursorWindow</code>  throw such exception.</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/android/database/CursorWindow.java  CursorWindow</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">sCursorWindowSize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="cm">/** The cursor window size. resource xml file specifies the value in kB.</span>
</span><span class='line'><span class="cm">         * convert it to bytes here by multiplying with 1024.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">sCursorWindowSize</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">getSystem</span><span class="o">().</span><span class="na">getInteger</span><span class="o">(</span>
</span><span class='line'>            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">integer</span><span class="o">.</span><span class="na">config_cursorWindowSize</span><span class="o">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">mWindowPtr</span> <span class="o">=</span> <span class="n">nativeCreate</span><span class="o">(</span><span class="n">mName</span><span class="o">,</span> <span class="n">sCursorWindowSize</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mWindowPtr</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CursorWindowAllocationException</span><span class="o">(</span><span class="s">&quot;Cursor window allocation of &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="o">(</span><span class="n">sCursorWindowSize</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot; kb failed. &quot;</span> <span class="o">+</span> <span class="n">printStats</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>nativeCreate</code> returned  0.</p>

<figure class='code'><figcaption><span>frameworks/base/core/jni/android_database_CursorWindow.cpp nativeCreate</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">CursorWindow</span><span class="o">*</span> <span class="n">window</span><span class="p">;</span>
</span><span class='line'><span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">CursorWindow</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cursorWindowSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">window</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="o">!</span><span class="n">window</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Could not allocate CursorWindow &#39;%s&#39; of size %d due to error %d.&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">name</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span> <span class="n">cursorWindowSize</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>CursorWindow::create</code> returned non-zero.</p>

<figure class='code'><figcaption><span>frameworks/base/libs/androidfw/CursorWindow.cpp  CursorWindow::create</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">status_t</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">ashmemFd</span> <span class="o">=</span> <span class="n">ashmem_create_region</span><span class="p">(</span><span class="n">ashmemName</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ashmemFd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">ashmem_set_prot_region</span><span class="p">(</span><span class="n">ashmemFd</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">void</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="o">::</span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">ashmemFd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">ashmem_set_prot_region</span><span class="p">(</span><span class="n">ashmemFd</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">CursorWindow</span><span class="o">*</span> <span class="n">window</span> <span class="o">=</span> <span class="n">new</span> <span class="n">CursorWindow</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ashmemFd</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">false</span> <span class="cm">/*readOnly*/</span><span class="p">);</span>
</span><span class='line'>                <span class="n">result</span> <span class="o">=</span> <span class="n">window</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">LOG_WINDOW</span><span class="p">(</span><span class="s">&quot;Created new CursorWindow: freeOffset=%d, &quot;</span>
</span><span class='line'>                            <span class="s">&quot;numRows=%d, numColumns=%d, mSize=%d, mData=%p&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mHeader</span><span class="o">-&gt;</span><span class="n">freeOffset</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mHeader</span><span class="o">-&gt;</span><span class="n">numRows</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mHeader</span><span class="o">-&gt;</span><span class="n">numColumns</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mSize</span><span class="p">,</span> <span class="n">window</span><span class="o">-&gt;</span><span class="n">mData</span><span class="p">);</span>
</span><span class='line'>                    <span class="o">*</span><span class="n">outCursorWindow</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">delete</span> <span class="n">window</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="o">::</span><span class="n">munmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">ashmemFd</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">*</span><span class="n">outCursorWindow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>we can see that -12 is -errno, which means <strong>out of memory</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define ENOMEM      12  </span><span class="cm">/* Out of memory */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<p>It must returned from <strong>mmap</strong> operation. we can check this by <code>man mmap</code> :</p>

<blockquote><p>ENOMEM No memory is available, or the process&rsquo;s maximum number of mappings would have been exceeded.</p></blockquote>

<h3>Test code</h3>

<p>Because when this issue occur after 10 hours test(on customer side) and will got message restart , so hard to check phone&rsquo;s status when this happen.</p>

<p>I decided to write some test code to reproduce similar issue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">number</span> <span class="o">=</span><span class="mi">1000</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">Cursor</span> <span class="o">[]</span> <span class="n">cursors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cursor</span><span class="o">[</span><span class="n">number</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testCursor</span><span class="o">(){</span>
</span><span class='line'>    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">number</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span><span class='line'>        <span class="n">cursors</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;content://sms&quot;</span><span class="o">),</span><span class="n">SMS_PROJECTION</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;i = &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;  count:&quot;</span> <span class="o">+</span> <span class="n">cursors</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getCount</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will generate logcat info and cause app crash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">CursorWindow</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">allocate</span> <span class="n">CursorWindow</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">providers</span><span class="o">.</span><span class="na">telephony</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">mmssms</span><span class="o">.</span><span class="na">db</span><span class="err">&#39;</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">2097152</span> <span class="n">due</span> <span class="n">to</span> <span class="n">error</span> <span class="o">-</span>
</span><span class='line'><span class="mi">12</span><span class="o">.</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span> <span class="o">***</span> <span class="n">Uncaught</span> <span class="n">remote</span> <span class="n">exception</span><span class="o">!</span>  <span class="o">(</span><span class="n">Exceptions</span> <span class="n">are</span> <span class="n">not</span> <span class="n">yet</span> <span class="n">supported</span> <span class="n">across</span> <span class="n">processes</span><span class="o">.)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">CursorWindowAllocationException</span><span class="o">:</span> <span class="n">Cursor</span> <span class="n">window</span> <span class="n">allocation</span> <span class="n">of</span> <span class="mi">2048</span> <span class="n">kb</span> <span class="n">failed</span><span class="o">.</span> <span class="err">#</span> <span class="n">Open</span> <span class="n">Cursors</span><span class="o">=</span><span class="mi">732</span> <span class="o">(</span><span class="err">#</span> <span class="n">cursors</span> <span class="n">opene</span>
</span><span class='line'><span class="n">d</span> <span class="n">by</span> <span class="n">pid</span> <span class="mi">845</span><span class="o">=</span><span class="mi">732</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">CursorWindow</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">CursorWindow</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">107</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">AbstractWindowedCursor</span><span class="o">.</span><span class="na">clearOrCreateWindow</span><span class="o">(</span><span class="n">AbstractWindowedCursor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">198</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">sqlite</span><span class="o">.</span><span class="na">SQLiteCursor</span><span class="o">.</span><span class="na">fillWindow</span><span class="o">(</span><span class="n">SQLiteCursor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">139</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">sqlite</span><span class="o">.</span><span class="na">SQLiteCursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">(</span><span class="n">SQLiteCursor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">133</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">CursorToBulkCursorAdaptor</span><span class="o">.</span><span class="na">getBulkCursorDescriptor</span><span class="o">(</span><span class="n">CursorToBulkCursorAdaptor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">148</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">ContentProviderNative</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">ContentProviderNative</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">118</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Binder</span><span class="o">.</span><span class="na">execTransact</span><span class="o">(</span><span class="n">Binder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">404</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">dalvik</span><span class="o">.</span><span class="na">system</span><span class="o">.</span><span class="na">NativeStart</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span><span class='line'><span class="n">D</span><span class="o">/</span><span class="n">AndroidRuntime</span><span class="o">(</span>  <span class="mi">845</span><span class="o">):</span> <span class="n">Shutting</span> <span class="n">down</span> <span class="n">VM</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I use <code>procrank</code> (<code>top</code> or <code>ps</code> also OK)to check status, find Vss of phone(mmssms provider running in phone process) and testlink(my test app) are very high:
> 2000M</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="se">\#</span> procrank
</span><span class='line'>  PID       Vss      Rss      Pss      Uss  cmdline
</span><span class='line'>  919   643824K   61016K   33791K   30616K  system_server
</span><span class='line'> 1147  2082976K   52676K   26426K   23688K  com.android.phone
</span><span class='line'>...
</span><span class='line'>31155  2009512K   22032K    4000K    3384K  com.example.testlink
</span></code></pre></td></tr></table></div></figure>


<p>Then I use <code>cat /proc/1147/maps</code> to see the phone process&rsquo;s memory consumption for the its mappings.</p>

<p>I can see 744 records of <code>CursorWindow</code> as below (samilar in testlink process&rsquo;s maps):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>61fb5000-621b5000 rw-s 00000000 00:04 146971     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>621b5000-623b5000 rw-s 00000000 00:04 146972     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>623b5000-625b5000 rw-s 00000000 00:04 146973     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>625b5000-627b5000 rw-s 00000000 00:04 146974     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Maybe <code>procmem</code> is better for this, I find <code>procmem</code> later. Use <code>procmem</code> to check  the phone process&rsquo;s maps :</p>

<p>Also can see 744 records of <code>CursorWindow</code>, each one cost  2048K Vss.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Vss      Rss      Pss      Uss     ShCl     ShDi     PrCl     PrDi  Name
</span><span class='line'>
</span><span class='line'>-------  -------  -------  -------  -------  -------  -------  -------
</span><span class='line'>...
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>   132K      36K      16K      16K      20K       0K      16K       0K  <span class="o">[</span>stack<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>     0K       0K       0K       0K       0K       0K       0K       0K  <span class="o">[</span>vectors<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>-------  -------  -------  -------  -------  -------  -------  -------
</span><span class='line'>
</span><span class='line'>2079416K   39824K   20503K   19360K   20412K      52K   16592K    2976K  TOTAL
</span></code></pre></td></tr></table></div></figure>


<p>Theoretically, on 32 bit OS, Vss limit can be 4GB, but on 32 bit Android, Vss limit is 2GB. A process can not use Vss more than this limit. I do not know why.</p>

<p>Now, I can say, in case of my test app, every query try to use a new cursor which need allocate 2M
Vss . When alloacated Vss reach limit (2G) will return fail with errno 12 <code>ENOMEM</code>.</p>

<p>But for the first case , opened cursor number is only 4, most consume 8M memory, should not cause memory exhaust.</p>

<p>To find out what cost the memory, we need check maps of mms process from customer devices. Since we are not there with customer, we need a script to capture related logs.</p>

<h3>Capture logs &amp; fix first issue</h3>

<p>Then I wrote an bash script to capture related logs every half an hour.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/system/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> <span class="sb">`</span>ps| grep com.android.mms<span class="sb">`</span>
</span><span class='line'><span class="nv">pidOfMms</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;pid of mms is: $pidOfMms&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> <span class="sb">`</span>ps|grep com.android.phone<span class="sb">`</span>
</span><span class='line'><span class="nv">pidOfPhone</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;pid of phone is: $pidOfPhone&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;/sdcard/logs&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>mkdir <span class="s2">&quot;/sdcard/logs&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;create new dir /sdcard/logs&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="o">[</span> -d <span class="s2">&quot;/sdcard/logs&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;start capture logs&quot;</span>
</span><span class='line'>    <span class="nv">t</span><span class="o">=</span><span class="sb">`</span>date +<span class="s2">&quot;%Y-%m-%d-%H-%M-%S&quot;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="nv">$$</span> &gt; /sdcard/logs/pid.log
</span><span class='line'>    procrank &gt; <span class="s2">&quot;/sdcard/logs/procrank&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    dumpsys meminfo com.android.mms &gt; <span class="s2">&quot;/sdcard/logs/meminfo.mms&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    dumpsys meminfo com.android.phone &gt; <span class="s2">&quot;/sdcard/logs/meminfo.phone&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    cat /proc/<span class="nv">$pidOfPhone</span>/maps &gt; <span class="s2">&quot;/sdcard/logs/maps.phone&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    cat /proc/<span class="nv">$pidOfMms</span>/maps &gt; <span class="s2">&quot;/sdcard/logs/maps.mms&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    sleep 1800
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>push</code> this script to <strong>/system/bin/</strong> and add execute permission, run this <code>sh /system/bin/log.sh &amp;</code> before test , it will capture logs ever half an hour.</p>

<p>Then I got the maps of info of phone and mms process, after analysis , find 684 records of <code>/system/framework/framework-res.apk</code> as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>b75f7000-b772a000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b7791000-b78c4000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b78c4000-b79f7000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b79f7000-b7b2a000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b7b2a000-b7c5d000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>...
</span><span class='line'>bb165000-bb298000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>bb298000-bb3cb000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span></code></pre></td></tr></table></div></figure>


<p>I find lots of overlay errors in adb logs as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>11-06 10:55:47: D/asset   <span class="o">(</span> 1241<span class="o">)</span>: createIdmapFileLocked: <span class="nv">originalPath</span><span class="o">=</span>/system/framework/framework-res.apk <span class="nv">overlayPath</span><span class="o">=</span>/vendor/ty/overlay/framework/framework-res.apk <span class="nv">idmapPath</span><span class="o">=</span>/data/resource-cache/vendor@ty@overlay@framework@framework-res.apk@idmap
</span><span class='line'>11-06 10:55:47: W/asset   <span class="o">(</span> 1241<span class="o">)</span>: failed to find resources.arsc in /vendor/ty/overlay/framework/framework-res.apk
</span><span class='line'>11-06 10:55:47: W/asset   <span class="o">(</span> 1241<span class="o">)</span>: failed to add overlay package /vendor/ty/overlay/framework/framework-res.apk
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Then, I think maybe <a href="http://developer.sonymobile.com/2014/04/22/sony-contributes-runtime-resource-overlay-framework-to-android-code-example/">runtime overlay</a> failure caused <strong>/system/framework/framework-res.apk</strong>  loaded every time when app try to get framework resources. Lots of times load <strong>/system/framework/framework-res.apk</strong> without free previous cost memory caused memory leak.</p>

<p><a href="http://developer.sonymobile.com/2014/04/22/sony-contributes-runtime-resource-overlay-framework-to-android-code-example/">runtime overlay</a> failure is because <strong>failed to find resources.arsc in /vendor/ty/overlay/framework/framework-res.apk</strong>. After check <strong>/vendor/ty/overlay/framework/framework-res.apk</strong>, found no resources.arsc in this package because no resource in source code of this package.</p>

<p>Then removed <strong>/vendor/ty/overlay/framework/framework-res.apk</strong> and verify, after testing 10 hours , issue not observed.</p>

<h3>Same error , another issue</h3>

<p>After running 40 hours , similar error observed. Check maps of mms process (before the error), found 576 records of <code>stack</code> as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>711fa000-712f7000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1851<span class="o">]</span>
</span><span class='line'>712fe000-713fb000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1852<span class="o">]</span>
</span><span class='line'>71402000-714ff000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1853<span class="o">]</span>
</span><span class='line'>7436d000-7446a000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1854<span class="o">]</span>
</span><span class='line'>7446b000-74568000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1855<span class="o">]</span>
</span><span class='line'>74569000-74666000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1856<span class="o">]</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Also checked <code>top</code> info and <code>/proc/pid-of-mms/status</code> info , find Vss is high (1607952K) and lots of  threads (576) there:</p>

<ul>
<li>top info:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> PID PR CPU% S  <span class="c">#THR     VSS     RSS PCY UID      Name</span>
</span><span class='line'> 1847 0 1%   S   576 1607952K 210208K  <span class="nb">fg </span>u0_a9    com.android.mms
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>status info:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name:    com.android.mms
</span><span class='line'>State:    S <span class="o">(</span>sleeping<span class="o">)</span>
</span><span class='line'>Tgid: 1847
</span><span class='line'>Pid:  1847
</span><span class='line'>PPid: 203
</span><span class='line'>...
</span><span class='line'>Threads:  578
</span></code></pre></td></tr></table></div></figure>


<p>I think there are lots of unexpected thread created, so need capture threads info. Then wrote another script to capture threads info:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/system/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> <span class="sb">`</span>ps| grep com.android.mms<span class="sb">`</span>
</span><span class='line'><span class="nv">pidOfMms</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>
</span><span class='line'><span class="nv">tasks</span><span class="o">=</span><span class="sb">`</span>ls /proc/<span class="nv">$pidOfMms</span>/task<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;/sdcard/logs&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>mkdir <span class="s2">&quot;/sdcard/logs&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;create new dir /sdcard/logs&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>var in <span class="nv">$tasks</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span>debuggerd -b <span class="nv">$var</span> &gt; <span class="s2">&quot;/sdcard/logs/mms-tid-&quot;</span><span class="nv">$var</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>When got thread info, found lots of same name threads there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="s2">&quot;k worker thread&quot;</span> <span class="nv">sysTid</span><span class="o">=</span>10137
</span><span class='line'>  <span class="c">#00  pc 00021a58  /system/lib/libc.so (__futex_syscall3+8)</span>
</span><span class='line'>  <span class="c">#01  pc 0000f01c  /system/lib/libc.so (__pthread_cond_timedwait_relative+48)</span>
</span><span class='line'>  <span class="c">#02  pc 0000f07c  /system/lib/libc.so (__pthread_cond_timedwait+64)</span>
</span><span class='line'>  <span class="c">#03  pc 00055c67  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#04  pc 0006a5d5  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#05  pc 00029820  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#06  pc 00030cac  /system/lib/libdvm.so (dvmMterpStd(Thread*)+76)</span>
</span><span class='line'>  <span class="c">#07  pc 0002e344  /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+184)</span>
</span><span class='line'>  <span class="c">#08  pc 0006347d  /system/lib/libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, bool, JValue*, std::__va_list)+336)</span>
</span><span class='line'>  <span class="c">#09  pc 000634a1  /system/lib/libdvm.so (dvmCallMethod(Thread*, Method const*, Object*, JValue*, ...)+20)</span>
</span><span class='line'>  <span class="c">#10  pc 0005817f  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#11  pc 0000d228  /system/lib/libc.so (__thread_entry+72)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Searched &ldquo;k worker thread&rdquo; in Mms code , find :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./src/com/android/mms/data/Contact.java:552:                <span class="o">}</span>, <span class="s2">&quot;Contact.ContactsCache.TaskStack worker thread&quot;</span><span class="o">)</span>;
</span></code></pre></td></tr></table></div></figure>


<p>Actually &ldquo;k worker thread&rdquo; is truncated &ldquo;Contact.ContactsCache.TaskStack worker thread&rdquo;. Show its code as below:</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/data/Contact.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TaskStack</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span> <span class="n">mWorkerThread</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">mThingsToLoad</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">TaskStack</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mThingsToLoad</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;();</span>
</span><span class='line'>            <span class="n">mWorkerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                                    <span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span><span class='line'>                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                                    <span class="c1">// nothing to do</span>
</span><span class='line'>                                <span class="o">}</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                                <span class="n">r</span> <span class="o">=</span> <span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">},</span> <span class="s">&quot;Contact.ContactsCache.TaskStack worker thread&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mWorkerThread</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">MIN_PRIORITY</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mWorkerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see in constructor of TaskStack, a thread (mWorkerThread) will be created and this thread  never exit, if constructor of TaskStack called multiple times, will create one thread each time.</p>

<p>TaskStack created inside ContactsCache</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/data/Contact.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ContactsCache</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TaskStack</span> <span class="n">mTaskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TaskStack</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SEPARATOR</span> <span class="o">=</span> <span class="s">&quot;;&quot;</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ContactsCache created in <strong>init</strong> of Contact:</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/data/Contact.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sContactCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContactsCache</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">RecipientIdCache</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally found when delete all conversations , it will call <strong>Contact.init()</strong> to rebuild contacts cache. So every time delte all conversations, will leak memory for a new thread.</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/ui/ConversationList.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDeleteComplete</span><span class="o">(</span><span class="kt">int</span> <span class="n">token</span><span class="o">,</span> <span class="n">Object</span> <span class="n">cookie</span><span class="o">,</span> <span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onDeleteComplete</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">cookie</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'>        <span class="k">switch</span> <span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">DELETE_CONVERSATION_TOKEN:</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">threadId</span> <span class="o">=</span> <span class="n">cookie</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span><span class="n">cookie</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>     <span class="c1">// default to all threads</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">threadId</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">threadId</span> <span class="o">==</span> <span class="n">mLastDeletedThread</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mShowProgressDialogRunnable</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mProgressDialog</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mProgressDialog</span><span class="o">.</span><span class="na">isShowing</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mProgressDialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">mLastDeletedThread</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">threadId</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Rebuild the contacts cache now that all threads and their associated unique</span>
</span><span class='line'>                <span class="c1">// recipients have been deleted.</span>
</span><span class='line'>                <span class="n">Contact</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">ConversationList</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>To fix this issue, no need create a new thread every time or destory previous thread when you create one.</p>

<p>Google has provide a fix for this issue on Android L version:</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/ui/ConversationList.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">Author:</span> <span class="n">Emmanuel</span> <span class="n">Berthier</span> <span class="o">&lt;</span><span class="n">emmanuel</span><span class="o">.</span><span class="na">berthier</span><span class="nd">@intel.com</span><span class="o">&gt;</span>
</span><span class='line'><span class="nl">Date:</span>   <span class="n">Tue</span> <span class="n">Jul</span> <span class="mi">17</span> <span class="mi">16</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">10</span> <span class="mi">2012</span> <span class="o">+</span><span class="mi">0200</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Stop</span> <span class="n">previous</span> <span class="n">TaskStack</span> <span class="n">worker</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Each</span> <span class="n">time</span> <span class="n">we</span> <span class="n">delete</span> <span class="n">all</span> <span class="n">threads</span><span class="o">,</span> <span class="n">a</span> <span class="k">new</span> <span class="n">TaskStack</span> <span class="n">thread</span> <span class="n">is</span> <span class="n">started</span><span class="o">.</span>
</span><span class='line'>    <span class="n">We</span> <span class="n">need</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">one</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">over</span> <span class="n">memory</span> <span class="n">consumption</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Change</span><span class="o">-</span><span class="nl">Id:</span> <span class="n">Ibee8dd7b8e757df0686c7989dc7d9878f9ef5102</span>
</span><span class='line'>    <span class="n">Signed</span><span class="o">-</span><span class="n">off</span><span class="o">-</span><span class="nl">by:</span> <span class="n">Emmanuel</span> <span class="n">Berthier</span> <span class="o">&lt;</span><span class="n">emmanuel</span><span class="o">.</span><span class="na">berthier</span><span class="nd">@intel.com</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span> <span class="n">b</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span>
</span><span class='line'><span class="n">index</span> <span class="mi">5</span><span class="n">bc5bba</span><span class="o">..</span><span class="mi">87</span><span class="n">dcfe0</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">355</span><span class="o">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">355</span><span class="o">,</span><span class="mi">9</span> <span class="err">@@</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Contact</span> <span class="o">{</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">+</span>        <span class="k">if</span> <span class="o">(</span><span class="n">sContactCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Stop previous Runnable</span>
</span><span class='line'><span class="o">+</span>            <span class="n">sContactCache</span><span class="o">.</span><span class="na">mTaskQueue</span><span class="o">.</span><span class="na">mWorkerThread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span><span class='line'><span class="o">+</span>        <span class="o">}</span>
</span><span class='line'>         <span class="n">sContactCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContactsCache</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">RecipientIdCache</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">503</span><span class="o">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">506</span><span class="o">,</span><span class="mi">7</span> <span class="err">@@</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Contact</span> <span class="o">{</span>
</span><span class='line'>                                     <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                                         <span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span><span class='line'>                                     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">-</span>                                        <span class="c1">// nothing to do</span>
</span><span class='line'><span class="o">+</span>                                        <span class="k">break</span><span class="o">;</span>  <span class="c1">// Exception sent by Contact.init() to stop Runnable</span>
</span><span class='line'>                                     <span class="o">}</span>
</span><span class='line'>                                 <span class="o">}</span>
</span><span class='line'>                                 <span class="k">if</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this fix, when new TaskStack created , it will stop previous thread inside it.</p>

<h3>Summary</h3>

<p>For such <strong>&ldquo;Could not allocate &hellip; due to -12&rdquo;</strong> issue,  need to check process memory status and make clear what consumed the memory.</p>

<p>Use <code>top</code> , <code>meminfo</code>, <code>ps</code>, <code>procrank</code>,<code>procmem</code> to check summary of memory.
Use <code>cat /proc/self/maps</code>, <code>cat /proc/self/status</code> to konw details.</p>

<h3>Appendix</h3>

<ul>
<li><code>man proc</code> to see <code>/proc/[pid]/maps</code> info:</li>
</ul>


<blockquote><p> /proc/[pid]/maps</p>

<pre><code>          A file containing the currently mapped memory regions and
          their access permissions.  See mmap(2) for some further
          information about memory mappings.
</code></pre></blockquote>

<pre><code>          The format of the file is:

   address           perms offset  dev   inode       pathname
   00400000-00452000 r-xp 00000000 08:02 173521      /usr/bin/dbus-daemon
   00651000-00652000 r--p 00051000 08:02 173521      /usr/bin/dbus-daemon
   00652000-00655000 rw-p 00052000 08:02 173521      /usr/bin/dbus-daemon
   00e03000-00e24000 rw-p 00000000 00:00 0           [heap]
   00e24000-011f7000 rw-p 00000000 00:00 0           [heap]
   ...
   35b1800000-35b1820000 r-xp 00000000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a1f000-35b1a20000 r--p 0001f000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a20000-35b1a21000 rw-p 00020000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a21000-35b1a22000 rw-p 00000000 00:00 0
   35b1c00000-35b1dac000 r-xp 00000000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1dac000-35b1fac000 ---p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1fac000-35b1fb0000 r--p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1fb0000-35b1fb2000 rw-p 001b0000 08:02 135870  /usr/lib64/libc-2.15.so
   ...
   f2c6ff8c000-7f2c7078c000 rw-p 00000000 00:00 0    [stack:986]
   ...
   7fffb2c0d000-7fffb2c2e000 rw-p 00000000 00:00 0   [stack]
   7fffb2d48000-7fffb2d49000 r-xp 00000000 00:00 0   [vdso]

          The address field is the address space in the process that the
          mapping occupies.  The perms field is a set of permissions:

               r = read
               w = write
               x = execute
               s = shared
               p = private (copy on write)

          The offset field is the offset into the file/whatever; dev is
          the device (major:minor); inode is the inode on that device.
          0 indicates that no inode is associated with the memory
          region, as would be the case with BSS (uninitialized data).

          The pathname field will usually be the file that is backing
          the mapping.  For ELF files, you can easily coordinate with
          the offset field by looking at the Offset field in the ELF
          program headers (readelf -l).

          There are additional helpful pseudo-paths:

               [stack]
                      The initial process's (also known as the main
                      thread's) stack.

               [stack:&lt;tid&gt;] (since Linux 3.4)
                      A thread's stack (where the &lt;tid&gt; is a thread ID).
                      It corresponds to the /proc/[pid]/task/[tid]/
                      path.

               [vdso] The virtual dynamically linked shared object.

               [heap] The process's heap.

          If the pathname field is blank, this is an anonymous mapping
          as obtained via the mmap(2) function.  There is no easy way to
          coordinate this back to a process's source, short of running
          it through gdb(1), strace(1), or similar.

          Under Linux 2.0, there is no field giving pathname.
</code></pre>

<h3>Useful link</h3>

<ul>
<li><a href="https://developer.android.com/training/articles/memory.html">android dev memory article</a></li>
<li><a href="http://elinux.org/Android_Memory_Usage">Android_Memory_Usage</a></li>
<li><a href="http://man7.org/linux/man-pages/man5/proc.5.html">man proc</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/mmap.2.html">man mmap</a></li>
<li><a href="http://stackoverflow.com/questions/1401359/understanding-linux-proc-id-maps">understanding-linux-proc-id-maps</a></li>
<li><a href="http://elinux.org/Runtime_Memory_Measurement">Runtime_Memory_Measurement</a></li>
<li><a href="http://gauss.ececs.uc.edu/Courses/c4022/code/memory/understanding.pdf">Understanding the Linux Kernel, 3rd Edition</a></li>
<li><a href="https://www.kernel.org/doc/gorman/pdf/understand.pdf">Unserstanding the Linux Virtual Memory Manager</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[file access permissions summary ]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/05/23/file-access-permissions/"/>
    <updated>2014-05-23T23:08:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/05/23/file-access-permissions</id>
    <content type="html"><![CDATA[<p> file access permission bits. <code>man 2 stat</code>  file permission bits.</p>

<!-- more -->


<p></p>

<h3>S_ISUID</h3>

<p>set-user-ID</p>

<p>  <code>S_ISUID</code>  effective UID   UID </p>

<p> not used</p>

<h3>S_ISGID</h3>

<p>set-group-ID</p>

<p>  group execute  <code>S_ISGID</code> group  effective GID   GID </p>

<p>  GID  GID </p>

<h3>S_ISVTX</h3>

<p>striky bit</p>

<p>  cache</p>

<p>  owner ,  owner  super user   deleterename( other WX </p>

<h3>S_IRUSR</h3>

<p>user-read</p>

<p>user </p>

<p>user </p>

<h3>S_IWUSR</h3>

<p>user-write</p>

<p>user </p>

<p>user  rename/delete/create ( S_IXUSR )</p>

<h3>S_IXUSR</h3>

<p>user-execute</p>

<p>user </p>

<p>user  read/write/exexute/chmod</p>

<h3>S_IRGRP</h3>

<p>group-read</p>

<p>group </p>

<p>group </p>

<h3>S_IWGRP</h3>

<p>group-write</p>

<p>group </p>

<p>group  rename/delete/create ( S_IXUSR )</p>

<h3>S_IXGRP</h3>

<p>group-execute</p>

<p>group </p>

<p>group  &ndash; read/write/exexute/chmod</p>

<h3>S_IROTH</h3>

<p>other-read</p>

<p>other </p>

<p>other </p>

<h3>S_IWOTH</h3>

<p>other-write</p>

<p>other </p>

<p>other  rename/delete/create ( S_IXUSR )</p>

<h3>S_IXOTH</h3>

<p>other-execute</p>

<p>other </p>

<p>other  &ndash; read/write/exexute/chmod</p>

<h3>S_IRWXU</h3>

<p>= S_IRUSR | S_IWUSR | S_IXUSR</p>

<h3>S_IRWXG</h3>

<p>= S_IRGRP | S_IWGRP | S_IXGRP</p>

<h3>S_IRWXO</h3>

<p>= S_IROTH | S_IWOTH | S_IXOTH</p>

<hr />

<p> <code>man 2 stat</code></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>       S_ISUID    0004000   set UID bit
</span><span class='line'>       S_ISGID    0002000   set-group-ID bit (see below)
</span><span class='line'>       S_ISVTX    0001000   sticky bit (see below)
</span><span class='line'>       S_IRWXU    00700     mask for file owner permissions
</span><span class='line'>       S_IRUSR    00400     owner has read permission
</span><span class='line'>       S_IWUSR    00200     owner has write permission
</span><span class='line'>       S_IXUSR    00100     owner has execute permission
</span><span class='line'>       S_IRWXG    00070     mask for group permissions
</span><span class='line'>       S_IRGRP    00040     group has read permission
</span><span class='line'>       S_IWGRP    00020     group has write permission
</span><span class='line'>       S_IXGRP    00010     group has execute permission
</span><span class='line'>       S_IRWXO    00007     mask for permissions for others (not in group)
</span><span class='line'>       S_IROTH    00004     others have read permission
</span><span class='line'>       S_IWOTH    00002     others have write permission
</span><span class='line'>       S_IXOTH    00001     others have execute permission
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[hearthstone_cards]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/05/22/hearthstone-cards/"/>
    <updated>2014-05-22T23:08:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/05/22/hearthstone-cards</id>
    <content type="html"><![CDATA[<p>Hearthstone cards for android
<img src="http://SteveVallay.github.io/images/blog/hearthstone_card0.png" alt="" /></p>

<!--more-->


<p><img src="http://SteveVallay.github.io/images/blog/hearthstone_card1.png" alt="" /></p>

<p><img src="http://SteveVallay.github.io/images/blog/hearthstone_card2.png" alt="" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[android sms]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/05/22/sms/"/>
    <updated>2014-05-22T17:32:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/05/22/sms</id>
    <content type="html"><![CDATA[<p>Android  SMS Process</p>

<!-- more -->


<p><img src="http://SteveVallay.github.io/images/blog/android_sms.png" alt="graph" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[permissions on folder]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/05/12/permissions-on-folder/"/>
    <updated>2014-05-12T21:46:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/05/12/permissions-on-folder</id>
    <content type="html"><![CDATA[<p>Never foget your dream, never ~</p>

<!--more-->


<p>RWX permission   X  X </p>

<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>mkdir fz
</span><span class='line'><span class="nv">$ </span>ls -ld fz
</span><span class='line'>drwxrwxr-x 2 goodluck goodluck 4096 2014-05-12 21:57 fz
</span></code></pre></td></tr></table></div></figure>


<p>775</p>

<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>fz/
</span><span class='line'><span class="nv">$ </span>touch a b c
</span><span class='line'><span class="nv">$ </span>ls -al fz
</span><span class='line'>drwxrwxr-x 2 goodluck goodluck 4096 2014-05-12 21:59 .
</span><span class='line'>drwxr-xr-x 8 goodluck goodluck 4096 2014-05-12 21:59 ..
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck    0 2014-05-12 21:59 a
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck    0 2014-05-12 21:59 b
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck    0 2014-05-12 21:59 c
</span></code></pre></td></tr></table></div></figure>


<p>fz RWX </p>

<p>-R</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod 444 fz <span class="c"># folder  permission  root </span>
</span><span class='line'><span class="nv">$ </span>ls -ld fz
</span><span class='line'>dr--r--r-- 2 goodluck goodluck 4096 2014-05-12 21:59 fz
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ls -al fz
</span><span class='line'>ls: cannot access fz/.: Permission denied
</span><span class='line'>ls: cannot access fz/..: Permission denied
</span><span class='line'>ls: cannot access fz/a: Permission denied
</span><span class='line'>ls: cannot access fz/c: Permission denied
</span><span class='line'>ls: cannot access fz/b: Permission denied
</span><span class='line'>total 0
</span><span class='line'>d????????? ? ? ? ?                ? .
</span><span class='line'>d????????? ? ? ? ?                ? ..
</span><span class='line'>-????????? ? ? ? ?                ? a
</span><span class='line'>-????????? ? ? ? ?                ? b
</span><span class='line'>-????????? ? ? ? ?                ? c
</span><span class='line'><span class="nv">$ </span>cat fz/a
</span><span class='line'>cat: fz/a: Permission denied
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>fz
</span><span class='line'>bash: <span class="nb">cd</span>: fz: Permission denied
</span></code></pre></td></tr></table></div></figure>


<p> R  fz  . ..  a b c </p>

<p>-W</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod 222 fz
</span><span class='line'><span class="nv">$ </span>ls -ld fz
</span><span class='line'>d-w--w--w- 2 goodluck goodluck 4096 2014-05-12 21:59 fz
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ls fz
</span><span class='line'>ls: cannot open directory fz: Permission denied
</span><span class='line'><span class="nv">$ </span>cat fz/a
</span><span class='line'>cat: fz/a: Permission denied
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;aaa&quot;</span> &gt;fz/a
</span><span class='line'>bash: fz/a: Permission denied
</span><span class='line'>mv fz/a fz/d
</span><span class='line'>mv: accessing <span class="sb">`</span>fz/d<span class="err">&#39;</span>: Permission denied
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>fz
</span><span class='line'>bash: <span class="nb">cd</span>: fz: Permission denied
</span></code></pre></td></tr></table></div></figure>


<p> W ,</p>

<p>-X</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod 111 fz
</span><span class='line'><span class="nv">$ </span>ls -ld fz
</span><span class='line'>d--x--x--x 2 goodluck goodluck 4096 2014-05-12 21:59 fz
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>ls -al fz
</span><span class='line'>ls: cannot open directory fz: Permission denied
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;aaa&quot;</span> &gt; fz/a  <span class="c">#success</span>
</span><span class='line'><span class="nv">$ </span>cat fz/a
</span><span class='line'>aaa
</span><span class='line'>chmod +x fz/a <span class="c">#success</span>
</span><span class='line'><span class="nv">$ </span>ls -l fz/a
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck 4 2014-05-12 22:16 fz/a
</span><span class='line'><span class="nv">$ </span>rm fz/a
</span><span class='line'>rm: cannot remove <span class="sb">`</span>fz/a<span class="s1">&#39;: Permission denied</span>
</span><span class='line'><span class="s1">$ cd fz</span>
</span><span class='line'><span class="s1">$ cd fz</span>
</span><span class='line'><span class="s1">$ ls</span>
</span><span class='line'><span class="s1">ls: cannot open directory .: Permission denied</span>
</span><span class='line'><span class="s1">$ touch ff</span>
</span><span class='line'><span class="s1">touch: cannot touch `ff&#39;</span>: Permission denied
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>chmod 775 fz/a <span class="c">#fail but not prompt error</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$?</span>
</span><span class='line'>0 <span class="c">#seems success but not changed</span>
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck 11 2014-05-12 22:26 fz/a
</span></code></pre></td></tr></table></div></figure>


<p>X,rename/delete/create ,chmod </p>

<p>-RX</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod 555 fz
</span><span class='line'><span class="nv">$ </span>ls -ld fz
</span><span class='line'>dr-xr-xr-x 2 goodluck goodluck 4096 2014-05-12 22:19 fz
</span><span class='line'><span class="nv">$ </span>ls -al fz
</span><span class='line'>total 12
</span><span class='line'>dr-xr-xr-x 2 goodluck goodluck 4096 2014-05-12 22:19 .
</span><span class='line'>drwxr-xr-x 8 goodluck goodluck 4096 2014-05-12 21:59 ..
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck   11 2014-05-12 22:26 a
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck    0 2014-05-12 21:59 b
</span><span class='line'>-rw-rw-r-- 1 goodluck goodluck    0 2014-05-12 21:59 c
</span></code></pre></td></tr></table></div></figure>


<p>cd  rename/delete/create </p>

<p> cd  fz  chmod  a permisson,  fz !</p>

<p>-RW</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod 666 fz
</span><span class='line'><span class="nv">$ </span>ls -al fz
</span><span class='line'>ls: cannot access fz/.: Permission denied
</span><span class='line'>ls: cannot access fz/..: Permission denied
</span><span class='line'>ls: cannot access fz/a: Permission denied
</span><span class='line'>ls: cannot access fz/c: Permission denied
</span><span class='line'>ls: cannot access fz/b: Permission denied
</span><span class='line'>total 0
</span><span class='line'>d????????? ? ? ? ?                ? .
</span><span class='line'>d????????? ? ? ? ?                ? ..
</span><span class='line'>-????????? ? ? ? ?                ? a
</span><span class='line'>-????????? ? ? ? ?                ? b
</span><span class='line'>-????????? ? ? ? ?                ? c
</span><span class='line'>
</span><span class='line'><span class="nv">$ </span>rm fz/a
</span><span class='line'>rm: cannot remove <span class="sb">`</span>fz/a<span class="s1">&#39;: Permission denied</span>
</span><span class='line'><span class="s1">$ touch fz/d</span>
</span><span class='line'><span class="s1">touch: cannot touch `fz/d&#39;</span>: Permission denied
</span></code></pre></td></tr></table></div></figure>


<p> R  delete/rename/create </p>

<p> X  W </p>

<p>-WX</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>sudo chmod 333 fz
</span><span class='line'><span class="nv">$ </span>ls -ld fz
</span><span class='line'>d-wx-wx-wx 2 goodluck goodluck 4096 2014-05-12 22:19 fz
</span><span class='line'><span class="nv">$ </span>cat fz/a
</span><span class='line'><span class="nb">echo </span>aaa
</span><span class='line'><span class="nv">$ </span>ls -al fz/a
</span><span class='line'>-rwxrwxrwx 1 goodluck goodluck 9 2014-05-12 22:38 fz/a
</span><span class='line'><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;bbb&quot;</span>&gt; fz/b
</span><span class='line'><span class="nv">$ </span>cat fz/b
</span><span class='line'>bbb
</span><span class='line'><span class="nv">$ </span>rm fz/b <span class="c">#success</span>
</span><span class='line'><span class="nv">$ </span>touch fz/e  <span class="c">#success</span>
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>fz <span class="c">#success</span>
</span></code></pre></td></tr></table></div></figure>


<p>delete/rename/create </p>

<p>linux </p>

<ol>
<li>R </li>
<li>W create/rename/delete ( X )</li>
<li>X access/search </li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[unlink]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/04/28/unlink/"/>
    <updated>2014-04-28T22:23:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/04/28/unlink</id>
    <content type="html"><![CDATA[<p>Do the things you love more than yourself.</p>

<!--more-->


<p> APUE </p>

<p>Linux Cpwd  getcwd ls  lstat rm  remove link  link </p>

<p> unlink ,  C  unlink.</p>

<p>man unlink 
unlink &ndash; call the unlink function to remove the specified file</p>

<p>man 2 unlink  </p>

<p>unlink &ndash; delete a name and possibly the file it refers to</p>

<pre><code>   #include &lt;unistd.h&gt;

   int unlink(const char *pathname);
</code></pre>

<blockquote><p>unlink() deletes a name from the file system.  If that name was the last link to a file and no processes have the file open the file is deleted and the space it was using is made available for reuse.</p>

<p>If the name was the last link to a file but any processes still have the file open the file will remain in existence  until the last file descriptor referring to it is closed.</p>

<p>If the name referred to a symbolic link the link is removed.</p>

<p>If  the  name  referred to a socket, fifo or device the name for it is removed but processes which have the object open may continue to use it.</p></blockquote>

<p>unlink linux </p>

<p></p>

<p> unlink </p>

<p> symbolic link unlink  link,  link </p>

<p> socket, fifo, device, name </p>

<p>unlink  unlink</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android ]]></title>
    <link href="http://SteveVallay.github.io/blog/2014/01/09/android-start-process/"/>
    <updated>2014-01-09T14:23:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2014/01/09/android-start-process</id>
    <content type="html"><![CDATA[<p></p>

<!--more-->


<p> Android </p>

<p>Andorid </p>

<ol>
<li></li>
<li></li>
<li></li>
<li>/</li>
<li></li>
</ol>


<p>( Telephony,Multimedia ). Android .</p>

<h2>Power    User Space</h2>

<p> Power  bootloader ( bootable/),bootloader bootloader  kernel, kernel kernel  init </p>

<p>:&ndash;)</p>

<h2>Init </h2>

<p>init  init </p>

<p>init : <strong>system/core/init/init.c</strong></p>

<p> init.c kitkat) <code>main</code> , init &hellip;)</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="cm">/* umask*/</span>
</span><span class='line'>    <span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**/</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/dev&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/proc&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/sys&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;tmpfs&quot;</span><span class="p">,</span> <span class="s">&quot;/dev&quot;</span><span class="p">,</span> <span class="s">&quot;tmpfs&quot;</span><span class="p">,</span> <span class="n">MS_NOSUID</span><span class="p">,</span> <span class="s">&quot;mode=0755&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/dev/pts&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/dev/socket&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;devpts&quot;</span><span class="p">,</span> <span class="s">&quot;/dev/pts&quot;</span><span class="p">,</span> <span class="s">&quot;devpts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;/proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;sysfs&quot;</span><span class="p">,</span> <span class="s">&quot;/sys&quot;</span><span class="p">,</span> <span class="s">&quot;sysfs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* */</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/.booting&quot;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0000</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* /dev/null  0,1,2  /dev/null*/</span>
</span><span class='line'>    <span class="n">open_devnull_stdio</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">klog_init</span><span class="p">();</span>
</span><span class='line'>    <span class="cm">/* property [android properties][101]*/</span>
</span><span class='line'>    <span class="n">property_init</span><span class="p">();</span>
</span><span class='line'>    <span class="n">get_hardware_name</span><span class="p">(</span><span class="n">hardware</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revision</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">process_kernel_cmdline</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*selinux */</span>
</span><span class='line'>    <span class="k">union</span> <span class="n">selinux_callback</span> <span class="n">cb</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cb</span><span class="p">.</span><span class="n">func_log</span> <span class="o">=</span> <span class="n">klog_write</span><span class="p">;</span>
</span><span class='line'>    <span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_LOG</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cb</span><span class="p">.</span><span class="n">func_audit</span> <span class="o">=</span> <span class="n">audit_callback</span><span class="p">;</span>
</span><span class='line'>    <span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_AUDIT</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">selinux_initialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">restorecon</span><span class="p">(</span><span class="s">&quot;/dev&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">restorecon</span><span class="p">(</span><span class="s">&quot;/dev/socket&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">restorecon</span><span class="p">(</span><span class="s">&quot;/dev/__properties__&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">restorecon_recursive</span><span class="p">(</span><span class="s">&quot;/sys&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*load properties*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_charger</span><span class="p">)</span>
</span><span class='line'>        <span class="n">property_load_boot_defaults</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*init : init.rc */</span>
</span><span class='line'>    <span class="n">INFO</span><span class="p">(</span><span class="s">&quot;reading config file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">init_parse_config_file</span><span class="p">(</span><span class="s">&quot;/init.rc&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*action_for_each_trigger  queue_builtin_action  action/command  command */</span>
</span><span class='line'>    <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">wait_for_coldboot_done_action</span><span class="p">,</span> <span class="s">&quot;wait_for_coldboot_done&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">mix_hwrng_into_linux_rng_action</span><span class="p">,</span> <span class="s">&quot;mix_hwrng_into_linux_rng&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">keychord_init_action</span><span class="p">,</span> <span class="s">&quot;keychord_init&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">console_init_action</span><span class="p">,</span> <span class="s">&quot;console_init&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* execute all the boot actions to get us started */</span>
</span><span class='line'>    <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_charger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;post-fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;post-fs-data&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">mix_hwrng_into_linux_rng_action</span><span class="p">,</span> <span class="s">&quot;mix_hwrng_into_linux_rng&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">property_service_init_action</span><span class="p">,</span> <span class="s">&quot;property_service_init&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">signal_init_action</span><span class="p">,</span> <span class="s">&quot;signal_init&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">check_startup_action</span><span class="p">,</span> <span class="s">&quot;check_startup&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">is_charger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;charger&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-boot&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;boot&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* run all property triggers based on current state of the properties */</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">queue_property_triggers_action</span><span class="p">,</span> <span class="s">&quot;queue_property_triggers&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#if BOOTCHART</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">bootchart_init_action</span><span class="p">,</span> <span class="s">&quot;bootchart_init&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* init.rc  action/command*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/**/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*init */</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*command !*/</span>
</span><span class='line'>        <span class="n">execute_one_command</span><span class="p">();</span>
</span><span class='line'>        <span class="n">restart_processes</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*property fd (socket  ufds */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property_set_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_property_set_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_property_set_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">property_set_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* signal fd  ufds*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_signal_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_signal_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">signal_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/* keychord ?fd  ufds*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keychord_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_keychord_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_keychord_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">keychord_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*restart */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">process_needs_restart</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">process_needs_restart</span> <span class="o">-</span> <span class="n">gettime</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action_queue_empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">cur_action</span><span class="p">)</span>
</span><span class='line'>            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if BOOTCHART</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">bootchart_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">BOOTCHART_POLLING_MS</span><span class="p">)</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="n">BOOTCHART_POLLING_MS</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">bootchart_step</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">--</span><span class="n">bootchart_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">bootchart_finish</span><span class="p">();</span>
</span><span class='line'>                <span class="n">bootchart_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*poll ufds  timeout */</span>
</span><span class='line'>        <span class="n">nr</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">ufds</span><span class="p">,</span> <span class="n">fd_count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>       <span class="cm">/* ufds !(property set , signal,keychord?)*/</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">==</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_property_set_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_property_set_fd</span><span class="p">();</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_keychord_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_keychord</span><span class="p">();</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_signal_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_signal</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>init :</p>

<ol>
<li> init.rc  action/commands.</li>
<li> Daemon  property_set,keychord(key combo  signal </li>
</ol>


<p>init.rc  system/core/init/init_parser.c</p>

<p> init.rc </p>

<figure class='code'><figcaption><span>system/core/rootdir/init.rc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># rc </span>
</span><span class='line'>import /init.environ.rc
</span><span class='line'>import /init.usb.rc
</span><span class='line'>import /init.<span class="k">${</span><span class="nv">ro</span><span class="p">.hardware</span><span class="k">}</span>.rc  <span class="c"># rc ,</span>
</span><span class='line'>import /init.trace.rc
</span><span class='line'>
</span><span class='line'><span class="c">#early-init </span>
</span><span class='line'>on early-init
</span><span class='line'>    <span class="c"># Set init and its forked children&#39;s oom_adj.</span>
</span><span class='line'>    write /proc/1/oom_adj -16
</span><span class='line'>
</span><span class='line'>    <span class="c"># Set the security context for the init process.</span>
</span><span class='line'>    <span class="c"># This should occur before anything else (e.g. ueventd) is started.</span>
</span><span class='line'>    setcon u:r:init:s0
</span><span class='line'>
</span><span class='line'>    start ueventd
</span><span class='line'>
</span><span class='line'><span class="c"># create mountpoints</span>
</span><span class='line'>    mkdir /mnt 0775 root system
</span><span class='line'>
</span><span class='line'><span class="c">#init </span>
</span><span class='line'>on init
</span><span class='line'>
</span><span class='line'>sysclktz 0
</span><span class='line'>
</span><span class='line'>loglevel 3
</span><span class='line'>
</span><span class='line'><span class="c"># Backward compatibility</span>
</span><span class='line'>    symlink /system/etc /etc
</span><span class='line'>    symlink /sys/kernel/debug /d
</span><span class='line'>
</span><span class='line'><span class="c"># Right now vendor lives on the same filesystem as system,</span>
</span><span class='line'><span class="c"># but someday that may change.</span>
</span><span class='line'>    symlink /system/vendor /vendor
</span><span class='line'>
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>
</span><span class='line'>on post-fs
</span><span class='line'>    <span class="c"># once everything is setup, no need to modify /</span>
</span><span class='line'>    mount rootfs rootfs / ro remount
</span><span class='line'>    <span class="c"># mount shared so changes propagate into child namespaces</span>
</span><span class='line'>    mount rootfs rootfs / shared rec
</span><span class='line'>    mount tmpfs tmpfs /mnt/secure private rec
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>
</span><span class='line'>on post-fs-data
</span><span class='line'>    <span class="c"># We chown/chmod /data again so because mount is run as root + defaults</span>
</span><span class='line'>    chown system system /data
</span><span class='line'>    chmod 0771 /data
</span><span class='line'>    <span class="c"># We restorecon /data in case the userdata partition has been reset.</span>
</span><span class='line'>    restorecon /data
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>
</span><span class='line'>on boot
</span><span class='line'><span class="c"># basic network init</span>
</span><span class='line'>    ifup lo
</span><span class='line'>    hostname localhost
</span><span class='line'>    domainname localdomain
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>    class_start core
</span><span class='line'>    class_start main
</span><span class='line'>
</span><span class='line'>on nonencrypted
</span><span class='line'>    class_start late_start
</span><span class='line'>
</span><span class='line'>on charger
</span><span class='line'>    class_start charger
</span><span class='line'>
</span><span class='line'>on property:vold.decrypt<span class="o">=</span>trigger_reset_main
</span><span class='line'>    class_reset main
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>
</span><span class='line'>service console /system/bin/sh
</span><span class='line'>    class core
</span><span class='line'>    console
</span><span class='line'>    disabled
</span><span class='line'>    user shell
</span><span class='line'>    group log
</span><span class='line'>
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>
</span><span class='line'>service servicemanager /system/bin/servicemanager
</span><span class='line'>    class core
</span><span class='line'>    user system
</span><span class='line'>    group system
</span><span class='line'>    critical
</span><span class='line'>    onrestart restart healthd
</span><span class='line'>    onrestart restart zygote
</span><span class='line'>    onrestart restart media
</span><span class='line'>    onrestart restart surfaceflinger
</span><span class='line'>    onrestart restart drm
</span><span class='line'><span class="c">#...</span>
</span><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>    class main
</span><span class='line'>    socket zygote stream 660 root system
</span><span class='line'>    onrestart write /sys/android_power/request_state wake
</span><span class='line'>    onrestart write /sys/power/state on
</span><span class='line'>    onrestart restart media
</span><span class='line'>    onrestart restart netd
</span></code></pre></td></tr></table></div></figure>


<p> ini.rc </p>

<ul>
<li> trigger </li>
</ul>


<figure class='code'><figcaption><span>system/core/rootdir/init.rc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>on trigger
</span><span class='line'>   ...
</span></code></pre></td></tr></table></div></figure>


<ul>
<li> service</li>
</ul>


<figure class='code'><figcaption><span>system/core/rootdir/init.rc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>service ...
</span><span class='line'>   ...
</span></code></pre></td></tr></table></div></figure>


<p><code>on xxxx</code>  init.rc </p>

<ul>
<li>on early-init</li>
<li>on init</li>
<li>on post-fs</li>
<li>on boot</li>
<li>on nonencrypted</li>
<li>on charger</li>
<li>on property:key=value</li>
</ul>


<p> trigger   trigger  init.c  action queue </p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'><span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p> init.c  action queue  init.c  action queue  action,</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">execute_one_command</span><span class="p">();</span>  <span class="c1">// action </span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>on property</code>  set property  action action queue , </p>

<p> service service  trigger  action queue. service  option  service  class.</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">service</span> <span class="n">ueventd</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ueventd</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">core</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">servicemanager</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">servicemanager</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">core</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">healthd</span><span class="o">-</span><span class="n">charger</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">healthd</span> <span class="o">-</span><span class="n">n</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">charger</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">netd</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">netd</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">main</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">zygote</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">app_process</span> <span class="o">-</span><span class="n">Xzygote</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span> <span class="o">--</span><span class="n">zygote</span> <span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">server</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">main</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p> class  service  service  trigger </p>

<p> <code>on boot</code>:</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">on</span> <span class="n">boot</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">class_start</span> <span class="n">core</span>
</span><span class='line'>    <span class="n">class_start</span> <span class="n">main</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>core</code>  <code>main</code>  service  <code>on boot</code> .</p>

<p> init.rc </p>

<ul>
<li>on xxx  init.c  xxx  action </li>
<li>service xxx  <code>class xxx</code>  core  main  service  on boot </li>
</ul>


<p>OK,  service  init </p>

<p>Android  Native  Java  init.rc  service  &mdash; zygote</p>

<p>zygote  init.rc  service </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>    class main
</span><span class='line'>    socket zygote stream 660 root system
</span><span class='line'>    onrestart write /sys/android_power/request_state wake
</span><span class='line'>    onrestart write /sys/power/state on
</span><span class='line'>    onrestart restart media
</span><span class='line'>    onrestart restart netd
</span></code></pre></td></tr></table></div></figure>


<p>name = <code>zygote</code>
path = <code>/system/bin/app_process</code>
arguments = <code>-Xzygote /system/bin --zygote --start-system-server</code></p>

<p>zygote  service  /system/bin/app_process  , :</p>

<p><code>frameworks/base/cmds/app_process/app_main.cpp</code></p>

<figure class='code'><figcaption><span>frameworks/base/cmds/app_process/app_main.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">//-Xzygote  Vm</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">runtime</span><span class="p">.</span><span class="n">addVmArguments</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parentDir</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">parentDir</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--zygote&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zygote</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>            <span class="n">niceName</span> <span class="o">=</span> <span class="s">&quot;zygote&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--start-system-server&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">startSystemServer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--application&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">application</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--nice-name=&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">niceName</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">className</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">// call runtime.start  </span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">zygote</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">runtime</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;com.android.internal.os.ZygoteInit&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">startSystemServer</span> <span class="o">?</span> <span class="s">&quot;start-system-server&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>runtime</code>  start  <code>com.android.internal.os.ZygoteInit</code>  <code>start-system-server</code> </p>

<p><code>runtime</code>  <code>AppRuntime</code>  <code>start</code>  <code>AndroidRuntime</code> </p>

<figure class='code'><figcaption><span>frameworks/core/jni/AndroidRuntime.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Start the Android runtime.  This involves starting the virtual machine</span>
</span><span class='line'><span class="cm"> * and calling the &quot;static void main(String[] args)&quot; method in the class</span>
</span><span class='line'><span class="cm"> * named by &quot;className&quot;.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Passes the main function two arguments, the class name and the specified</span>
</span><span class='line'><span class="cm"> * options string.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">void</span> <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">className</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="n">startVm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mJavaVM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">onVmCreated</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">strArray</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObjectArray</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">stringClass</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">strArray</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">classNameStr</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">classNameStr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">SetObjectArrayElement</span><span class="p">(</span><span class="n">strArray</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">classNameStr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">optionsStr</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
</span><span class='line'>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">SetObjectArrayElement</span><span class="p">(</span><span class="n">strArray</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">optionsStr</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Start VM.  This thread becomes the main thread of the VM, and will</span>
</span><span class='line'><span class="cm">     * not return until the VM exits.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kt">char</span><span class="o">*</span> <span class="n">slashClassName</span> <span class="o">=</span> <span class="n">toSlashClassName</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
</span><span class='line'>    <span class="n">jclass</span> <span class="n">startClass</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">slashClassName</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">startClass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;JavaVM unable to locate class &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slashClassName</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* keep going */</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">jmethodID</span> <span class="n">startMeth</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">startClass</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;([Ljava/lang/String;)V&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">startMeth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;JavaVM unable to find main() in &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">className</span><span class="p">);</span>
</span><span class='line'>            <span class="cm">/* keep going */</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">startClass</span><span class="p">,</span> <span class="n">startMeth</span><span class="p">,</span> <span class="n">strArray</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>start</code>  <code>com.android.internal.os.ZygoteInit</code> , <code>start-system-server</code>, <code>start</code>  <code>className</code>  <code>options</code> <code>start</code>   VM ,  VM  env  <code>com.android.internal.os.ZygoteInit</code>   <code>main</code>  !</p>

<p>  java   <code>ZygoteInit</code> ?</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>            <span class="n">registerZygoteSocket</span><span class="o">();</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;start-system-server&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">startSystemServer</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">argv</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="n">USAGE_STRING</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>            <span class="n">runSelectLoop</span><span class="o">();</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ZygoteInit</code>  <code>main</code>  :</p>

<ol>
<li> zygote socket</li>
<li> system server</li>
<li> zygote socket </li>
</ol>


<p> init  zygote  socket &ndash; <code>/dev/socket/zygote</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>    class main
</span><span class='line'>    socket zygote stream 660 root system
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p><code>registerZygoteSocket</code>  socket  fd  Server socket ,  client </p>

<p><code>startSystemServer()</code>  system server </p>

<figure class='code'><figcaption><span>ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Prepare the arguments and fork for the system server process.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">startSystemServer</span><span class="o">()</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">MethodAndArgsCaller</span><span class="o">,</span> <span class="n">RuntimeException</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>    <span class="cm">/* Hardcoded command line to start the system server */</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="s">&quot;--setuid=1000&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--setgid=1000&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--capabilities=&quot;</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--runtime-init&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--nice-name=system_server&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;com.android.server.SystemServer&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>        <span class="cm">/* Request to fork the system server process */</span>
</span><span class='line'>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">(</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span>
</span><span class='line'>                <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">permittedCapabilities</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>    <span class="cm">/* For child process */</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>Zygote.forkSystemServer</code> , <code>forkSystemServer</code>  <code>nativenativeForkSystemServer</code></p>

<figure class='code'><figcaption><span>libcore/dalvik/src/main/java/dalvik/system/Zygote.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">preFork</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkSystemServer</span><span class="o">(</span>
</span><span class='line'>            <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'>    <span class="n">postFork</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>nativenativeForkSystemServer</code>  dalvik </p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">Dalvik_dalvik_system_Zygote_forkSystemServer</span><span class="p">(</span>
</span><span class='line'>        <span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* The zygote process checks whether the child process has died or not. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;System server process %d has been created&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gDvm</span><span class="p">.</span><span class="n">systemServerPid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* system server zygote !*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;System server process %d has died. Restarting Zygote!&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">SIGKILL</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">RETURN_INT</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>forkAndSpecializeCommon</code>:</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">pid_t</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isSystemServer</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">setSignalHandler</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">unsetSignalHandler</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> fork  signal  <code>setSignalHandler</code>, signal  zygote </p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">sigchldHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * If the just-crashed process is the system_server, bring down zygote</span>
</span><span class='line'><span class="cm">         * so that it is restarted by init and system server will be restarted</span>
</span><span class='line'><span class="cm">         * from there.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">gDvm</span><span class="p">.</span><span class="n">systemServerPid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOG</span><span class="p">(</span><span class="n">LOG_INFO</span><span class="p">,</span> <span class="n">ZYGOTE_LOG_TAG</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;Exit zygote because system server (%d) has terminated&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">SIGKILL</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> system server  zygote !!</p>

<p>OK ,  <code>startSystemServer</code>,  system server  zygote , system server  <code>handleSystemServerProcess</code>, zygote  <code>runSelectLoop()</code>,  zygote <code>runSelectLoop</code>:</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/** </span>
</span><span class='line'><span class="cm"> * Runs the zygote process&#39;s select loop. Accepts new connections as</span>
</span><span class='line'><span class="cm"> * they happen, and reads commands from connections one spawn-request&#39;s</span>
</span><span class='line'><span class="cm"> * worth at a time.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @throws MethodAndArgsCaller in a child process when a main() should</span>
</span><span class='line'><span class="cm"> * be executed.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">runSelectLoop</span><span class="p">()</span> <span class="k">throws</span> <span class="n">MethodAndArgsCaller</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">....</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="p">();</span>
</span><span class='line'>            <span class="n">peers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newPeer</span><span class="p">);</span>
</span><span class='line'>            <span class="n">fds</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newPeer</span><span class="p">.</span><span class="n">getFileDesciptor</span><span class="p">());</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">boolean</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>            <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">runOnce</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>acceptCommandPeer()</code>  client </p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Waits for and accepts a single command connection. Throws</span>
</span><span class='line'><span class="cm"> * RuntimeException on failure.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">ZygoteConnection</span> <span class="n">acceptCommandPeer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ZygoteConnection</span><span class="p">(</span><span class="n">sServerSocket</span><span class="p">.</span><span class="n">accept</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span>
</span><span class='line'>                <span class="s">&quot;IOException during accept()&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runOnce()</code>  client  client  fork </p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">boolean</span> <span class="n">runOnce</span><span class="p">()</span> <span class="k">throws</span> <span class="n">ZygoteInit</span><span class="p">.</span><span class="n">MethodAndArgsCaller</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">args</span> <span class="o">=</span> <span class="n">readArgumentList</span><span class="p">();</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="p">.</span><span class="n">forkAndSpecialize</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">gids</span><span class="p">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="p">.</span><span class="n">debugFlags</span><span class="p">,</span> <span class="n">rlimits</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">mountExternal</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">seInfo</span><span class="p">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="p">.</span><span class="n">niceName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> system server <code>handleSystemServerProcess</code>:</p>

<figure class='code'><figcaption><span>ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="cm">/** </span>
</span><span class='line'><span class="cm"> * Finish remaining work for the newly forked system server process.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'> <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span> <span class="n">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">parsedArgs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>RuntimeInit.zygoteInit</code>:</p>

<figure class='code'><figcaption><span>RuntimeInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;RuntimeInit: Starting application from zygote&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// log</span>
</span><span class='line'>    <span class="n">redirectLogStreams</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// timezone ,useragent </span>
</span><span class='line'>    <span class="n">commonInit</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//app_main.cpp  onZygoteInit,  Binder thread pool.</span>
</span><span class='line'>    <span class="n">nativeZygoteInit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//</span>
</span><span class='line'>    <span class="n">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>applicationInit</code>, <code>startClass</code>  &ldquo;com.android.server.SystemServer&rdquo; ,  <code>SystemServer</code>  main </p>

<figure class='code'><figcaption><span>RuntimeInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="c1">// Remaining arguments are passed to the start class&#39;s static main</span>
</span><span class='line'>    <span class="n">invokeStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> SystemServer  :</p>

<figure class='code'><figcaption><span>SystemServer.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&quot;android_servers&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// Initialize native services.</span>
</span><span class='line'>    <span class="n">nativeInit</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">// This used to be its own separate thread, but now it is</span>
</span><span class='line'>    <span class="c1">// just the loop we run on the main thread.</span>
</span><span class='line'>    <span class="n">ServerThread</span> <span class="n">thr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerThread</span><span class="o">();</span>
</span><span class='line'>    <span class="n">thr</span><span class="o">.</span><span class="na">initAndLoop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<ol>
<li>nativeInit</li>
<li>ServerThread </li>
</ol>


<p>nativeInit </p>

<figure class='code'><figcaption><span>services/jni/com_android_server_SystemServer.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">android_server_SystemServer_nativeInit</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">propBuf</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="n">property_get</span><span class="p">(</span><span class="s">&quot;system_init.startsensorservice&quot;</span><span class="p">,</span> <span class="n">propBuf</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">propBuf</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Start the sensor service</span>
</span><span class='line'>        <span class="n">SensorService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ServerThread  </p>

<figure class='code'><figcaption><span>SystemServer.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">initAndLoop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// window manager  handler.</span>
</span><span class='line'>    <span class="n">HandlerThread</span> <span class="n">wmHandlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HandlerThread</span><span class="o">(</span><span class="s">&quot;WindowManager&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">wmHandlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Handler</span> <span class="n">wmHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">wmHandlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
</span><span class='line'>    <span class="n">wmHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_DISPLAY</span><span class="o">);</span>
</span><span class='line'>            <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setCanSelfBackground</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//  installd , Power Manager Activity Manager service.</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">onlyCore</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">firstBoot</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">installer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Installer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">installer</span><span class="o">.</span><span class="na">ping</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">power</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PowerManagerService</span><span class="o">();</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">POWER_SERVICE</span><span class="o">,</span> <span class="n">power</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">context</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">factoryTest</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableStorage</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_storage&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableMedia</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_media&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableBluetooth</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_bluetooth&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableTelephony</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_telephony&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableLocation</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_location&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableSystemUI</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_systemui&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableNonCoreServices</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_noncore&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableNetwork</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_network&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// service add </span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">display</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wmHandler</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DISPLAY_SERVICE</span><span class="o">,</span> <span class="n">display</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">telephonyRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TelephonyRegistry</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;telephony.registry&quot;</span><span class="o">,</span> <span class="n">telephonyRegistry</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">telephony</span><span class="o">.</span><span class="na">MSimTelephonyManager</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">isMultiSimEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">msimTelephonyRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MSimTelephonyRegistry</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;telephony.msim.registry&quot;</span><span class="o">,</span> <span class="n">msimTelephonyRegistry</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;scheduling_policy&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SchedulingPolicyService</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">cryptState</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;vold.decrypt&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">ENCRYPTING_STATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cryptState</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">onlyCore</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ENCRYPTED_STATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cryptState</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">onlyCore</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pm</span> <span class="o">=</span> <span class="n">PackageManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">installer</span><span class="o">,</span>
</span><span class='line'>                <span class="n">factoryTest</span> <span class="o">!=</span> <span class="n">SystemServer</span><span class="o">.</span><span class="na">FACTORY_TEST_OFF</span><span class="o">,</span>
</span><span class='line'>                <span class="n">onlyCore</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">setSystemProcess</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;entropy&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">EntropyMixer</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">USER_SERVICE</span><span class="o">,</span>
</span><span class='line'>                <span class="n">UserManagerService</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mContentResolver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">accountManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ACCOUNT_SERVICE</span><span class="o">,</span> <span class="n">accountManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">contentService</span> <span class="o">=</span> <span class="n">ContentService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span>
</span><span class='line'>                <span class="n">factoryTest</span> <span class="o">==</span> <span class="n">SystemServer</span><span class="o">.</span><span class="na">FACTORY_TEST_LOW_LEVEL</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">installSystemProviders</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">lights</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LightsService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">battery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatteryService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">lights</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;battery&quot;</span><span class="o">,</span> <span class="n">battery</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">vibrator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VibratorService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;vibrator&quot;</span><span class="o">,</span> <span class="n">vibrator</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">consumerIr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerIrService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CONSUMER_IR_SERVICE</span><span class="o">,</span> <span class="n">consumerIr</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">power</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">lights</span><span class="o">,</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">(),</span> <span class="n">battery</span><span class="o">,</span>
</span><span class='line'>                <span class="n">BatteryStatsService</span><span class="o">.</span><span class="na">getService</span><span class="o">(),</span>
</span><span class='line'>                <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">getAppOpsService</span><span class="o">(),</span> <span class="n">display</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">alarm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlarmManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ALARM_SERVICE</span><span class="o">,</span> <span class="n">alarm</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">battery</span><span class="o">,</span> <span class="n">power</span><span class="o">,</span> <span class="n">alarm</span><span class="o">,</span>
</span><span class='line'>                <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addThread</span><span class="o">(</span><span class="n">wmHandler</span><span class="o">,</span> <span class="s">&quot;WindowManager thread&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">inputManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wmHandler</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">wm</span> <span class="o">=</span> <span class="n">WindowManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">power</span><span class="o">,</span> <span class="n">display</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">,</span>
</span><span class='line'>                <span class="n">wmHandler</span><span class="o">,</span> <span class="n">factoryTest</span> <span class="o">!=</span> <span class="n">SystemServer</span><span class="o">.</span><span class="na">FACTORY_TEST_LOW_LEVEL</span><span class="o">,</span>
</span><span class='line'>                <span class="o">!</span><span class="n">firstBoot</span><span class="o">,</span> <span class="n">onlyCore</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INPUT_SERVICE</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">inputManager</span><span class="o">.</span><span class="na">setWindowManagerCallbacks</span><span class="o">(</span><span class="n">wm</span><span class="o">.</span><span class="na">getInputMonitor</span><span class="o">());</span>
</span><span class='line'>        <span class="n">inputManager</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">display</span><span class="o">.</span><span class="na">setWindowManager</span><span class="o">(</span><span class="n">wm</span><span class="o">);</span>
</span><span class='line'>        <span class="n">display</span><span class="o">.</span><span class="na">setInputManager</span><span class="o">(</span><span class="n">inputManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                <span class="n">imm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputMethodManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INPUT_METHOD_SERVICE</span><span class="o">,</span> <span class="n">imm</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ACCESSIBILITY_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">AccessibilityManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">wm</span><span class="o">.</span><span class="na">displayReady</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pm</span><span class="o">.</span><span class="na">performBootDexOpt</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">mountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MountService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;mount&quot;</span><span class="o">,</span> <span class="n">mountService</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">lockSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockSettingsService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;lock_settings&quot;</span><span class="o">,</span> <span class="n">lockSettings</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">devicePolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DevicePolicyManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DEVICE_POLICY_SERVICE</span><span class="o">,</span> <span class="n">devicePolicy</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableSystemUI</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">statusBar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StatusBarManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">STATUS_BAR_SERVICE</span><span class="o">,</span> <span class="n">statusBar</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CLIPBOARD_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">ClipboardService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">networkManagement</span> <span class="o">=</span> <span class="n">NetworkManagementService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORKMANAGEMENT_SERVICE</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">tsms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TextServicesManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">TEXT_SERVICES_MANAGER_SERVICE</span><span class="o">,</span> <span class="n">tsms</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">networkStats</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkStatsService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">,</span> <span class="n">alarm</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORK_STATS_SERVICE</span><span class="o">,</span> <span class="n">networkStats</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">networkPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkPolicyManagerService</span><span class="o">(</span>
</span><span class='line'>                        <span class="n">context</span><span class="o">,</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">(),</span> <span class="n">power</span><span class="o">,</span>
</span><span class='line'>                        <span class="n">networkStats</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORK_POLICY_SERVICE</span><span class="o">,</span> <span class="n">networkPolicy</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">wifiP2p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WifiP2pService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WIFI_P2P_SERVICE</span><span class="o">,</span> <span class="n">wifiP2p</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">wifi</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WifiService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WIFI_SERVICE</span><span class="o">,</span> <span class="n">wifi</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">serviceDiscovery</span> <span class="o">=</span> <span class="n">NsdService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span>
</span><span class='line'>                        <span class="n">Context</span><span class="o">.</span><span class="na">NSD_SERVICE</span><span class="o">,</span> <span class="n">serviceDiscovery</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">UPDATE_LOCK_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">UpdateLockService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*   </span>
</span><span class='line'><span class="cm">         * MountService has a few dependencies: Notification Manager and</span>
</span><span class='line'><span class="cm">         * AppWidget Provider. Make sure MountService is completely started</span>
</span><span class='line'><span class="cm">         * first before continuing.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mountService</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">onlyCore</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mountService</span><span class="o">.</span><span class="na">waitForAsecScan</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">accountManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                <span class="n">accountManager</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">contentService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                <span class="n">contentService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">statusBar</span><span class="o">,</span> <span class="n">lights</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NOTIFICATION_SERVICE</span><span class="o">,</span> <span class="n">notification</span><span class="o">);</span>
</span><span class='line'>            <span class="n">networkPolicy</span><span class="o">.</span><span class="na">bindNotificationManager</span><span class="o">(</span><span class="n">notification</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">DeviceStorageMonitorService</span><span class="o">.</span><span class="na">SERVICE</span><span class="o">,</span>
</span><span class='line'>                    <span class="k">new</span> <span class="nf">DeviceStorageMonitorService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableLocation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LOCATION_SERVICE</span><span class="o">,</span> <span class="n">location</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">countryDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountryDetectorService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">COUNTRY_DETECTOR</span><span class="o">,</span> <span class="n">countryDetector</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Search Service&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">SEARCH_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">SearchManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DROPBOX_SERVICE</span><span class="o">,</span>
</span><span class='line'>                    <span class="k">new</span> <span class="nf">DropBoxManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/data/system/dropbox&quot;</span><span class="o">)));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getBoolean</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">R</span><span class="o">.</span><span class="na">bool</span><span class="o">.</span><span class="na">config_enableWallpaperService</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(!</span><span class="n">headless</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">wallpaper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WallpaperManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WALLPAPER_SERVICE</span><span class="o">,</span> <span class="n">wallpaper</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableMedia</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">&quot;0&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;system_init.startaudioservice&quot;</span><span class="o">)))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">AUDIO_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">AudioService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Listen for dock station changes</span>
</span><span class='line'>                <span class="n">dock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DockObserver</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableMedia</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Listen for wired headset changes</span>
</span><span class='line'>                <span class="n">inputManager</span><span class="o">.</span><span class="na">setWiredAccessoryCallbacks</span><span class="o">(</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">WiredAccessoryManager</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">reportWtf</span><span class="o">(</span><span class="s">&quot;starting WiredAccessoryManager&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Manage USB host and device support</span>
</span><span class='line'>                <span class="n">usb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsbService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">USB_SERVICE</span><span class="o">,</span> <span class="n">usb</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Serial port support</span>
</span><span class='line'>                <span class="n">serial</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SerialService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">SERIAL_SERVICE</span><span class="o">,</span> <span class="n">serial</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">twilight</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwilightService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Listen for UI mode changes</span>
</span><span class='line'>            <span class="n">uiMode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UiModeManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">twilight</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">BACKUP_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">BackupManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">appWidget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AppWidgetService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">APPWIDGET_SERVICE</span><span class="o">,</span> <span class="n">appWidget</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">recognition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecognitionManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;diskstats&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">DiskStatsService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;samplingprofiler&quot;</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">SamplingProfilerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">networkTimeUpdater</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkTimeUpdateService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableMedia</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">commonTimeMgmtService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommonTimeManagementService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;commontime_management&quot;</span><span class="o">,</span> <span class="n">commonTimeMgmtService</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">CertBlacklister</span> <span class="n">blacklister</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CertBlacklister</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">bool</span><span class="o">.</span><span class="na">config_dreamsSupported</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Dreams (interactive idle-time views, a/k/a screen savers)</span>
</span><span class='line'>                <span class="n">dreamy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DreamManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wmHandler</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">DreamService</span><span class="o">.</span><span class="na">DREAM_SERVICE</span><span class="o">,</span> <span class="n">dreamy</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">atlas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AssetAtlasService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">AssetAtlasService</span><span class="o">.</span><span class="na">ASSET_ATLAS_SERVICE</span><span class="o">,</span> <span class="n">atlas</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">IdleMaintenanceService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">battery</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">printManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">PRINT_SERVICE</span><span class="o">,</span> <span class="n">printManager</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mediaRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MediaRouterService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">MEDIA_ROUTER_SERVICE</span><span class="o">,</span> <span class="n">mediaRouter</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="c1">//safe mode </span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">safeMode</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="na">detectSafeMode</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">safeMode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">enterSafeMode</span><span class="o">();</span>
</span><span class='line'>        <span class="c1">// Post the safe mode state in the Zygote class</span>
</span><span class='line'>        <span class="n">Zygote</span><span class="o">.</span><span class="na">systemInSafeMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="c1">// Disable the JIT for the system_server process</span>
</span><span class='line'>        <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">disableJitCompilation</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Enable the JIT for the system_server process</span>
</span><span class='line'>        <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">startJitCompilation</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//service system ready</span>
</span><span class='line'>    <span class="n">vibrator</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">lockSettings</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">devicePolicy</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">notification</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">wm</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">safeMode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">showSafeModeOverlay</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">power</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">twilight</span><span class="o">,</span> <span class="n">dreamy</span><span class="o">);</span>
</span><span class='line'>    <span class="n">pm</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">display</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">safeMode</span><span class="o">,</span> <span class="n">onlyCore</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// ActivityManagerService  systemReady</span>
</span><span class='line'>    <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">systemReady</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">startObservingNativeCrashes</span><span class="o">();</span>
</span><span class='line'>                <span class="n">startSystemUi</span><span class="o">(</span><span class="n">contextF</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mountServiceF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mountServiceF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">batteryF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">batteryF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkManagementF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkManagementF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkStatsF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkStatsF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkPolicyF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkPolicyF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">connectivityF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">connectivityF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">dockF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">dockF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">usbF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">usbF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">twilightF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">twilightF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">uiModeF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">uiModeF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">recognitionF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">recognitionF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>            <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// It is now okay to let the various system services start their</span>
</span><span class='line'>            <span class="c1">// third party code...</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">appWidgetF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">appWidgetF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">(</span><span class="n">safeMode</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">wallpaperF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">wallpaperF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">immF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">immF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">(</span><span class="n">statusBarF</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">locationF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">locationF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">countryDetectorF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">countryDetectorF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkTimeUpdaterF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkTimeUpdaterF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">commonTimeMgmtServiceF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">commonTimeMgmtServiceF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">textServiceManagerServiceF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">dreamyF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">dreamyF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">atlasF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">atlasF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">inputManagerF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">inputManagerF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">telephonyRegistryF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">telephonyRegistryF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">msimTelephonyRegistryF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">msimTelephonyRegistryF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">printManagerF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">printManagerF</span><span class="o">.</span><span class="na">systemRuning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mediaRouterF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mediaRouterF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>system server  Launcher system server  ActivityManagerService  systemReady() </p>

<p>ActivityManagerService  systemReady()</p>

<figure class='code'><figcaption><span>ActivityManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">systemReady</span><span class="o">(</span><span class="kd">final</span> <span class="n">Runnable</span> <span class="n">goingCallback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>        <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">resumeTopActivitiesLocked</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>mStackSupervisor.resumeTopActivitiesLocked</p>

<figure class='code'><figcaption><span>ActivityStackSupervisor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">resumeTopActivitiesLocked</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">resumeTopActivitiesLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">boolean</span> <span class="nf">resumeTopActivitiesLocked</span><span class="o">(</span><span class="n">ActivityStack</span> <span class="n">targetStack</span><span class="o">,</span> <span class="n">ActivityRecord</span> <span class="n">target</span><span class="o">,</span>
</span><span class='line'>        <span class="n">Bundle</span> <span class="n">targetOptions</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">targetStack</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">targetStack</span> <span class="o">=</span> <span class="n">getFocusedStack</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">stackNdx</span> <span class="o">=</span> <span class="n">mStacks</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">stackNdx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">--</span><span class="n">stackNdx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">ActivityStack</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">mStacks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackNdx</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">isFrontStack</span><span class="o">(</span><span class="n">stack</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">stack</span> <span class="o">==</span> <span class="n">targetStack</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">result</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="na">resumeTopActivityLocked</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">targetOptions</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">stack</span><span class="o">.</span><span class="na">resumeTopActivityLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>stack.resumeTopActivityLocked</p>

<figure class='code'><figcaption><span>ActivityStack.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">DEBUG_LOCKSCREEN</span><span class="o">)</span> <span class="n">mService</span><span class="o">.</span><span class="na">logLockScreen</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// There are no more activities!  Let&#39;s just start up the</span>
</span><span class='line'>        <span class="c1">// Launcher...</span>
</span><span class='line'>        <span class="n">ActivityOptions</span><span class="o">.</span><span class="na">abort</span><span class="o">(</span><span class="n">options</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_STATES</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;resumeTopActivityLocked: No more activities go home&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_STACK</span><span class="o">)</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">validateTopActivitiesLocked</span><span class="o">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">resumeHomeActivity</span><span class="o">(</span><span class="n">prev</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>mStackSupervisor.resumeHomeActivity</p>

<figure class='code'><figcaption><span>ActivityStackSupervisor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">resumeHomeActivity</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">mService</span><span class="o">.</span><span class="na">startHomeActivityLocked</span><span class="o">(</span><span class="n">mCurrentUser</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>mService.startHomeActivityLocked(mCurrentUser)</p>

<figure class='code'><figcaption><span>ActivityManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">startHomeActivityLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getHomeIntent</span><span class="o">();</span>
</span><span class='line'>    <span class="n">ActivityInfo</span> <span class="n">aInfo</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">resolveActivityInfo</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">STOCK_PM_FLAGS</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">aInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">intent</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="k">new</span> <span class="n">ComponentName</span><span class="o">(</span>
</span><span class='line'>                <span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">aInfo</span><span class="o">.</span><span class="na">name</span><span class="o">));</span>
</span><span class='line'>        <span class="c1">// Don&#39;t do this if the home app is currently being</span>
</span><span class='line'>        <span class="c1">// instrumented.</span>
</span><span class='line'>        <span class="n">aInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityInfo</span><span class="o">(</span><span class="n">aInfo</span><span class="o">);</span>
</span><span class='line'>        <span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span> <span class="o">=</span> <span class="n">getAppInfoForUser</span><span class="o">(</span><span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ProcessRecord</span> <span class="n">app</span> <span class="o">=</span> <span class="n">getProcessRecordLocked</span><span class="o">(</span><span class="n">aInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
</span><span class='line'>                <span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">app</span><span class="o">.</span><span class="na">instrumentationClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">intent</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">|</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">startHomeActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">aInfo</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;> mStackSupervisor.startHomeActivity</p>

<figure class='code'><figcaption><span>ActivityStackSupervisor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">startHomeActivity</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">ActivityInfo</span> <span class="n">aInfo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">moveHomeToTop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">startActivityLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">aInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>            <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="n">startActivityLocked</span>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="n">startActivityUncheckedLocked</span>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="n">resumeTopActivitiesLocked</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>ActivityStack.resumeTopActivityLocked</p>

<p>&ndash;>
ActivityStackSupervisor.startSpecificActivityLocked</p>

<p>&ndash;>
ActivityManagerService.startProcessLocked</p>

<p>&ndash;></p>

<figure class='code'><figcaption><span>ActivityManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>        <span class="c1">// Start the process.  It will either succeed and return a result containing</span>
</span><span class='line'>        <span class="c1">// the PID of the new process, or else throw a RuntimeException.</span>
</span><span class='line'>        <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="n">startResult</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">&quot;android.app.ActivityThread&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span>
</span><span class='line'>                <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">seinfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>
Process.start  processClass  &ldquo;android.app.ActivityThread&rdquo;</p>

<p>&ndash;>
startViaZygote</p>

<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ProcessStartResult</span> <span class="nf">start</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span><span class="o">[]</span> <span class="n">zygoteArgs</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="n">processClass</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                <span class="n">debugFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">zygoteArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ZygoteStartFailedEx</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span>
</span><span class='line'>                <span class="s">&quot;Starting VM process through Zygote failed&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
</span><span class='line'>                <span class="s">&quot;Starting VM process through Zygote failed&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;></p>

<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">ProcessStartResult</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span><span class="o">[]</span> <span class="n">extraArgs</span><span class="o">)</span>
</span><span class='line'>                              <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>         <span class="k">return</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">argsForZygote</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">ProcessStartResult</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">openZygoteSocketIfNeeded</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>        <span class="n">sZygoteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>            <span class="n">sZygoteWriter</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>        <span class="n">sZygoteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>openZygoteSocketIfNeeded?</p>

<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ZYGOTE_SOCKET</span> <span class="o">=</span> <span class="s">&quot;zygote&quot;</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">openZygoteSocketIfNeeded</span><span class="o">()</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">sZygoteSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalSocket</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">sZygoteSocket</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="n">LocalSocketAddress</span><span class="o">(</span><span class="n">ZYGOTE_SOCKET</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">LocalSocketAddress</span><span class="o">.</span><span class="na">Namespace</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>yes &ndash;> connect to &ldquo;zygote&rdquo; and send args, back to zygote:</p>

<figure class='code'><figcaption><span>ZygoteInit.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runSelectLoop</span><span class="o">(){</span>
</span><span class='line'>                <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">runOnce</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>runOnce?</p>

<figure class='code'><figcaption><span>ZygoteConnection.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">(){</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">seInfo</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span> <span class="n">newStderr</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>
Zygote.forkAndSpecialize</p>

<figure class='code'><figcaption><span>Zygote.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkAndSpecialize</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">preFork</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkAndSpecialize</span><span class="o">(</span>
</span><span class='line'>            <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">niceName</span><span class="o">);</span>
</span><span class='line'>    <span class="n">postFork</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;> nativeForkAndSpecialize</p>

<figure class='code'><figcaption><span>dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">Dalvik_dalvik_system_Zygote_forkAndSpecialize</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span>
</span><span class='line'>    <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">RETURN_INT</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">pid_t</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isSystemServer</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>fork  ZygoteConnection  runOnce.</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// in child</span>
</span><span class='line'>                <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
</span><span class='line'>                <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                <span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span> <span class="n">newStderr</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// should never get here, the child is expected to either</span>
</span><span class='line'>                <span class="c1">// throw ZygoteInit.MethodAndArgsCaller or exec().</span>
</span><span class='line'>                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// in parent...pid of &lt; 0 means failure</span>
</span><span class='line'>                <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
</span><span class='line'>                <span class="n">childPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">handleParentProc</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">serverPipeFd</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
</span><span class='line'>            <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> &ndash;> handleChildProc</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleChildProc</span><span class="o">(</span><span class="n">Arguments</span> <span class="n">parsedArgs</span><span class="o">,</span>
</span><span class='line'>        <span class="n">FileDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">FileDescriptor</span> <span class="n">pipeFd</span><span class="o">,</span> <span class="n">PrintStream</span> <span class="n">newStderr</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>                <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">invokeStaticMain</span><span class="o">(</span><span class="n">cloader</span><span class="o">,</span> <span class="n">className</span><span class="o">,</span> <span class="n">mainArgs</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> className  main , className  &ldquo;android.app.ActivityThread&rdquo;</p>

<p>&ndash;></p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeStaticMain</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span>
</span><span class='line'>            <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>         <span class="n">cl</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span><span class='line'>         <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * This throw gets caught in ZygoteInit.main(), which responds</span>
</span><span class='line'><span class="cm">         * by invoking the exception&#39;s run() method. This arrangement</span>
</span><span class='line'><span class="cm">         * clears up all the stack frames that were required in setting</span>
</span><span class='line'><span class="cm">         * up the process.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> ZygoteInit.main()  ;&ndash;)</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MethodAndArgsCaller</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> &ldquo;android.app.ActivityThread&rdquo;  main .</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[alarm]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/12/27/alarm/"/>
    <updated>2013-12-27T14:40:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/12/27/alarm</id>
    <content type="html"><![CDATA[<p></p>

<!-- more -->


<p> NB ! </p>

<p></p>

<p>Linux  Android </p>

<ul>
<li>/</li>
<li></li>
<li></li>
<li></li>
</ul>


<p></p>

<p>:</p>

<ul>
<li>RTC</li>
<li>ELAPSED_REALTIME</li>
</ul>


<p><code>RTC</code> ,UTCjava api <code>System.currentTimeMillis()</code> </p>

<p><code>ELAPSED_REALTIME</code>  java api <code>SystemClock.elapsedRealtime()</code>  </p>

<p> &ldquo;&rdquo;  &ldquo;&rdquo; :</p>

<ul>
<li>RTC_WAKEUP</li>
<li>ELAPSED_REALTIME_WAKEUP</li>
</ul>


<p><code>RTC_WAKEUP</code>  UTC <code>RTC</code> </p>

<p><code>ELAPSED_REALTIME_WAKEUP</code> <code>ELAPSED_REALTIME</code> </p>

<p> app layer :</p>

<figure class='code'><figcaption><span>packages/apps/DeskClock/src/com/android/deskclock/alarms/AlarmStateManager.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="n">AlarmManager</span> <span class="n">am</span> <span class="o">=</span> <span class="o">(</span><span class="n">AlarmManager</span><span class="o">)</span> <span class="n">context</span><span class="o">.</span><span class="na">getSystemService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ALARM_SERVICE</span><span class="o">);</span>
</span><span class='line'> <span class="n">am</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">AlarmManager</span><span class="o">.</span><span class="na">RTC_WAKEUP</span><span class="o">,</span> <span class="n">timeInMillis</span><span class="o">,</span> <span class="n">pendingIntent</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p> AlarmManager  RTC   <code>timeInMillis</code>  <code>pendingIntent</code> </p>

<p> AlarmManager  AlarmManagerService  IPC AlarmManagerService </p>

<figure class='code'><figcaption><span>framework/base/core/java/android/app/AlarmManager.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setExact</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">triggerAtMillis</span><span class="o">,</span> <span class="n">PendingIntent</span> <span class="n">operation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>     <span class="n">setImpl</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">triggerAtMillis</span><span class="o">,</span> <span class="n">WINDOW_EXACT</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">operation</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setImpl</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">triggerAtMillis</span><span class="o">,</span> <span class="kt">long</span> <span class="n">windowMillis</span><span class="o">,</span> <span class="kt">long</span> <span class="n">intervalMillis</span><span class="o">,</span>
</span><span class='line'>         <span class="n">PendingIntent</span> <span class="n">operation</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">workSource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>         <span class="n">mService</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">triggerAtMillis</span><span class="o">,</span> <span class="n">windowMillis</span><span class="o">,</span> <span class="n">intervalMillis</span><span class="o">,</span> <span class="n">operation</span><span class="o">,</span>
</span><span class='line'>                 <span class="n">workSource</span><span class="o">);</span>
</span><span class='line'>     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RemoteException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> AlarmManagerService :</p>

<figure class='code'><figcaption><span>framework/base/core/java/android/app/AlarmManager.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="nd">@Override</span>
</span><span class='line'>    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">triggerAtTime</span><span class="o">,</span> <span class="kt">long</span> <span class="n">windowLength</span><span class="o">,</span> <span class="kt">long</span> <span class="n">interval</span><span class="o">,</span>
</span><span class='line'>            <span class="n">PendingIntent</span> <span class="n">operation</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">workSource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">workSource</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingPermission</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">android</span><span class="o">.</span><span class="na">Manifest</span><span class="o">.</span><span class="na">permission</span><span class="o">.</span><span class="na">UPDATE_DEVICE_STATS</span><span class="o">,</span>
</span><span class='line'>                    <span class="s">&quot;AlarmManager.set&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">set</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">triggerAtTime</span><span class="o">,</span> <span class="n">windowLength</span><span class="o">,</span> <span class="n">interval</span><span class="o">,</span> <span class="n">operation</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="n">workSource</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">triggerAtTime</span><span class="o">,</span> <span class="kt">long</span> <span class="n">windowLength</span><span class="o">,</span> <span class="kt">long</span> <span class="n">interval</span><span class="o">,</span>
</span><span class='line'>            <span class="n">PendingIntent</span> <span class="n">operation</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isStandalone</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">workSource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'> <span class="n">setImplLocked</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">triggerAtTime</span><span class="o">,</span> <span class="n">triggerElapsed</span><span class="o">,</span> <span class="n">windowLength</span><span class="o">,</span> <span class="n">maxElapsed</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">interval</span><span class="o">,</span> <span class="n">operation</span><span class="o">,</span> <span class="n">isStandalone</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">workSource</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setImplLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">when</span><span class="o">,</span> <span class="kt">long</span> <span class="n">whenElapsed</span><span class="o">,</span> <span class="kt">long</span> <span class="n">windowLength</span><span class="o">,</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">maxWhen</span><span class="o">,</span> <span class="kt">long</span> <span class="n">interval</span><span class="o">,</span> <span class="n">PendingIntent</span> <span class="n">operation</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isStandalone</span><span class="o">,</span>
</span><span class='line'>            <span class="kt">boolean</span> <span class="n">doValidate</span><span class="o">,</span> <span class="n">WorkSource</span> <span class="n">workSource</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">rescheduleKernelAlarmsLocked</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="kd">private</span> <span class="kt">void</span> <span class="nf">rescheduleKernelAlarmsLocked</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Schedule the next upcoming wakeup alarm.  If there is a deliverable batch</span>
</span><span class='line'>        <span class="c1">// prior to that which contains no wakeups, we schedule that as well.</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mAlarmBatches</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">Batch</span> <span class="n">firstWakeup</span> <span class="o">=</span> <span class="n">findFirstWakeupBatchLocked</span><span class="o">();</span>
</span><span class='line'>            <span class="kd">final</span> <span class="n">Batch</span> <span class="n">firstBatch</span> <span class="o">=</span> <span class="n">mAlarmBatches</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">firstWakeup</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mNextWakeup</span> <span class="o">!=</span> <span class="n">firstWakeup</span><span class="o">.</span><span class="na">start</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mNextWakeup</span> <span class="o">=</span> <span class="n">firstWakeup</span><span class="o">.</span><span class="na">start</span><span class="o">;</span>
</span><span class='line'>                <span class="n">setLocked</span><span class="o">(</span><span class="n">ELAPSED_REALTIME_WAKEUP</span><span class="o">,</span> <span class="n">firstWakeup</span><span class="o">.</span><span class="na">start</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">firstBatch</span> <span class="o">!=</span> <span class="n">firstWakeup</span> <span class="o">&amp;&amp;</span> <span class="n">mNextNonWakeup</span> <span class="o">!=</span> <span class="n">firstBatch</span><span class="o">.</span><span class="na">start</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mNextNonWakeup</span> <span class="o">=</span> <span class="n">firstBatch</span><span class="o">.</span><span class="na">start</span><span class="o">;</span>
</span><span class='line'>                <span class="n">setLocked</span><span class="o">(</span><span class="n">ELAPSED_REALTIME</span><span class="o">,</span> <span class="n">firstBatch</span><span class="o">.</span><span class="na">start</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">private</span> <span class="kt">void</span> <span class="nf">setLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">when</span><span class="o">)</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>          <span class="k">if</span> <span class="o">(</span><span class="n">mDescriptor</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="c1">// The kernel never triggers alarms with negative wakeup times</span>
</span><span class='line'>            <span class="c1">// so we ensure they are positive.</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">alarmSeconds</span><span class="o">,</span> <span class="n">alarmNanoseconds</span><span class="o">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">when</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">alarmSeconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>                <span class="n">alarmNanoseconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">alarmSeconds</span> <span class="o">=</span> <span class="n">when</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>
</span><span class='line'>                <span class="n">alarmNanoseconds</span> <span class="o">=</span> <span class="o">(</span><span class="n">when</span> <span class="o">%</span> <span class="mi">1000</span><span class="o">)</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">set</span><span class="o">(</span><span class="n">mDescriptor</span><span class="o">,</span> <span class="n">type</span><span class="o">,</span> <span class="n">alarmSeconds</span><span class="o">,</span> <span class="n">alarmNanoseconds</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="kt">int</span> <span class="n">fd</span><span class="o">,</span> <span class="kt">int</span> <span class="n">type</span><span class="o">,</span> <span class="kt">long</span> <span class="n">seconds</span><span class="o">,</span> <span class="kt">long</span> <span class="n">nanoseconds</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>native :</p>

<figure class='code'><figcaption><span>frameworks/base/services/jni/com_android_server_AlarmManagerService.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">android_server_AlarmManagerService_set</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">,</span> <span class="n">jint</span> <span class="n">fd</span><span class="p">,</span> <span class="n">jint</span> <span class="n">type</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">jlong</span> <span class="n">nanoseconds</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="n">seconds</span><span class="p">;</span>
</span><span class='line'>    <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">=</span> <span class="n">nanoseconds</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ANDROID_ALARM_SET</span><span class="p">(</span><span class="n">type</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Unable to set alarm to %lld.%09lld: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">seconds</span><span class="p">,</span> <span class="n">nanoseconds</span><span class="p">,</span> <span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>fd AlarmManagerService :</p>

<figure class='code'><figcaption><span>frameworks/services/java/com/android/server/AlarmManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">public</span> <span class="nf">AlarmManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">mContext</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
</span><span class='line'>        <span class="n">mDescriptor</span> <span class="o">=</span> <span class="n">init</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mNextWakeup</span> <span class="o">=</span> <span class="n">mNextNonWakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>init  native :</p>

<figure class='code'><figcaption><span>frameworks/base/services/jni/com_android_server_AlarmManagerService.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">jint</span> <span class="n">android_server_AlarmManagerService_init</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/alarm&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> alarm  AlarmManagerService  AlarmThread  alarm </p>

<figure class='code'><figcaption><span>frameworks/services/java/com/android/server/AlarmManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">private</span> <span class="kd">final</span> <span class="n">AlarmThread</span> <span class="n">mWaitThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlarmThread</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'> <span class="kd">public</span> <span class="nf">AlarmManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>         <span class="k">if</span> <span class="o">(</span><span class="n">mDescriptor</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mWaitThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">Slog</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Failed to open alarm driver. Falling back to a handler.&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> AlarmThread  alarm </p>

<figure class='code'><figcaption><span>frameworks/services/java/com/android/server/AlarmManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">private</span> <span class="kd">class</span> <span class="nc">AlarmThread</span> <span class="kd">extends</span> <span class="n">Thread</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">AlarmThread</span><span class="o">()</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="kd">super</span><span class="o">(</span><span class="s">&quot;AlarmManager&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span>
</span><span class='line'>        <span class="o">{</span>
</span><span class='line'>            <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Alarm</span><span class="o">&gt;</span> <span class="n">triggerList</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Alarm</span><span class="o">&gt;();</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>            <span class="o">{</span>
</span><span class='line'>                <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">waitForAlarm</span><span class="o">(</span><span class="n">mDescriptor</span><span class="o">);</span>
</span><span class='line'>                <span class="o">...</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> AlarmManagerService  PendingIntent.</p>

<p></p>

<p></p>

<p>Android  Intent  </p>

<figure class='code'><figcaption><span>Intent.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**  </span>
</span><span class='line'><span class="cm"> * Broadcast Action: The current time has changed.  Sent every</span>
</span><span class='line'><span class="cm"> * minute.  You can &lt;em&gt;not&lt;/em&gt; receive this through components declared</span>
</span><span class='line'><span class="cm"> * in manifests, only by explicitly registering for it with</span>
</span><span class='line'><span class="cm"> * {@link Context#registerReceiver(BroadcastReceiver, IntentFilter)</span>
</span><span class='line'><span class="cm"> * Context.registerReceiver()}.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * &lt;p class=&quot;note&quot;&gt;This is a protected intent that can only be sent</span>
</span><span class='line'><span class="cm"> * by the system.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nd">@SdkConstant</span><span class="o">(</span><span class="n">SdkConstantType</span><span class="o">.</span><span class="na">BROADCAST_INTENT_ACTION</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ACTION_TIME_TICK</span> <span class="o">=</span> <span class="s">&quot;android.intent.action.TIME_TICK&quot;</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p> Intent ,  IntentAlarmManagerService </p>

<p> AlarmManagerService  ClockReceiver  scheduleTimeTickEvent native <code>set</code>  PendingIntent  ACTION_TIME_TICK  Intent</p>

<p> ClockReceiver ACTION_TIME_TICK  ACTION_TIME_TICK scheduleTimeTickEvent</p>

<figure class='code'><figcaption><span>frameworks/services/java/com/android/server/AlarmManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="nf">AlarmManagerService</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mTimeTickSender</span> <span class="o">=</span> <span class="n">PendingIntent</span><span class="o">.</span><span class="na">getBroadcastAsUser</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>                <span class="k">new</span> <span class="nf">Intent</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_TIME_TICK</span><span class="o">).</span><span class="na">addFlags</span><span class="o">(</span>
</span><span class='line'>                        <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_RECEIVER_REGISTERED_ONLY</span>
</span><span class='line'>                        <span class="o">|</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_RECEIVER_FOREGROUND</span><span class="o">),</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>                        <span class="n">UserHandle</span><span class="o">.</span><span class="na">ALL</span><span class="o">);</span>
</span><span class='line'>        <span class="c1">// now that we have initied the driver schedule the alarm</span>
</span><span class='line'>        <span class="n">mClockReceiver</span><span class="o">=</span> <span class="k">new</span> <span class="n">ClockReceiver</span><span class="o">();</span>
</span><span class='line'>        <span class="n">mClockReceiver</span><span class="o">.</span><span class="na">scheduleTimeTickEvent</span><span class="o">();</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kd">class</span> <span class="nc">ClockReceiver</span> <span class="kd">extends</span> <span class="n">BroadcastReceiver</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">ClockReceiver</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">IntentFilter</span> <span class="n">filter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IntentFilter</span><span class="o">();</span>
</span><span class='line'>            <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_TIME_TICK</span><span class="o">);</span>
</span><span class='line'>            <span class="n">filter</span><span class="o">.</span><span class="na">addAction</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_DATE_CHANGED</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mContext</span><span class="o">.</span><span class="na">registerReceiver</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">filter</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>       <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getAction</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">ACTION_TIME_TICK</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">scheduleTimeTickEvent</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleTimeTickEvent</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">currentTime</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
</span><span class='line'>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">nextTime</span> <span class="o">=</span> <span class="mi">60000</span> <span class="o">*</span> <span class="o">((</span><span class="n">currentTime</span> <span class="o">/</span> <span class="mi">60000</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Schedule this event for the amount of time that it would take to get to</span>
</span><span class='line'>            <span class="c1">// the top of the next minute.</span>
</span><span class='line'>            <span class="kd">final</span> <span class="kt">long</span> <span class="n">tickEventDelay</span> <span class="o">=</span> <span class="n">nextTime</span> <span class="o">-</span> <span class="n">currentTime</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">final</span> <span class="n">WorkSource</span> <span class="n">workSource</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// Let system take blame for time tick events.</span>
</span><span class='line'>            <span class="n">set</span><span class="o">(</span><span class="n">ELAPSED_REALTIME</span><span class="o">,</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">elapsedRealtime</span><span class="o">()</span> <span class="o">+</span> <span class="n">tickEventDelay</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>                    <span class="mi">0</span><span class="o">,</span> <span class="n">mTimeTickSender</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="n">workSource</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><figcaption><span>packages/apps/DeskClock/src/com/android/deskclock/AnalogClock.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onAttachedToWindow</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>     <span class="o">...</span>
</span><span class='line'>     <span class="c1">// tick the seconds</span>
</span><span class='line'>     <span class="n">post</span><span class="o">(</span><span class="n">mClockTick</span><span class="o">);</span>
</span><span class='line'>     <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Runnable</span> <span class="n">mClockTick</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Runnable</span> <span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">onTimeChanged</span><span class="o">();</span>
</span><span class='line'>            <span class="n">invalidate</span><span class="o">();</span>
</span><span class='line'>            <span class="n">AnalogClock</span><span class="o">.</span><span class="na">this</span><span class="o">.</span><span class="na">postDelayed</span><span class="o">(</span><span class="n">mClockTick</span><span class="o">,</span> <span class="mi">1000</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p> post  Runnable  Runnable  run   post  Runnable Runnable </p>

<p>DeskClock  widget  TAB  <code>TextClock</code> <code>TextClock</code>  <code>ACTION_TIME_TICK</code> </p>

<ul>
<li>frameworks/base/core/java/android/widget/TextClock.java</li>
</ul>


<p>Statusbar  Clock  <code>ACTION_TIME_TICK</code> :</p>

<ul>
<li>frameworks/base/packages/SystemUI/src/com/android/systemui/statusbar/policy/Clock.java</li>
</ul>


<p>Keyguard  Clock  <code>TextClock</code>  </p>

<p> <code>ACTION_TIME_TICK</code>  Intent </p>

<p> UTC  <code>System.currentTimeMillis()</code> </p>

<figure class='code'><figcaption><span>libcore/luni/src/main/java/java/lang/System.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/** </span>
</span><span class='line'><span class="cm"> * Returns the current time in milliseconds since January 1, 1970 00:00:00.0 UTC.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * &lt;p&gt;This method always returns UTC times, regardless of the system&#39;s time zone.</span>
</span><span class='line'><span class="cm"> * This is often called &quot;Unix time&quot; or &quot;epoch time&quot;.</span>
</span><span class='line'><span class="cm"> * Use a {@link java.text.DateFormat} instance to format this time for display to a human.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * &lt;p&gt;This method shouldn&#39;t be used for measuring timeouts or</span>
</span><span class='line'><span class="cm"> * other elapsed time measurements, as changing the system time can affect</span>
</span><span class='line'><span class="cm"> * the results. Use {@link #nanoTime} for that.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">long</span> <span class="nf">currentTimeMillis</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p> 1970.1.1 Unix</p>

<p> native  <code>gettimeofday</code> :</p>

<figure class='code'><figcaption><span>libcore/luni/src/main/native/java_lang_System.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">jlong</span> <span class="n">System_currentTimeMillis</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span><span class="p">,</span> <span class="n">jclass</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">timeval</span> <span class="n">now</span><span class="p">;</span>
</span><span class='line'>    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">now</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">jlong</span> <span class="n">when</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000LL</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">when</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> Linux shell  <code>man gettimeofday</code> </p>

<figure class='code'><figcaption><span>libcore/luni/src/main/native/java_lang_System.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">GETTIMEOFDAY</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>                                      <span class="n">Linux</span> <span class="n">Programmer</span><span class="err">&#39;</span><span class="n">s</span> <span class="n">Manual</span>                                     <span class="n">GETTIMEOFDAY</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">NAME</span>
</span><span class='line'>       <span class="n">gettimeofday</span><span class="p">,</span> <span class="n">settimeofday</span> <span class="o">-</span> <span class="n">get</span> <span class="o">/</span> <span class="n">set</span> <span class="n">time</span>
</span><span class='line'>
</span><span class='line'><span class="n">SYNOPSIS</span>
</span><span class='line'>       <span class="err">#</span><span class="n">include</span> <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">time</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>       <span class="kt">int</span> <span class="n">gettimeofday</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">timezone</span> <span class="o">*</span><span class="n">tz</span><span class="p">);</span>
</span><span class='line'>       <span class="kt">int</span> <span class="n">settimeofday</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">timezone</span> <span class="o">*</span><span class="n">tz</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Feature</span> <span class="n">Test</span> <span class="n">Macro</span> <span class="n">Requirements</span> <span class="k">for</span> <span class="n">glibc</span> <span class="p">(</span><span class="n">see</span> <span class="n">feature_test_macros</span><span class="p">(</span><span class="mi">7</span><span class="p">))</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">settimeofday</span><span class="p">()</span><span class="o">:</span> <span class="n">_BSD_SOURCE</span>
</span><span class='line'>
</span><span class='line'><span class="n">DESCRIPTION</span>
</span><span class='line'>       <span class="n">The</span>  <span class="n">functions</span>  <span class="n">gettimeofday</span><span class="p">()</span>  <span class="n">and</span>  <span class="n">settimeofday</span><span class="p">()</span>  <span class="n">can</span>  <span class="n">get</span> <span class="n">and</span> <span class="n">set</span> <span class="n">the</span> <span class="n">time</span> <span class="n">as</span> <span class="n">well</span> <span class="n">as</span> <span class="n">a</span> <span class="n">timezone</span><span class="p">.</span>  <span class="n">The</span> <span class="n">tv</span> <span class="n">argument</span> <span class="n">is</span> <span class="n">a</span>
</span><span class='line'>       <span class="k">struct</span> <span class="n">timeval</span> <span class="p">(</span><span class="n">as</span> <span class="n">specified</span> <span class="n">in</span> <span class="o">&lt;</span><span class="n">sys</span><span class="o">/</span><span class="n">time</span><span class="p">.</span><span class="n">h</span><span class="o">&gt;</span><span class="p">)</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>           <span class="k">struct</span> <span class="n">timeval</span> <span class="p">{</span>
</span><span class='line'>               <span class="n">time_t</span>      <span class="n">tv_sec</span><span class="p">;</span>     <span class="cm">/* seconds */</span>
</span><span class='line'>               <span class="n">suseconds_t</span> <span class="n">tv_usec</span><span class="p">;</span>    <span class="cm">/* microseconds */</span>
</span><span class='line'>           <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">and</span> <span class="n">gives</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">seconds</span> <span class="n">and</span> <span class="n">microseconds</span> <span class="n">since</span> <span class="n">the</span> <span class="n">Epoch</span> <span class="p">(</span><span class="n">see</span> <span class="n">time</span><span class="p">(</span><span class="mi">2</span><span class="p">)).</span>  <span class="n">The</span> <span class="n">tz</span> <span class="n">argument</span> <span class="n">is</span> <span class="n">a</span> <span class="k">struct</span> <span class="nl">timezone:</span>
</span><span class='line'>
</span><span class='line'>           <span class="k">struct</span> <span class="n">timezone</span> <span class="p">{</span>
</span><span class='line'>               <span class="kt">int</span> <span class="n">tz_minuteswest</span><span class="p">;</span>     <span class="cm">/* minutes west of Greenwich */</span>
</span><span class='line'>               <span class="kt">int</span> <span class="n">tz_dsttime</span><span class="p">;</span>         <span class="cm">/* type of DST correction */</span>
</span><span class='line'>           <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">If</span> <span class="n">either</span> <span class="n">tv</span> <span class="n">or</span> <span class="n">tz</span> <span class="n">is</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">structure</span> <span class="n">is</span> <span class="n">not</span> <span class="n">set</span> <span class="n">or</span> <span class="n">returned</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>timeval  <code>tv_sec</code> <code>tv_usec</code> (1/1000000 ). timeval  :</p>

<figure class='code'><figcaption><span>libcore/luni/src/main/native/java_lang_System.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">jlong</span> <span class="n">when</span> <span class="o">=</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000LL</span> <span class="o">+</span> <span class="n">now</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>gettimeofday libc  system call  kernel </p>

<p> libc   <a href="http://www.win.tue.nl/~aeb/linux/lk/lk-3.html">user space and libc interface</a></p>

<p> API ,  SystemClock.java :</p>

<ul>
<li>elapsedRealtime ()                //Returns milliseconds since boot, including time spent in sleep.</li>
<li>elapsedRealtimeNanos ()          //Returns nanoseconds since boot, including time spent in sleep.</li>
<li>uptimeMillis ()                  //Returns milliseconds since boot, not counting time spent in deep sleep.</li>
</ul>


<p><code>elapsedRealtime()</code>  <code>elapsedRealtimeNanos()</code>  sleep  <code>uptimeMillis()</code>  sleep  <a href="http://developer.android.com/reference/android/os/SystemClock.html">SystemClock</a></p>

<p><code>elapsedRealtime()</code> api Android  Settings->About phone->Status->Uptime Settings->Battery  unplug </p>

<p> <code>elapsedRealtime</code> </p>

<figure class='code'><figcaption><span>SystemClock.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kd">native</span> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">elapsedRealtime</span><span class="o">();</span>
</span></code></pre></td></tr></table></div></figure>


<p> SystemClock  native </p>

<figure class='code'><figcaption><span>frameworks/base/core/jni/android_os_SystemClock.cpp </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * native public static long elapsedRealtime();</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="n">jlong</span> <span class="n">android_os_SystemClock_elapsedRealtime</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span>
</span><span class='line'>        <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span><span class="n">jlong</span><span class="p">)</span><span class="n">elapsedRealtime</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>cpp libutils  <code>elapsedRealtime()</code>.</p>

<figure class='code'><figcaption><span>system/core/libutils/SystemClock.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * native public static long elapsedRealtime();</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="n">int64_t</span> <span class="n">elapsedRealtime</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">nanoseconds_to_milliseconds</span><span class="p">(</span><span class="n">elapsedRealtimeNano</span><span class="p">());</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * native public static long elapsedRealtimeNano();</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="n">int64_t</span> <span class="n">elapsedRealtimeNano</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="k">static</span> <span class="kt">int</span> <span class="n">s_fd</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">s_fd</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/alarm&quot;</span><span class="p">,</span> <span class="n">O_RDONLY</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">android_atomic_cmpxchg</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_fd</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">s_fd</span><span class="p">,</span>
</span><span class='line'>            <span class="n">ANDROID_ALARM_GET_TIME</span><span class="p">(</span><span class="n">ANDROID_ALARM_ELAPSED_REALTIME</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">seconds_to_nanoseconds</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">)</span> <span class="o">+</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
</span><span class='line'>        <span class="n">checkTimeStamps</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prevTimestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">prevMethod</span><span class="p">,</span> <span class="n">METHOD_IOCTL</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">timestamp</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>elapsedRealtimeNano()</code>  <code>/dev/alarm</code>  ioctl  driver </p>

<p>(UTC) kernel system call   ioctl
<code>/dev/alarm</code> </p>

<p>Alarm/Clock /)</p>

<p> Android  Settings-> Date &amp; Time  &ndash;> UI 
Date  Time  AlarmManagerService  <code>setTime</code> </p>

<figure class='code'><figcaption><span>AlarmManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">setTime</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">mContext</span><span class="o">.</span><span class="na">enforceCallingOrSelfPermission</span><span class="o">(</span>
</span><span class='line'>            <span class="s">&quot;android.permission.SET_TIME&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="s">&quot;setTime&quot;</span><span class="o">);</span>  <span class="c1">// permission</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">SystemClock</span><span class="o">.</span><span class="na">setCurrentTimeMillis</span><span class="o">(</span><span class="n">millis</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>AlarmManagerService  SystemClock  api <code>setCurrentTimeMillis</code>.</p>

<figure class='code'><figcaption><span>SystemClock.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/** </span>
</span><span class='line'><span class="cm"> * Sets the current wall time, in milliseconds.  Requires the calling</span>
</span><span class='line'><span class="cm"> * process to have appropriate permissions.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @return if the clock was successfully set to the specified time.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">native</span> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">setCurrentTimeMillis</span><span class="o">(</span><span class="kt">long</span> <span class="n">millis</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>SystemClock.java  native </p>

<figure class='code'><figcaption><span>android_os_SystemClock.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Set the current time.  This only works when running as root.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="n">setCurrentTimeMillis</span><span class="p">(</span><span class="n">int64_t</span> <span class="n">millis</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/alarm&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">res</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">ANDROID_ALARM_SET_RTC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>android_os_SystemClock.cpp  ioctl <code>/dev/alarm</code>  driver  alarm </p>

<p> Google  2.android.pool.ntp.org () , 24 h 60s</p>

<p>:</p>

<ul>
<li>frameworks/base/services/java/com/android/server/NetworkTimeUpdateService.java</li>
<li>frameworks/base/core/java/android/util/NtpTrustedTime.java</li>
<li>frameworks/base/core/res/res/values/config.xml</li>
</ul>


<p> ioctl <code>/dev/alarm</code>  driver  alarm  Google  2.android.pool.ntp.org </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[android properties data structure]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/12/24/android-properties-data-structure/"/>
    <updated>2013-12-24T13:04:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/12/24/android-properties-data-structure</id>
    <content type="html"><![CDATA[<p></p>

<ul>
<li></li>
<li></li>
<li></li>
<li></li>
</ul>


<!-- more -->


<p> Jelly Bean  KitKat  <code>properties</code> .</p>

<p> <strong>/dev/__properties__</strong>  (root RW  R)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ls -al /dev/__proper*
</span><span class='line'>-rw-r--r-- root     root        65536 1970-01-14 05:26 __properties__
</span></code></pre></td></tr></table></div></figure>


<p> Jelly Bean) </p>

<p><img src="http://SteveVallay.github.io/images/blog/prop_struct_jb.png" alt="jb proper data structure" /></p>

<p>:</p>

<figure class='code'><figcaption><span>system/core/init/property_service.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">workspace</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>bionic/libc/bionic/system_properties.c </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">prop_area</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">serial</span><span class="p">;</span>  <span class="c1">//?</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">magic</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">version</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">toc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">prop_info</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">PROP_NAME_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">serial</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>toc[i]  property name  ( 8 )  proper_info  ( 24)
proper_info  serial ( 8 )  property value  length</p>

<p>:</p>

<ul>
<li> , Jelly Bean  65536,  495  properties.</li>
</ul>


<figure class='code'><figcaption><span>system/core/init/properties_service.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* (8 header words + 495 toc words) = 2012 bytes */</span>
</span><span class='line'><span class="cm">/* 2016 bytes header and toc + 495 prop_infos @ 128 bytes = 65376 bytes */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PA_COUNT_MAX  495</span>
</span><span class='line'><span class="cp">#define PA_INFO_START 2016</span>
</span><span class='line'><span class="cp">#define PA_SIZE       65536</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>share memory ,  init ) (<strong>/dev/__properties__</strong>) map </li>
</ul>


<p>KitKat </p>

<p>KK   128*1024</p>

<p>:</p>

<figure class='code'><figcaption><span>bionic/libc/bionic/system_properties.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">prop_area</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">bytes_used</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">serial</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">magic</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">version</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">28</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">prop_info</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">serial</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">prop_bt</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">uint8_t</span> <span class="n">namelen</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">uint8_t</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">prop_off_t</span> <span class="n">prop</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">prop_off_t</span> <span class="n">left</span><span class="p">;</span>
</span><span class='line'>    <span class="n">prop_off_t</span> <span class="n">right</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">prop_off_t</span> <span class="n">children</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Kitkat  proper info  bTree bytes_used </p>

<figure class='code'><figcaption><span>bionic/libc/bionic/system_properties.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="o">*</span> <span class="o">+-----+</span>   <span class="n">children</span>    <span class="o">+----+</span>   <span class="n">children</span>    <span class="o">+--------+</span>
</span><span class='line'> <span class="o">*</span> <span class="o">|</span>     <span class="o">|--------------&gt;|</span> <span class="n">ro</span> <span class="o">|--------------&gt;|</span> <span class="n">secure</span> <span class="o">|</span>
</span><span class='line'> <span class="o">*</span> <span class="o">+-----+</span>               <span class="o">+----+</span>               <span class="o">+--------+</span>
</span><span class='line'> <span class="o">*</span>                       <span class="o">/</span>    <span class="err">\</span>                <span class="o">/</span>   <span class="o">|</span>
</span><span class='line'> <span class="o">*</span>                 <span class="n">left</span> <span class="o">/</span>      <span class="err">\</span> <span class="n">right</span>   <span class="n">left</span> <span class="o">/</span>    <span class="o">|</span>  <span class="n">prop</span>   <span class="o">+===========+</span>
</span><span class='line'> <span class="o">*</span>                     <span class="n">v</span>        <span class="n">v</span>            <span class="n">v</span>     <span class="o">+--------&gt;|</span> <span class="n">ro</span><span class="p">.</span><span class="n">secure</span> <span class="o">|</span>
</span><span class='line'> <span class="o">*</span>                  <span class="o">+-----+</span>   <span class="o">+-----+</span>     <span class="o">+-----+</span>            <span class="o">+-----------+</span>
</span><span class='line'> <span class="o">*</span>                  <span class="o">|</span> <span class="n">net</span> <span class="o">|</span>   <span class="o">|</span> <span class="n">sys</span> <span class="o">|</span>     <span class="o">|</span> <span class="n">com</span> <span class="o">|</span>            <span class="o">|</span>     <span class="mi">1</span>     <span class="o">|</span>
</span><span class='line'> <span class="o">*</span>                  <span class="o">+-----+</span>   <span class="o">+-----+</span>     <span class="o">+-----+</span>            <span class="o">+===========+</span>
</span></code></pre></td></tr></table></div></figure>


<p> !  </p>

<p>: <a href="http://rxwen.blogspot.com/2010/01/android-property-system.html">http://rxwen.blogspot.com/2010/01/android-property-system.html</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[android system properties dynamic]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/12/23/android-system-properties2/"/>
    <updated>2013-12-23T10:17:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/12/23/android-system-properties2</id>
    <content type="html"><![CDATA[<p></p>

<!--more-->


<p> android property service </p>

<p>:</p>

<p><img src="http://SteveVallay.github.io/images/blog/android_property.png" alt="android-property" /></p>

<p> /dev/__properties__ (Kitkat 4.4) </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># ls -al /dev/**__proper*
</span><span class='line'>-rw-r--r-- root     root        65536 1970-01-12 05:24 __properties__</span></code></pre></td></tr></table></div></figure>


<p>Init  <strong>/dev/__properties__</strong> map  <strong>/default.prop</strong> properties,  <strong>/dev/__properties__</strong>.  property_service ,  <code>property_service</code>  socket  socket  socket  proper_set  properties </p>

<p>proper_get (libc)  <strong>/dev/__properties__</strong> map  address properties .</p>

<p></p>

<p>Init Android  init  init main   init.c  main  property </p>

<p><strong>system/core/init/init.c</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="n">property_init</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>property_init</code>  property_service.c </p>

<p><strong>/system/core/init/property_service.c</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="kt">void</span> <span class="nf">property_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="n">init_property_area</span><span class="p">();</span>
</span><span class='line'> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">init_property_area</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">property_area_inited</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">__system_property_area_init</span><span class="p">())</span> <span class="c1">//</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">init_workspace</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pa_workspace</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fcntl</span><span class="p">(</span><span class="n">pa_workspace</span><span class="p">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">FD_CLOEXEC</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">property_area_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>__system_property_area_init</code>  <strong>bionic/libc/bionic/system_properties.c</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">__system_property_area_init</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">map_prop_area_rw</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">map_prop_area_rw</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">prop_area</span> <span class="o">*</span><span class="n">pa</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* dev is a tmpfs that we can use to carve a shared workspace</span>
</span><span class='line'><span class="cm">     * out of, so let&#39;s do that...</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">property_filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span>
</span><span class='line'>            <span class="n">O_EXCL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">errno</span> <span class="o">==</span> <span class="n">EACCES</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="cm">/* for consistency with the case where the process has already</span>
</span><span class='line'><span class="cm">             * mapped the page in and segfaults when trying to write to it</span>
</span><span class='line'><span class="cm">             */</span>
</span><span class='line'>            <span class="n">abort</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ret</span> <span class="o">=</span> <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">FD_CLOEXEC</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">ftruncate</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">PA_SIZE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pa_size</span> <span class="o">=</span> <span class="n">PA_SIZE</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pa_data_size</span> <span class="o">=</span> <span class="n">pa_size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_area</span><span class="p">);</span>
</span><span class='line'>    <span class="n">compat_mode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pa</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">pa_size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">pa</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span>
</span><span class='line'>        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pa_size</span><span class="p">);</span>
</span><span class='line'>    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">PROP_AREA_MAGIC</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">PROP_AREA_VERSION</span><span class="p">;</span>
</span><span class='line'>    <span class="cm">/* reserve root node */</span>
</span><span class='line'>    <span class="n">pa</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_bt</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* plug into the lib property services */</span>
</span><span class='line'>    <span class="n">__system_property_area__</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nl">out:</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <strong>/dev/__properties__</strong>  <code>mmap</code> .<code>__system_property_area__</code>  property_service  libc  properties )</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PROP_FILENAME &quot;/dev/__properties__&quot;</span>
</span><span class='line'><span class="k">static</span> <span class="kt">char</span> <span class="n">property_filename</span><span class="p">[</span><span class="n">PATH_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">PROP_FILENAME</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">property_filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span>
</span><span class='line'>            <span class="n">O_EXCL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">pa</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">pa_size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* plug into the lib property services */</span>
</span><span class='line'>    <span class="n">__system_property_area__</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p> init.c ,  boot defults properties</p>

<p>init.c</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="n">property_load_boot_defaults</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>property_service.c:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PROP_PATH_RAMDISK_DEFAULT  &quot;/default.prop&quot;</span>
</span><span class='line'>
</span><span class='line'> <span class="kt">void</span> <span class="nf">property_load_boot_defaults</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'> <span class="p">{</span>
</span><span class='line'>     <span class="n">load_properties_from_file</span><span class="p">(</span><span class="n">PROP_PATH_RAMDISK_DEFAULT</span><span class="p">);</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>load_properties_from_file</code>  <code>set_property</code></p>

<p> init.c ,  property service :</p>

<p>init.c:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">property_service_init_action</span><span class="p">,</span> <span class="s">&quot;property_service_init&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">property_service_init_action</span><span class="p">(</span><span class="kt">int</span> <span class="n">nargs</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="cm">/* read any property files on system or data and</span>
</span><span class='line'><span class="cm">     * fire up the property service.  This must happen</span>
</span><span class='line'><span class="cm">     * after the ro.foo properties are set above so</span>
</span><span class='line'><span class="cm">     * that /data/local.prop cannot interfere with them.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">start_property_service</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* update with vendor-specific property runtime</span>
</span><span class='line'><span class="cm">     * overrides</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="n">vendor_load_properties</span><span class="p">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>start_property_service</code>  properties (/system/build.prop, /system/default.prop, /data/property/xxx) <strong>/dev/socket/property_service</strong>  socket,  socket  set property </p>

<p>property_service.c:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">start_property_service</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="n">PROP_PATH_SYSTEM_BUILD</span><span class="p">);</span>
</span><span class='line'>    <span class="n">load_properties_from_file</span><span class="p">(</span><span class="n">PROP_PATH_SYSTEM_DEFAULT</span><span class="p">);</span>
</span><span class='line'>    <span class="n">load_override_properties</span><span class="p">();</span>
</span><span class='line'>    <span class="cm">/* Read persistent properties after all default values have been loaded. */</span>
</span><span class='line'>    <span class="n">load_persistent_properties</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">fd</span> <span class="o">=</span> <span class="n">create_socket</span><span class="p">(</span><span class="n">PROP_SERVICE_NAME</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mo">0666</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFD</span><span class="p">,</span> <span class="n">FD_CLOEXEC</span><span class="p">);</span>
</span><span class='line'>    <span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">listen</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
</span><span class='line'>    <span class="n">property_set_fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> init.c :</p>

<p>init  main  <strong>/dev/socket/property_service</strong>  fd </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'>    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">execute_one_command</span><span class="p">();</span>
</span><span class='line'>        <span class="n">restart_processes</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property_set_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_property_set_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_property_set_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">property_set_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_signal_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_signal_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">signal_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keychord_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_keychord_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_keychord_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">keychord_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">process_needs_restart</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">process_needs_restart</span> <span class="o">-</span> <span class="n">gettime</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action_queue_empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">cur_action</span><span class="p">)</span>
</span><span class='line'>            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if BOOTCHART</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">bootchart_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">BOOTCHART_POLLING_MS</span><span class="p">)</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="n">BOOTCHART_POLLING_MS</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">bootchart_step</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">--</span><span class="n">bootchart_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">bootchart_finish</span><span class="p">();</span>
</span><span class='line'>                <span class="n">bootchart_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">nr</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">ufds</span><span class="p">,</span> <span class="n">fd_count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">==</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_property_set_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_property_set_fd</span><span class="p">();</span>                 <span class="c1">//</span>
</span><span class='line'>                <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_keychord_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_keychord</span><span class="p">();</span>
</span><span class='line'>                <span class="k">else</span> <span class="nf">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_signal_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_signal</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>handler_property_set_fd</code>  <code>/dev/socket/property_service</code> </p>

<p>property_service.c:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">handle_property_set_fd</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">prop_msg</span> <span class="n">msg</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">ucred</span> <span class="n">cr</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">socklen_t</span> <span class="n">addr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">socklen_t</span> <span class="n">cr_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cr</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">char</span> <span class="o">*</span> <span class="n">source_ctx</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">property_set_fd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr_size</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* Check socket options here */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">getsockopt</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">SO_PEERCRED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cr_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;Unable to receive socket options</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">r</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">recv</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_msg</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;sys_prop: mis-match msg size received: %d expected: %d errno: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">r</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_msg</span><span class="p">),</span> <span class="n">errno</span><span class="p">);</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">switch</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">PROP_MSG_SETPROP</span>:                              <span class="c1">// set proper </span>
</span><span class='line'>        <span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">[</span><span class="n">PROP_NAME_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_legal_property_name</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;sys_prop: illegal property name. Got: </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>            <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">getpeercon</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">source_ctx</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;ctl.&quot;</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Keep the old close-socket-early behavior when handling</span>
</span><span class='line'>            <span class="c1">// ctl.* properties.</span>
</span><span class='line'>            <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">check_control_perms</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">source_ctx</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">handle_control_message</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;sys_prop: Unable to %s service ctl [%s] uid:%d gid:%d pid:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">msg</span><span class="p">.</span><span class="n">name</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">pid</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">check_perms</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">cr</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">source_ctx</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">property_set</span><span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>    <span class="c1">// prop</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;sys_prop: permission denied uid:%d  name:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">cr</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Note: bionic&#39;s property client code assumes that the</span>
</span><span class='line'>            <span class="c1">// property server will not close the socket until *AFTER*</span>
</span><span class='line'>            <span class="c1">// the property is written to memory.</span>
</span><span class='line'>            <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">freecon</span><span class="p">(</span><span class="n">source_ctx</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nl">default:</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="k">break</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>property_set</code>  <code>check_perms</code>,  property_set ?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cm">/* White list of permissions for setting property services. */</span>
</span><span class='line'><span class="k">struct</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uid</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gid</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">property_perms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.rmnet0.&quot;</span><span class="p">,</span>      <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.gprs.&quot;</span><span class="p">,</span>        <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.ppp&quot;</span><span class="p">,</span>          <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.qmi&quot;</span><span class="p">,</span>          <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.lte&quot;</span><span class="p">,</span>          <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.cdma&quot;</span><span class="p">,</span>         <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;ril.&quot;</span><span class="p">,</span>             <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;gsm.&quot;</span><span class="p">,</span>             <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;persist.radio&quot;</span><span class="p">,</span>    <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.dns&quot;</span><span class="p">,</span>          <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;sys.usb.config&quot;</span><span class="p">,</span>   <span class="n">AID_RADIO</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;net.&quot;</span><span class="p">,</span>             <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;dev.&quot;</span><span class="p">,</span>             <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;runtime.&quot;</span><span class="p">,</span>         <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;hw.&quot;</span><span class="p">,</span>              <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;sys.&quot;</span><span class="p">,</span>             <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;sys.powerctl&quot;</span><span class="p">,</span>     <span class="n">AID_SHELL</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;service.&quot;</span><span class="p">,</span>         <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;wlan.&quot;</span><span class="p">,</span>            <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;bluetooth.&quot;</span><span class="p">,</span>       <span class="n">AID_BLUETOOTH</span><span class="p">,</span>   <span class="n">AID_SYSTEM</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;dhcp.&quot;</span><span class="p">,</span>            <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;dhcp.&quot;</span><span class="p">,</span>            <span class="n">AID_DHCP</span><span class="p">,</span>     <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;debug.&quot;</span><span class="p">,</span>           <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;debug.&quot;</span><span class="p">,</span>           <span class="n">AID_SHELL</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;log.&quot;</span><span class="p">,</span>             <span class="n">AID_SHELL</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;service.adb.root&quot;</span><span class="p">,</span> <span class="n">AID_SHELL</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;service.adb.tcp.port&quot;</span><span class="p">,</span> <span class="n">AID_SHELL</span><span class="p">,</span>    <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;persist.sys.&quot;</span><span class="p">,</span>     <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;persist.service.&quot;</span><span class="p">,</span> <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;persist.security.&quot;</span><span class="p">,</span> <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;persist.service.bdroid.&quot;</span><span class="p">,</span> <span class="n">AID_BLUETOOTH</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="s">&quot;selinux.&quot;</span>         <span class="p">,</span> <span class="n">AID_SYSTEM</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>property_set</code>:</p>

<p> <code>__system_property_update</code> ,  <code>__system_property_add</code> , <code>persist.</code> <code>write_persistent_property</code>  <strong>/data/property/xxx</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">property_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">prop_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">valuelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_legal_property_name</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">valuelen</span> <span class="o">&gt;=</span> <span class="n">PROP_VALUE_MAX</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pi</span> <span class="o">=</span> <span class="p">(</span><span class="n">prop_info</span><span class="o">*</span><span class="p">)</span> <span class="n">__system_property_find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/* ro.* properties may NEVER be modified once set */</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ro.&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">__system_property_update</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valuelen</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ret</span> <span class="o">=</span> <span class="n">__system_property_add</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">namelen</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">valuelen</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ERROR</span><span class="p">(</span><span class="s">&quot;Failed to set &#39;%s&#39;=&#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="cm">/* If name starts with &quot;net.&quot; treat as a DNS property. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;net.&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;net.&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;net.change&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>       <span class="cm">/*  </span>
</span><span class='line'><span class="cm">        * The &#39;net.change&#39; property is a special property used track when any</span>
</span><span class='line'><span class="cm">        * &#39;net.*&#39; property name is updated. It is _ONLY_ updated here. Its value</span>
</span><span class='line'><span class="cm">        * contains the last updated &#39;net.*&#39; property.</span>
</span><span class='line'><span class="cm">        */</span>
</span><span class='line'>        <span class="n">property_set</span><span class="p">(</span><span class="s">&quot;net.change&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">persistent_properties_loaded</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="n">strncmp</span><span class="p">(</span><span class="s">&quot;persist.&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;persist.&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="cm">/*  </span>
</span><span class='line'><span class="cm">         * Don&#39;t write properties to disk until after we have read all default properties</span>
</span><span class='line'><span class="cm">         * to prevent them from being overwritten by default values.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">write_persistent_property</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;selinux.reload_policy&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>               <span class="n">strcmp</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">selinux_reload_policy</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">property_changed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK <code>proper_set</code>  <code>proper_get</code> . <code>proper_get</code>  libc  <code>__system_property_get</code>  api.</p>

<p><strong>/bionic/libc/bionic/system_properties.c</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">__system_property_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">prop_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">__system_property_find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">__system_property_read</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>__system_property_find</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="n">prop_info</span> <span class="o">*</span><span class="nf">__system_property_find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">__predict_false</span><span class="p">(</span><span class="n">compat_mode</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// compat_mode </span>
</span><span class='line'>        <span class="k">return</span> <span class="n">__system_property_find_compat</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">find_property</span><span class="p">(</span><span class="n">root_node</span><span class="p">(),</span> <span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span> <span class="c1">//</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>find_property</code>  <code>root_node()</code>,  <code>root_node()</code>?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="n">prop_bt</span> <span class="o">*</span><span class="nf">root_node</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">to_prop_obj</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">to_prop_obj</span><span class="p">(</span><span class="n">prop_off_t</span> <span class="n">off</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">pa_data_size</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">__system_property_area__</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">off</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>__system_property_area__-&gt;data</code>OK, <code>__system_property_area__</code>   <strong>/dev/<strong>properties</strong></strong> map </p>

<p>init.c  system_properties.c  <code>__system_property_area_init</code> &ndash;> <code>map_prop_area_rw</code> </p>

<p> <code>property_filename</code>(/dev/_-properties__), <code>mmap</code>   <code>__system_property_area__</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">map_prop_area_rw</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">property_filename</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_CREAT</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span> <span class="o">|</span>
</span><span class='line'>            <span class="n">O_EXCL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="n">pa</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">pa_size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="cm">/* plug into the lib property services */</span>
</span><span class='line'>    <span class="n">__system_property_area__</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>  init  <code>__system_property_find</code>  <code>__system_property_area__</code> ?   init  init </p>

<p>  <code>__system_property_area__</code>   
<strong>/bionic/libc/bionic/libc_init_common.cpp</strong>   <code>__system_properties_init()</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">void</span> <span class="nf">__libc_init_common</span><span class="p">(</span><span class="n">KernelArgumentBlock</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="n">__system_properties_init</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>/bionic/libc/bionic/system_properties.c</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">__system_properties_init</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">map_prop_area</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">map_prop_area</span><span class="p">()</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'> <span class="p">...</span>
</span><span class='line'> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">property_filename</span><span class="p">,</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_NOFOLLOW</span> <span class="o">|</span> <span class="n">O_CLOEXEC</span><span class="p">);</span>
</span><span class='line'> <span class="p">...</span>
</span><span class='line'><span class="n">prop_area</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">pa_size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="n">__system_property_area__</span> <span class="o">=</span> <span class="n">pa</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> RDONLY  <code>/dev/__properties__</code>  mmap  <code>__system_property_area__</code>   <code>__system_property_area__</code>  init </p>

<p>OK  property  </p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android System Properties]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/12/13/android-systemproperties/"/>
    <updated>2013-12-13T23:41:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/12/13/android-systemproperties</id>
    <content type="html"><![CDATA[<p>&mdash;o()o&hellip;</p>

<p>Property system  Android  Feature service  property  key/value key  value </p>

<p> Android  Property system  Android  system propterties  system properties </p>

<p>system properties  Feature  properties / Feature. Android Java  native </p>

<p> Android  Properties system Kitkat 4.4)</p>

<!--more-->


<p><img src="http://SteveVallay.github.io/images/blog/property-call-stack.png" alt="properties call stack" /></p>

<h4>Java </h4>

<p><strong>frameworks/base/core/java/android/os/SystemProperties.java</strong></p>

<p>java  <em>SysstemProperties.java</em> ,</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/*Get the value for the given key.*/</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">def</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getInt</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">def</span><span class="o">)</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">long</span> <span class="nf">getLong</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">def</span><span class="err"></span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">getBoolean</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">def</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/*Set the value for the given key.*/</span>
</span><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">val</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>get</code>  <code>set</code>  SystemProperties.get/set  SystemProperties  <em>hide</em>  SDK  API  SDK  app  ^_^)</p>

<h4>Framework </h4>

<p> native :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">native_get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">);</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="n">String</span> <span class="nf">native_get</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">def</span><span class="o">);</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">int</span> <span class="nf">native_get_int</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">int</span> <span class="n">def</span><span class="o">);</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">long</span> <span class="nf">native_get_long</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">long</span> <span class="n">def</span><span class="o">);</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">boolean</span> <span class="nf">native_get_boolean</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">def</span><span class="o">);</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">native_set</span><span class="o">(</span><span class="n">String</span> <span class="n">key</span><span class="o">,</span> <span class="n">String</span> <span class="n">def</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p> native  </p>

<p><strong>frameworks/base/core/jni/android_os_SystemProperties.cpp</strong>(android framework  native  <strong>/frameworks/base/core/jni</strong> )</p>

<p> JNI </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">static</span> <span class="n">jstring</span> <span class="n">SystemProperties_getSS</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span>
</span><span class='line'>                                      <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">defJ</span><span class="p">);</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">SystemProperties_set</span><span class="p">(</span><span class="n">JNIEnv</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span>
</span><span class='line'>                                      <span class="n">jstring</span> <span class="n">keyJ</span><span class="p">,</span> <span class="n">jstring</span> <span class="n">valJ</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>get/set</strong> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">property_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="n">property_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span><span class="k">default</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &quot;cutils/properties.h&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>.h  <strong>system/core/include/cutils/properties.h</strong></p>

<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">property_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_value</span><span class="p">);</span>
</span><span class='line'><span class="kt">int</span> <span class="nf">property_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>  <strong>properties.c</strong> </p>

<p><strong>system/core/libcutils/properties.c</strong></p>

<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifdef HAVE_LIBC_SYSTEM_PROPERTIES</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define _REALLY_INCLUDE_SYS__SYSTEM_PROPERTIES_H_</span>
</span><span class='line'><span class="cp">#include &lt;sys/_system_properties.h&gt;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="cp">#elif defined(HAVE_SYSTEM_PROPERTY_SERVER)</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="cp">#else</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/* SUPER-cheesy place-holder implementation for Win32 */</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;cutils/threads.h&gt;</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>property system ?  ~</p>

<p> <code>api</code>  <strong>__system_property_set</strong>  <strong>__system_property_get</strong>  <strong>sys/_system_properties.h</strong> ).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifdef HAVE_LIBC_SYSTEM_PROPERTIES</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define _REALLY_INCLUDE_SYS__SYSTEM_PROPERTIES_H_</span>
</span><span class='line'><span class="cp">#include &lt;sys/_system_properties.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">property_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">__system_property_set</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">property_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">default_value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">len</span> <span class="o">=</span> <span class="n">__system_property_get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">default_value</span><span class="p">);</span>
</span><span class='line'>        <span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">default_value</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <strong>sys/_system_properties.h</strong> .
<strong>bionic/libc/include/sys/_system_properties.h</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define PROP_SERVICE_NAME &quot;property_service&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define TOC_NAME_LEN(toc)       ((toc) &gt;&gt; 24)</span>
</span><span class='line'><span class="cp">#define TOC_TO_INFO(area, toc)  ((prop_info*) (((char*) area) + ((toc) &amp; 0xFFFFFF)))</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">prop_area</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">count</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">serial</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">magic</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">version</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">toc</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">prop_info</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">PROP_NAME_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="k">volatile</span> <span class="n">serial</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">prop_msg</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">cmd</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">PROP_NAME_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">PROP_VALUE_MAX</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PROP_MSG_SETPROP 1</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define PROP_PATH_RAMDISK_DEFAULT  &quot;/default.prop&quot;</span>
</span><span class='line'><span class="cp">#define PROP_PATH_SYSTEM_BUILD     &quot;/system/build.prop&quot;</span>
</span><span class='line'><span class="cp">#define PROP_PATH_SYSTEM_DEFAULT   &quot;/system/default.prop&quot;</span>
</span><span class='line'><span class="cp">#define PROP_PATH_LOCAL_OVERRIDE   &quot;/data/local.prop&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>api</code>  ^_^
 <strong>bionic/libc/bionic/system_properties.c</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">property_service_socket</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;/dev/socket/&quot;</span> <span class="n">PROP_SERVICE_NAME</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">__system_property_get</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">prop_info</span> <span class="o">*</span><span class="n">pi</span> <span class="o">=</span> <span class="n">__system_property_find</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">pi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">__system_property_read</span><span class="p">(</span><span class="n">pi</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">__system_property_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">tries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">update_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>    <span class="n">prop_msg</span> <span class="n">msg</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PROP_NAME_MAX</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">PROP_VALUE_MAX</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="n">msg</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">PROP_MSG_SETPROP</span><span class="p">;</span>
</span><span class='line'>    <span class="n">strlcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strlcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">msg</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">err</span> <span class="o">=</span> <span class="n">send_prop_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <strong>__system_property_get</strong>  <strong>__system_property_set</strong> , <strong>__system_property_find</strong> <strong>__system_property_read</strong>  <strong>send_prop_msg</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">const</span> <span class="n">prop_info</span> <span class="o">*</span><span class="nf">__system_property_find</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">prop_area</span> <span class="o">*</span><span class="n">pa</span> <span class="o">=</span> <span class="n">__system_property_area__</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">count</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="o">*</span><span class="n">toc</span> <span class="o">=</span> <span class="n">pa</span><span class="o">-&gt;</span><span class="n">toc</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="n">prop_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">while</span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">unsigned</span> <span class="n">entry</span> <span class="o">=</span> <span class="o">*</span><span class="n">toc</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">TOC_NAME_LEN</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pi</span> <span class="o">=</span> <span class="n">TOC_TO_INFO</span><span class="p">(</span><span class="n">pa</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">pi</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="nf">__system_property_read</span><span class="p">(</span><span class="k">const</span> <span class="n">prop_info</span> <span class="o">*</span><span class="n">pi</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">unsigned</span> <span class="n">serial</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">serial</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
</span><span class='line'>        <span class="k">while</span><span class="p">(</span><span class="n">SERIAL_DIRTY</span><span class="p">(</span><span class="n">serial</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">__futex_wait</span><span class="p">((</span><span class="k">volatile</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span> <span class="n">serial</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">serial</span> <span class="o">=</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="n">len</span> <span class="o">=</span> <span class="n">SERIAL_VALUE_LEN</span><span class="p">(</span><span class="n">serial</span><span class="p">);</span>
</span><span class='line'>        <span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="n">serial</span> <span class="o">==</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">strcpy</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">pi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">len</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">int</span> <span class="nf">send_prop_msg</span><span class="p">(</span><span class="n">prop_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pollfds</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sockaddr_un</span> <span class="n">addr</span><span class="p">;</span>
</span><span class='line'>    <span class="n">socklen_t</span> <span class="n">alen</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">size_t</span> <span class="n">namelen</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_LOCAL</span><span class="p">,</span> <span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">s</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">));</span>
</span><span class='line'>    <span class="n">namelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">property_service_socket</span><span class="p">);</span>
</span><span class='line'>    <span class="n">strlcpy</span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">,</span> <span class="n">property_service_socket</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">addr</span><span class="p">.</span><span class="n">sun_path</span><span class="p">);</span>
</span><span class='line'>    <span class="n">addr</span><span class="p">.</span><span class="n">sun_family</span> <span class="o">=</span> <span class="n">AF_LOCAL</span><span class="p">;</span>
</span><span class='line'>    <span class="n">alen</span> <span class="o">=</span> <span class="n">namelen</span> <span class="o">+</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr_un</span><span class="p">,</span> <span class="n">sun_path</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="n">alen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">r</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">send</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_msg</span><span class="p">),</span> <span class="mi">0</span><span class="p">));</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">prop_msg</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// We successfully wrote to the property server but now we</span>
</span><span class='line'>        <span class="c1">// wait for the property server to finish its work.  It</span>
</span><span class='line'>        <span class="c1">// acknowledges its completion by closing the socket so we</span>
</span><span class='line'>        <span class="c1">// poll here (on nothing), waiting for the socket to close.</span>
</span><span class='line'>        <span class="c1">// If you &#39;adb shell setprop foo bar&#39; you&#39;ll see the POLLHUP</span>
</span><span class='line'>        <span class="c1">// once the socket closes.  Out of paranoia we cap our poll</span>
</span><span class='line'>        <span class="c1">// at 250 ms.</span>
</span><span class='line'>        <span class="n">pollfds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>        <span class="n">pollfds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="n">r</span> <span class="o">=</span> <span class="n">TEMP_FAILURE_RETRY</span><span class="p">(</span><span class="n">poll</span><span class="p">(</span><span class="n">pollfds</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">250</span> <span class="cm">/* ms */</span><span class="p">));</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pollfds</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLHUP</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Ignore the timeout and treat it like a success anyway.</span>
</span><span class='line'>            <span class="c1">// The init process is single-threaded and its property</span>
</span><span class='line'>            <span class="c1">// service is sometimes slow to respond (perhaps it&#39;s off</span>
</span><span class='line'>            <span class="c1">// starting a child process or something) and thus this</span>
</span><span class='line'>            <span class="c1">// times out and the caller thinks it failed, even though</span>
</span><span class='line'>            <span class="c1">// it&#39;s still getting around to it.  So we fake it here,</span>
</span><span class='line'>            <span class="c1">// mostly for ctl.* properties, but we do try and wait 250</span>
</span><span class='line'>            <span class="c1">// ms so callers who do read-after-write can reliably see</span>
</span><span class='line'>            <span class="c1">// what they&#39;ve written.  Most of the time.</span>
</span><span class='line'>            <span class="c1">// TODO: fix the system properties design.</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> get  prop_info  set  <strong>property_service_socket(&ldquo;/dev/socket/property_service&rdquo;)</strong> property proper_set socket  property system </p>

<p> Android system properties </p>

<p>Java </p>

<ul>
<li>frameworks/base/core/java/android/os/SystemProperties.java</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Gives access to the system properties store.  The system properties</span>
</span><span class='line'><span class="cm"> * store contains a list of string key-value pairs.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * {@hide}</span>
</span><span class='line'><span class="cm"> */</span>
</span></code></pre></td></tr></table></div></figure>


<p>native </p>

<p>Android framework  native  runtime  <strong>frameworks/base/core/jni</strong> </p>

<p> properties 
&ndash; frameworks/base/core/jni/android_os_SystemProperties.cpp</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#include &quot;cutils/properties.h&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>cutils:</p>

<p><strong>system</strong>  ?</p>

<blockquote><p>System &ndash; source code files for the core Android system. That is the minimal Linux system that is started before the Dalvik VM and any java based services are enabled. This includes the source code for the init process and the default init.rc script that provide the dynamic configuration of the platform.</p></blockquote>

<ul>
<li>system/core/libcutils/properties.c  // _system_properties.h</li>
<li>system/core/include/cutils/properties.h //properties.c   jni .</li>
<li>system/core/init/property_service.h  //property_service </li>
<li>system/core/init/property_service.c  //</li>
<li>system/core/init/init.c</li>
</ul>


<p>libc:</p>

<p><strong>Bionic</strong> </p>

<blockquote><p>Bionic &ndash; the C-runtime for Android. Note that Android is not using glibc like most Linux distributions. Instead the c-library is called bionic and is based mostly on BSD-derived sources. In this folder you will find the source for the c-library, math and other core runtime libraries.</p></blockquote>

<ul>
<li>bionic/libc/include/sys/_system_properties.h // system_properties.h</li>
<li>bionic/libc/include/sys/system_properties.h //system_properties.c </li>
<li>/libc/bionic/system_properties.c</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[deploy app to digit ocean]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/11/13/deploy-app-to-digit-ocean/"/>
    <updated>2013-11-13T16:06:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/11/13/deploy-app-to-digit-ocean</id>
    <content type="html"><![CDATA[<p> VPS  <a href="http://192.241.192.134/">Rails </a> <a href="http://v2ex.com/">V2EX</a>   VPS  <a href="https://www.linode.com/">Linode</a> , <a href="https://www.digitalocean.com/">DigitalOcean</a> </p>

<p> <a href="https://www.digitalocean.com/">Digital Ocean</a>  5$  10$ ;&ndash;),  <a href="https://www.digitalocean.com/">Digital Ocean</a></p>

<!--more -->


<h3></h3>

<p> <a href="https://www.digitalocean.com/">DigitalOcean</a>  <strong>CREATE</strong>  VPS  <em>Image</em>.</p>

<p> 5$  <strong>512M/1CPU/20G/1TB</strong>,  <strong>Sanfrancisco</strong> ,  <em>Image</em>  <strong>Ubuntu 12.04</strong>, </p>

<p> <strong>Select Image</strong>  <em>Application</em></p>

<p><img src="http://SteveVallay.github.io/images/blog/digitocean.png" alt="digital ocean pre-install application" /></p>

<p> <strong>Ruby on Rails</strong>  <a href="http://wiki.nginx.org/Main">Ngnix</a> + <a href="http://unicorn.bogomips.org/">Unicorn</a> ,</p>

<h3></h3>

<p><a href="https://www.digitalocean.com/">DigitalOcean</a>  Email  VPS  IP, Username  Password  Username  root, </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>useradd -m -d /home/your_user_name -s /bin/bash your_user_name</span></code></pre></td></tr></table></div></figure>


<p>-d  HOME  home/your_user_name</p>

<p>-m  HOME </p>

<p>-s  shell </p>

<p></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>passwd your_user_name
</span><span class='line'>##input your password twice</span></code></pre></td></tr></table></div></figure>


<p> <strong>sudoer</strong> </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo adduser your_user_name sudo</span></code></pre></td></tr></table></div></figure>


<p> <strong>your_user_name</strong> </p>

<h3> Ruby on Rails</h3>

<p> Ruby on Rails   <a href="https://github.com/sstephenson/rbenv">rbenv</a>   <a href="https://rvm.io/">rvm</a>  <a href="https://github.com/sstephenson/rbenv">rbenv</a>   <a href="https://rvm.io/">rvm</a> </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#  curl  git 
</span><span class='line'>sudo apt-get install curl git
</span><span class='line'>
</span><span class='line'>#  rvm  ruby
</span><span class='line'>
</span><span class='line'>curl -L https://get.rvm.io | bash -s stable --ruby
</span><span class='line'>
</span><span class='line'>rvm install 2.0.0
</span></code></pre></td></tr></table></div></figure>


<p> clone  project ,  gems ( Rails )</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#git clone xxxx  
</span><span class='line'>#cd your project
</span><span class='line'>
</span><span class='line'>gem install bundler 
</span><span class='line'>
</span><span class='line'>bundle install 
</span></code></pre></td></tr></table></div></figure>


<p> <code>rails s</code>  rails application  <code>rake db:migrate</code></p>

<h3><a href="http://www.apache.org/">Apache2</a> + <a href="https://www.phusionpassenger.com/">Passenger</a></h3>

<p>  <a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/webrick/rdoc/WEBrick.html">WEBrick</a>   HTTP  <a href="http://www.apache.org/">Apache</a>  <a href="http://wiki.nginx.org/Main">Nginx</a> ,  <a href="http://www.apache.org/">Apache</a></p>

<p><a href="https://www.phusionpassenger.com/">Passenger</a>  <a href="http://www.apache.org/">Apache</a>  
<a href="http://wiki.nginx.org/Main">Nginx</a> <a href="http://www.apache.org/">Apache2</a> + <a href="https://www.phusionpassenger.com/">Passenger</a>  app </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#install apache2
</span><span class='line'>sudo apt-get install apache2 apache2-mpm-prefork apache2-prefork-dev
</span><span class='line'>
</span><span class='line'>#install mysql, do not need this if you do not use mysql
</span><span class='line'>sudo apt-get install mysql-server mysql-client
</span><span class='line'>sudo apt-get install libmysql-ruby libmysqlclient15-dev
</span><span class='line'>
</span><span class='line'>#install passenger
</span><span class='line'>apt-get install libcurl4-openssl-dev
</span><span class='line'>gem install passenger
</span><span class='line'>
</span><span class='line'>#make swap partision , default no swap in digital ocean.
</span><span class='line'>dd if=/dev/zero of=/swap bs=1M count=1024
</span><span class='line'>mkswap /swap
</span><span class='line'>swapon /swap
</span><span class='line'>#execute this script to install apache2 module of passenger
</span><span class='line'>passenger-install-apache2-module
</span></code></pre></td></tr></table></div></figure>


<p> <code>passenger-install-apache2-module</code> ()</p>

<blockquote><p>LoadModule passenger_module /home/goodluck/.rvm/gems/ruby-2.0.0-p247/gems/passenger-4.0.23/buildout/apache2/mod_passenger.so
PassengerRoot /home/goodluck/.rvm/gems/ruby-2.0.0-p247/gems/passenger-4.0.23
PassengerDefaultRuby /home/goodluck/.rvm/wrappers/ruby-2.0.0-p247/ruby</p></blockquote>

<p> <code>/etc/apache2/httpd.conf</code>  apache2 </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;VirtualHost</span> <span class="err">*:80</span><span class="nt">&gt;</span>
</span><span class='line'>      ServerName localhost
</span><span class='line'>      # !!! Be sure to point DocumentRoot to &#39;public&#39;!
</span><span class='line'>      DocumentRoot /home/goodluck/work/rshare/readingbooks/public/
</span><span class='line'>      RailsEnv development
</span><span class='line'>      <span class="nt">&lt;Directory</span> <span class="err">/home/goodluck/work/rshare/readingbooks/public</span><span class="nt">/ &gt;</span>
</span><span class='line'>         # This relaxes Apache security settings.
</span><span class='line'>         AllowOverride all
</span><span class='line'>         # MultiViews must be turned off.
</span><span class='line'>         Options -MultiViews
</span><span class='line'>      <span class="nt">&lt;/Directory&gt;</span>
</span><span class='line'> <span class="nt">&lt;/VirtualHost&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>/home/goodluck/work/rshare/readingbooks/public/</code>  development  <code>RailsEnv development</code> </p>

<p>Done !</p>

<p>Thanks for your reading and welcome your comments. Drop email to <em>zhibinwang.q@gmail.com</em> to contact me.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Android sendOrderedBroadcast]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/11/07/sendorderedbroadcast/"/>
    <updated>2013-11-07T18:17:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/11/07/sendorderedbroadcast</id>
    <content type="html"><![CDATA[<p> monkey  sendOrderedBroadcast fail </p>

<!--more-->


<p></p>

<p> log </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Shutting down VM
</span><span class='line'>07-04 06:11:24.319 W/dalvikvm(23361): threadid=1: thread exiting with uncaught exception (group=0x415a8898)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937): Failure sending broadcast Intent { act=android.intent.action.QUERY_PACKAGE_RESTART dat=package:com.cootek.smartinputv5.language.cangjie flg=0x10 (has extras) }
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937): android.os.DeadObjectException
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.os.BinderProxy.transact(Native Method)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.content.IIntentReceiver$Stub$Proxy.performReceive(IIntentReceiver.java:124)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at com.android.server.am.BroadcastQueue.performReceiveLocked(BroadcastQueue.java:376)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at com.android.server.am.BroadcastQueue.deliverToRegisteredReceiverLocked(BroadcastQueue.java:449)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at com.android.server.am.BroadcastQueue.processNextBroadcast(BroadcastQueue.java:656)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at com.android.server.am.ActivityManagerService.finishReceiver(ActivityManagerService.java:12451)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.content.BroadcastReceiver$PendingResult.sendFinished(BroadcastReceiver.java:419)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.content.BroadcastReceiver$PendingResult.finish(BroadcastReceiver.java:395)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.app.LoadedApk$ReceiverDispatcher$Args.run(LoadedApk.java:780)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.os.Handler.handleCallback(Handler.java:730)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.os.Handler.dispatchMessage(Handler.java:92)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at android.os.Looper.loop(Looper.java:137)
</span><span class='line'>07-04 06:11:24.319 W/BroadcastQueue(  937):   at com.android.server.ServerThread.run(SystemServer.java:1066)
</span><span class='line'>
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361): FATAL EXCEPTION: main
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361): java.lang.RuntimeException: Error receiving broadcast Intent { act=android.intent.action.QUERY_PACKAGE_RESTART dat=package:com.cootek.smartinputv5.language.cangjie flg=0x10 (has extras) } in com.android.settings.applications.InstalledAppDetails$2@42070e38
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at android.app.LoadedApk$ReceiverDispatcher$Args.run(LoadedApk.java:773)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at android.os.Handler.handleCallback(Handler.java:730)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at android.os.Handler.dispatchMessage(Handler.java:92)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at android.os.Looper.loop(Looper.java:137)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at android.app.ActivityThread.main(ActivityThread.java:5136)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at java.lang.reflect.Method.invokeNative(Native Method)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at java.lang.reflect.Method.invoke(Method.java:525)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:737)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:553)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at dalvik.system.NativeStart.main(Native Method)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361): Caused by: java.lang.NullPointerException
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at com.android.settings.applications.InstalledAppDetails$2.onReceive(InstalledAppDetails.java:1225)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   at android.app.LoadedApk$ReceiverDispatcher$Args.run(LoadedApk.java:763)
</span><span class='line'>07-04 06:11:24.329 E/AndroidRuntime(23361):   ... 9 more
</span><span class='line'>07-04 06:11:24.329 I/ActivityManager(  937): Notify an ApplicationCrash</span></code></pre></td></tr></table></div></figure>


<p>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">1218</span>     <span class="kd">private</span> <span class="kd">final</span> <span class="n">BroadcastReceiver</span> <span class="n">mCheckKillProcessesReceiver</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BroadcastReceiver</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="mi">1219</span>         <span class="nd">@Override</span>
</span><span class='line'><span class="mi">1220</span>         <span class="kd">public</span> <span class="kt">void</span> <span class="n">onReceive</span><span class="o">(</span><span class="n">Context</span> <span class="n">context</span><span class="o">,</span> <span class="n">Intent</span> <span class="n">intent</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="mi">1221</span>             <span class="n">updateForceStopButton</span><span class="o">(</span><span class="n">getResultCode</span><span class="o">()</span> <span class="o">!=</span> <span class="n">Activity</span><span class="o">.</span><span class="na">RESULT_CANCELED</span><span class="o">);</span>
</span><span class='line'><span class="mi">1222</span>
</span><span class='line'><span class="mi">1223</span>             <span class="n">Intent</span> <span class="n">i</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Intent</span><span class="o">(</span><span class="s">&quot;qualcomm.android.LEDFlashlight.processKilled&quot;</span><span class="o">);</span>
</span><span class='line'><span class="mi">1224</span>             <span class="n">i</span><span class="o">.</span><span class="na">putExtra</span><span class="o">(</span><span class="n">Intent</span><span class="o">.</span><span class="na">EXTRA_PACKAGES</span><span class="o">,</span> <span class="n">mAppEntry</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">packageName</span><span class="o">);</span>
</span><span class='line'><span class="mi">1225</span>             <span class="n">getActivity</span><span class="o">().</span><span class="na">sendStickyBroadcast</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span><span class='line'><span class="mi">1226</span>         <span class="o">}</span>
</span><span class='line'><span class="mi">1227</span>     <span class="o">};</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>NullPointerException</code>  <code>getActivity</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">1225</span>             <span class="n">getActivity</span><span class="o">().</span><span class="na">sendStickyBroadcast</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p><a href="http://stackoverflow.com/">Stack Overflow</a>  <a href="http://stackoverflow.com/questions/12934990/deadobjectexception-when-trying-to-use-context-sendorderedbroadcast"></a> :</p>

<blockquote><p>I can see this happening if the component that called sendOrderedBroadcast() was destroyed prior to the broadcast winding its way back to the supplied instance of the BroadcastReceiver anonymous subclass.</p></blockquote>

<p> <code>sendOrderedBroadcast()</code>  <code>broadcast</code>  mCheckKillProcessesReceiver   destroy </p>

<p></p>

<ol>
<li> component  destroy  Android  intent  component  destroy </li>
<li>  Context </li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ Disqus ]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/11/06/using-disqus-api/"/>
    <updated>2013-11-06T16:59:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/11/06/using-disqus-api</id>
    <content type="html"><![CDATA[<p> <a href="https://github.com/SteveVallay/rshare">Rails app</a>  <a href="http://octopress.org/">Octopress</a>  <a href="http://disqus.com/">Disqus</a>  Comments  blog  <a href="http://disqus.com/">Disqus</a>  <a href="http://disqus.com/">Disqus</a>  api.</p>

<!-- more -->


<h3></h3>

<p> <a href="https://github.com/SteveVallay/rshare">Disqus</a>   <a href="https://disqus.com/profile/signup/"></a> </p>

<h3>Add Disqus to your site</h3>

<p> <a href="http://disqus.com/admin/create/">Add Disqus to your site</a>,  site profile ,
 site name, admin url, category   Finish registration 
<strong>Choose your platform</strong>  <strong>Universal Code</strong>() </p>

<p>Disqus  site </p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>&lt;div id="disqus_thread"&gt;&lt;/div&gt;
</span><span class='line'>&lt;script type="text/javascript"&gt;
</span><span class='line'>    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
</span><span class='line'>    var disqus_shortname = 'yoursitename'; // required: replace example with your forum shortname
</span><span class='line'>
</span><span class='line'>    /* * * DON'T EDIT BELOW THIS LINE * * */
</span><span class='line'>    (function() {
</span><span class='line'>        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
</span><span class='line'>        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
</span><span class='line'>        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
</span><span class='line'>    })();
</span><span class='line'>&lt;/script&gt;
</span><span class='line'>&lt;noscript&gt;Please enable JavaScript to view the &lt;a href="http://disqus.com/?ref_noscript"&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
</span><span class='line'>&lt;a href="http://disqus.com" class="dsq-brlink"&gt;comments powered by &lt;span class="logo-disqus"&gt;Disqus&lt;/span&gt;&lt;/a&gt;</span></code></pre></td></tr></table></div></figure>


<p> <code>js</code> <a href="http://help.disqus.com/customer/portal/articles/565624-tightening-your-disqus-integration"></a></p>

<p>:</p>

<p><img src="http://SteveVallay.github.io/images/blog/disqus.png" alt="my app" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[learn rails i18n]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/11/05/learn-rails-i18n/"/>
    <updated>2013-11-05T17:56:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/11/05/learn-rails-i18n</id>
    <content type="html"><![CDATA[<p> Rails  app </p>

<!--more -->


<p> <a href="http://railscasts.com/episodes/138-i18n?autoplay=true">Railscasts </a>  <a href="http://guides.rubyonrails.org/i18n.html">Rails Guide</a>. </p>

<p> Android  res   string, string-zh, string-en, string-fr  string-zh  string-zh </p>

<p>Rails  config/locales  en.yml  Rails app </p>

<h3></h3>

<p> config/locales  copy en.yml   zh.yml  zh.yml  id  </p>

<p></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>zh:
</span><span class='line'>  user:
</span><span class='line'>    name: 
</span><span class='line'>    email: 
</span><span class='line'>    password: </span></code></pre></td></tr></table></div></figure>


<p> namespace , user  zh  namespace   <code>.</code>   user.name</p>

<h3> code  id</h3>

<p> code   id I18n  api  translate (t)  id </p>

<p> api  t :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;&lt;%=</span> <span class="no">Create</span> <span class="no">New</span> <span class="no">User</span> <span class="sx">%&gt;&lt;/h2&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">h2</span><span class="o">&gt;&lt;%=</span> <span class="n">t</span><span class="p">(</span><span class="s1">&#39;user.new_user_reg&#39;</span><span class="p">)</span> <span class="sx">%&gt;&lt;/h2&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3></h3>

<p>application_controller.rb  set_language </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">before_action</span> <span class="ss">:set_language</span>
</span><span class='line'>     <span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'>     <span class="k">def</span> <span class="nf">set_language</span>
</span><span class='line'>      <span class="no">I18n</span><span class="o">.</span><span class="n">locale</span> <span class="o">=</span> <span class="ss">:zh</span>
</span><span class='line'>     <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails add alert in bootstrap]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/10/28/rails-add-alert-in-bootstrap/"/>
    <updated>2013-10-28T22:12:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/10/28/rails-add-alert-in-bootstrap</id>
    <content type="html"><![CDATA[<p>, Notification  Rails  Notification  Bootstrap  <a href="http://getbootstrap.com/javascript/#alerts">Alert</a> ()</p>

<p><img src="http://SteveVallay.github.io/images/blog/alert.png" alt="alert" /></p>

<!-- more -->


<h3>Bootstrap  <code>alert</code></h3>

<p>, <code>Bootstrap</code>  , class  alert  <code>x</code> )</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-success&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-info&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-warning&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;alert alert-danger&quot;</span><span class="nt">&gt;</span>...<span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>alert-success</code> <code>alert-info</code> <code>alert-warning</code> <code>alert-danger</code> </p>

<p><img src="http://SteveVallay.github.io/images/blog/alerts.png" alt="alerts" /></p>

<h3>Rails  flash  key  Bootstrap alert  class</h3>

<p> Rails  flash flash  map   key  :error, :alert ,:notice, :success  view  flash  map </p>

<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err"></span><span class="o">&lt;</span><span class="sx">% flash.each </span><span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">msg</span><span class="o">|</span> <span class="o">-</span><span class="sx">%&gt;</span>
</span><span class='line'><span class="sx">&lt;%= content_tag :div, msg, class: key %&gt;</span>
</span><span class='line'><span class="err"></span><span class="o">&lt;</span><span class="sx">% end </span><span class="o">-%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p> flash  map  key  html  class ,  class  CSS  alert flash  key  Bootstrap  alert  class  application_helper  Github gits  ;&ndash;)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">bootstrap_class_for</span> <span class="n">flash_type</span>
</span><span class='line'>     <span class="k">case</span> <span class="n">flash_type</span>
</span><span class='line'>       <span class="k">when</span> <span class="ss">:success</span>
</span><span class='line'>         <span class="s2">&quot;alert-success&quot;</span>
</span><span class='line'>       <span class="k">when</span> <span class="ss">:error</span>
</span><span class='line'>         <span class="s2">&quot;alert-error&quot;</span>
</span><span class='line'>       <span class="k">when</span> <span class="ss">:alert</span>
</span><span class='line'>         <span class="s2">&quot;alert-block&quot;</span>
</span><span class='line'>       <span class="k">when</span> <span class="ss">:notice</span>
</span><span class='line'>         <span class="s2">&quot;alert-info&quot;</span>
</span><span class='line'>       <span class="k">else</span>
</span><span class='line'>         <span class="n">flash_type</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>     <span class="k">end</span>
</span><span class='line'>   <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>view  :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err"></span><span class="o">&lt;%=</span> <span class="n">content_tag</span> <span class="ss">:div</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="ss">class</span><span class="p">:</span> <span class="n">bootstrap_class_for</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Bootstrap alert  dismiss</h3>

<p>dismiss  <code>x</code>  bootstrap  javascript </p>

<p> alert </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="n">button</span> <span class="n">type</span><span class="o">=</span><span class="s2">&quot;button&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;close&quot;</span> <span class="n">data</span><span class="o">-</span><span class="n">dismiss</span><span class="o">=</span><span class="s2">&quot;alert&quot;</span><span class="o">&gt;&amp;</span><span class="n">times</span><span class="p">;</span><span class="o">&lt;</span><span class="sr">/button&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>application.js  bootstrap js  dismiss  js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//</span><span class="o">=</span> <span class="nb">require</span> <span class="n">bootstrap</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span><span class='line'><span class="err">$</span><span class="p">(</span><span class="s2">&quot;.alert&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alert</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>  OK  </p>

<p></p>

<p><img src="http://SteveVallay.github.io/images/blog/myalert.png" alt="myalert" /></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Rails Tutorial Learning]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/09/24/rails-tutorial-learning/"/>
    <updated>2013-09-24T05:34:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/09/24/rails-tutorial-learning</id>
    <content type="html"><![CDATA[<p> <a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book" title="online book">Ruby on Rails Tutorial</a> ,  <a href="http://rubyonrails.org/" title="official site">Ruby on Rails</a>  <a href="http://rubyonrails.org/" title="official site">Ruby on Rails</a>  <a href="http://guides.rubyonrails.org/" title="online guides">Ruby on Rails Guides</a>  <a href="http://guides.rubyonrails.org/getting_started.html" title="Get started with Rails onlnie">Get Started with Rails</a></p>

<p> <a href="http://rubyonrails.org/" title="official site">Ruby on Rails</a>  <a href="http://twitter.com">Twitter</a><code>Sign Up</code> , <code>Sign In/Out</code> , <code> tweet</code> , <code> tweet</code> , <code>Follow/unfollow  others</code> <code>Ruby on Rails</code>  <code>App</code>  <a href="http://rubyonrails.org/" title="official site">Ruby on Rails</a> , <a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book" title="online book">Ruby on Rails Tutorial</a><a href="http://ruby.railstutorial.org/ruby-on-rails-tutorial-book" title="online book"></a>(<strong>!</strong>)</p>

<!--more-->


<p></p>

<p></p>

<ul>
<li> <code>Ruby</code>  <code>Ruby Gems</code>  <code>Rails</code>  <code>Git</code> </li>
<li> <code>rails new</code>  <code>app</code>  <code>Bundle</code>  <code>rails server</code> MVC</li>
<li><code>Git/Github</code>  <a href="http://git-scm.com/">Git</a>  <a href="http://github.coms">GitHub</a> </li>
<li><code>Heroku</code> <code>app</code>  <a href="https://www.heroku.com/">Heroku</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Crational Pattern - Sigleton]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/09/23/sigleton/"/>
    <updated>2013-09-23T13:54:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/09/23/sigleton</id>
    <content type="html"><![CDATA[<p> <a href="http://octopress.org">Octopress</a>  <a href="http://enjoyhacking.com">Wordpress </a>  ;&ndash;) <code>Octopress</code>  <code>Framework</code> </p>

<ul>
<li> <code>MarkDown</code>  <code>HTML</code> </li>
<li> <a href="http://github.com">GitHub</a>, </li>
</ul>


<p></p>

<p><a href="http://stevevallay.github.io/blog/2013/08/15/blog-equals-octopress-plus-github-pages/"></a></p>

<p><a href="http://enjoyhacking.com"></a>  <code>Design Patterns</code> <code>Singleton</code> </p>

<!--more-->


<p> <a href="http://coolshell.cn/articles/8961.html"></a>, <code>Design Patterns</code> <a href="http://en.wikipedia.org/wiki/A_Pattern_Language"></a><code>GOF</code>  <code>Desgin Patterns</code>   Design Pattern </p>

<h3> <code>Singleton</code> </h3>

<p> <code>Singleton</code> </p>

<p></p>

<h3> <code>Singleton</code></h3>

<p> </p>

<p></p>

<p></p>

<p><img src="http://SteveVallay.github.io/images/blog/singl014.gif" alt="single" /></p>

<p> <code>uniqueInstance</code> ,  <code>Instance()</code><code>singletonData</code> <code>SingletonOperation</code>  <code>GetSingletonData</code> </p>

<p></p>

<p>Singleton </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'> <span class="k">class</span> <span class="nc">Singleton</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">Singleton</span><span class="o">*</span> <span class="n">Instance</span><span class="p">();</span>
</span><span class='line'>    <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>        <span class="n">Singleton</span><span class="p">();</span>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">Singleton</span><span class="o">*</span> <span class="n">_instance</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>static</code>  <code>Instance()</code>  <code>Singleton</code>
<code>protected</code> </p>

<p>Singleton </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>  <span class="n">Singleton</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">::</span><span class="n">_instance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Singleton</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">::</span><span class="n">Instance</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Singleton</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p> <code>Instance</code> </p>

<h2><code>Singleton</code> </h2>

<p> <code>Singleton</code>  <code>Instance</code>  <code>_instance</code> </p>

<p> <code>Instance()</code>  <code>Singleton</code> <code>Registry</code>  <code>Lookup</code> </p>

<p> <code>Singleton</code> :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">class</span> <span class="nc">Singleton</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">public</span><span class="o">:</span>
</span><span class='line'>        <span class="k">static</span> <span class="kt">void</span> <span class="n">Register</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="n">Singleton</span><span class="o">*</span><span class="p">);</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">Singleton</span><span class="o">*</span> <span class="n">Instance</span><span class="p">();</span>
</span><span class='line'>    <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">Singleton</span><span class="o">*</span> <span class="n">Lookup</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">Singleton</span><span class="o">*</span> <span class="n">_instance</span><span class="p">;</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">NameSingletonPair</span><span class="o">&gt;*</span> <span class="n">_registry</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Register</code>  <code>Singleton</code> ,  <code>Singleton</code>  <code>map</code>
<code>Lookup</code>  <code>Singleton</code> ()</p>

<p><code>Instance()</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">Singleton</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">::</span><span class="n">Instance</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_instance</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">singletonName</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;SINGLETON&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// user or environment supplies this at startup</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">_instance</span> <span class="o">=</span> <span class="n">Lookup</span><span class="p">(</span><span class="n">singletonName</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">// Lookup returns 0 if there&#39;s no such singleton</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_instance</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Singleton</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">static</span> <span class="n">MySingleton</span> <span class="n">theSingleton</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">MySingleton</span><span class="o">::</span><span class="n">MySingleton</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// ...</span>
</span><span class='line'>        <span class="n">Singleton</span><span class="o">::</span><span class="n">Register</span><span class="p">(</span><span class="s">&quot;MySingleton&quot;</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>android  <code>Singleton</code> </h3>

<p><em>WindowManagerGlobal.java</em></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>  <span class="kd">public</span> <span class="kd">static</span> <span class="n">WindowManagerGlobal</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">WindowManagerGlobal</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">sDefaultWindowManager</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">sDefaultWindowManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WindowManagerGlobal</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">sDefaultWindowManager</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/09/10/tomato/"/>
    <updated>2013-09-10T10:14:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/09/10/tomato</id>
    <content type="html"><![CDATA[<p><img src="http://SteveVallay.github.io/images/blog/tomato-tech.png" alt="" /></p>

<!--more-->


<p> <strong>?</strong>
</p>

<p>->->A->->Bug->->?&ndash;>->->->->->twitter->?&ndash;>fouban.fm->->?&ndash;>github->IM->IM&hellip;&ndash;>?&ndash;>->->?&ndash;>->?&ndash;>->->&hellip;&hellip;</p>

<p>QQIM</p>

<p></p>

<ul>
<li></li>
<li></li>
<li><strong></strong>()</li>
</ul>


<p>   25:&ndash;)</p>

<h3></h3>

<blockquote><p>Pomodoro Technique1992<a href="http://www.baike.com/wiki/gtd&amp;prd=button_doc_jinru">GTD</a></p>

<p>10Pomodoro </p>

<p>25541530</p>

<p>30</p>

<p>&mdash;<a href="http://www.baike.com/wiki/%E7%95%AA%E8%8C%84%E5%B7%A5%E4%BD%9C%E6%B3%95"></a></p></blockquote>

<h3></h3>

<p><strong></strong><strong></strong>, <code>Windows</code>  <code>Android</code>  <a href="http://stevevallay.github.io/tomato/">web </a> windows)  linux()  <a href="https://github.com/">Github</a> , <a href="https://github.com/AlloyTeam">Alloy Team</a>  <code>html</code>  <code>js</code>  <a href="https://github.com/SteveVallay/tomato">Fork </a> <a href="http://stevevallay.github.io/tomato/"></a></p>

<p> <code>bootstrap</code> <code>css</code> </p>

<p><img src="http://SteveVallay.github.io/images/blog/tomato.png" alt="tomato" /></p>

<h3></h3>

<ul>
<li></li>
<li></li>
<li></li>
<li> 8p/<code>half hour</code></li>
</ul>


<p>  ;&ndash;)</p>

<p> <a href="http://pomodorotechnique.com/download/pdf/ThePomodoroTechnique-CHN_v1-3.pdf"></a> ~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[using bootstrap in rails]]></title>
    <link href="http://SteveVallay.github.io/blog/2013/09/04/using-bootstrap-in-rails/"/>
    <updated>2013-09-04T12:41:00+08:00</updated>
    <id>http://SteveVallay.github.io/blog/2013/09/04/using-bootstrap-in-rails</id>
    <content type="html"><![CDATA[<p> <code>rails</code>  <code>rails 4.0</code>   <code>rails</code> <code>app</code>  <a href="http://getbootstrap.com/" title="home page">Bootstrap</a> ,  <code>Ruby on Rails tutorial 2nd edition En</code></p>

<!-- more -->


<h2>Step 1   <a href="https://github.com/thomas-mcdonald/bootstrap-sass" title="github">bootstrap-sass</a>  <strong>Gemfile</strong></h2>

<p> <strong>Gemfile</strong> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Use bootstrap</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;bootstrap-sass&#39;</span><span class="p">,</span><span class="s1">&#39;~&gt;2.3.2&#39;</span> <span class="c1">#tutorial 2.0.0</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Step 2 </h2>

<p></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">bundle</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Step 3  <code>custom.css.scss</code></h2>

<p> <code>custom.css.scss</code> </p>

<p><strong>app/assets/stylesheets/custom.css.scss</strong></p>

<p> <strong>app/assets/stylesheets</strong>  <strong>application.css</strong> <code>include</code></p>

<p> bootstrap CSS  <code>custom.css.scss</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>custom.css.sass</code><code>custom</code> </p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="k">@import</span> <span class="s2">&quot;bootstrap&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c">/*universal*/</span>
</span><span class='line'>
</span><span class='line'><span class="nt">html</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">overflow-y</span><span class="o">:</span><span class="k">scroll</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">padding-top</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'>        <span class="k">padding-left</span><span class="o">:</span> <span class="m">10px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>

]]></content>
  </entry>
  
</feed>
