
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Android 启动流程 - Zhibin's blog</title>
  <meta name="author" content="zhibin">

  
  <meta name="description" content="android startup process">
  <meta name="keywords" content="android,startup，Zygote,init,system server，Android 启动流程">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://SteveVallay.github.io/blog/2014/01/09/android-start-process">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Zhibin's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39252101-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Zhibin's blog</a></h1>
  
    <h2>always smile :-)</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:SteveVallay.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Android 启动流程</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-09T14:23:00+08:00" pubdate data-updated="true">Jan 9<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>保持你的好奇心和创造力。</p>

<!--more-->


<p>早就好奇， Android 启动的流程是怎样的，正好有时间好好看一下。</p>

<p>在追溯代码之前，先让我们提出几个问题，Andorid 启动过程中需要完成什么任务？然后，站在设计者的角度，想一想，如果是你来设计，你会怎么做？</p>

<ol>
<li>系统服务什么形式存在？如何启动？</li>
<li>系统服务如何为应用提供服务？</li>
<li>应用如何被启动，应用之间如何交互？</li>
<li>应用如何安装/升级？</li>
<li>权限如何控制？</li>
</ol>


<p>暂时想到这些问题，没有细节到具体的模块(如 Telephony,Multimedia 等).下面，来揭开 Android 启动之谜.</p>

<h2>Power 键  到 User Space</h2>

<p>按下 Power 键的时候，系统加电，触发 bootloader (代码见 bootable/),bootloader 载入内存，bootloader 引导 kernel, kernel 启动，kernel 启动用户空间的 init 进程。</p>

<p>这部分还不是很熟悉，这里不做详解。:&ndash;)</p>

<h2>Init 进程</h2>

<p>init 进程是内核启动后调用的第一个用户空间的程序，从 init 开始，系统开始进入用户空间。</p>

<p>init 是一个二进制文件，代码在: <strong>system/core/init/init.c</strong></p>

<p>打开 init.c （kitkat)，找到 <code>main</code> 函数,来看看 init 主要做了哪些工作（&hellip;表示省略部分代码)：</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="cm">/*清除 umask*/</span>
</span><span class='line'>    <span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*创建目录，挂载文件系统*/</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/dev&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/proc&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/sys&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;tmpfs&quot;</span><span class="p">,</span> <span class="s">&quot;/dev&quot;</span><span class="p">,</span> <span class="s">&quot;tmpfs&quot;</span><span class="p">,</span> <span class="n">MS_NOSUID</span><span class="p">,</span> <span class="s">&quot;mode=0755&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/dev/pts&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mkdir</span><span class="p">(</span><span class="s">&quot;/dev/socket&quot;</span><span class="p">,</span> <span class="mo">0755</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;devpts&quot;</span><span class="p">,</span> <span class="s">&quot;/dev/pts&quot;</span><span class="p">,</span> <span class="s">&quot;devpts&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="s">&quot;/proc&quot;</span><span class="p">,</span> <span class="s">&quot;proc&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">mount</span><span class="p">(</span><span class="s">&quot;sysfs&quot;</span><span class="p">,</span> <span class="s">&quot;/sys&quot;</span><span class="p">,</span> <span class="s">&quot;sysfs&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*猜猜这句是干什么？很有意思 哈哈！*/</span>
</span><span class='line'>    <span class="n">close</span><span class="p">(</span><span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/.booting&quot;</span><span class="p">,</span> <span class="n">O_WRONLY</span> <span class="o">|</span> <span class="n">O_CREAT</span><span class="p">,</span> <span class="mo">0000</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*打开 /dev/null 并将 0,1,2 重定向到 /dev/null*/</span>
</span><span class='line'>    <span class="n">open_devnull_stdio</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">klog_init</span><span class="p">();</span>
</span><span class='line'>    <span class="cm">/*初始化 property 详见[android properties][101]*/</span>
</span><span class='line'>    <span class="n">property_init</span><span class="p">();</span>
</span><span class='line'>    <span class="n">get_hardware_name</span><span class="p">(</span><span class="n">hardware</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">revision</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">process_kernel_cmdline</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*selinux 相关*/</span>
</span><span class='line'>    <span class="k">union</span> <span class="n">selinux_callback</span> <span class="n">cb</span><span class="p">;</span>
</span><span class='line'>    <span class="n">cb</span><span class="p">.</span><span class="n">func_log</span> <span class="o">=</span> <span class="n">klog_write</span><span class="p">;</span>
</span><span class='line'>    <span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_LOG</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">cb</span><span class="p">.</span><span class="n">func_audit</span> <span class="o">=</span> <span class="n">audit_callback</span><span class="p">;</span>
</span><span class='line'>    <span class="n">selinux_set_callback</span><span class="p">(</span><span class="n">SELINUX_CB_AUDIT</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">selinux_initialize</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">restorecon</span><span class="p">(</span><span class="s">&quot;/dev&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">restorecon</span><span class="p">(</span><span class="s">&quot;/dev/socket&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">restorecon</span><span class="p">(</span><span class="s">&quot;/dev/__properties__&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">restorecon_recursive</span><span class="p">(</span><span class="s">&quot;/sys&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*load 默认的properties*/</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_charger</span><span class="p">)</span>
</span><span class='line'>        <span class="n">property_load_boot_defaults</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*init 的主要工作之一:解析 init.rc */</span>
</span><span class='line'>    <span class="n">INFO</span><span class="p">(</span><span class="s">&quot;reading config file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">init_parse_config_file</span><span class="p">(</span><span class="s">&quot;/init.rc&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*action_for_each_trigger 和 queue_builtin_action 将 action/command 都是加入到 command 队列里面，等待合适的时机执行*/</span>
</span><span class='line'>    <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">wait_for_coldboot_done_action</span><span class="p">,</span> <span class="s">&quot;wait_for_coldboot_done&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">mix_hwrng_into_linux_rng_action</span><span class="p">,</span> <span class="s">&quot;mix_hwrng_into_linux_rng&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">keychord_init_action</span><span class="p">,</span> <span class="s">&quot;keychord_init&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">console_init_action</span><span class="p">,</span> <span class="s">&quot;console_init&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* execute all the boot actions to get us started */</span>
</span><span class='line'>    <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_charger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;post-fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;post-fs-data&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">mix_hwrng_into_linux_rng_action</span><span class="p">,</span> <span class="s">&quot;mix_hwrng_into_linux_rng&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">property_service_init_action</span><span class="p">,</span> <span class="s">&quot;property_service_init&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">signal_init_action</span><span class="p">,</span> <span class="s">&quot;signal_init&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">check_startup_action</span><span class="p">,</span> <span class="s">&quot;check_startup&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">is_charger</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;charger&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-boot&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>        <span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;boot&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* run all property triggers based on current state of the properties */</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">queue_property_triggers_action</span><span class="p">,</span> <span class="s">&quot;queue_property_triggers&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#if BOOTCHART</span>
</span><span class='line'>    <span class="n">queue_builtin_action</span><span class="p">(</span><span class="n">bootchart_init_action</span><span class="p">,</span> <span class="s">&quot;bootchart_init&quot;</span><span class="p">);</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*解析完 init.rc 之后到此的这一段，好像都是在想队列里面添加 action/command*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*什么时候来执行呢？下面！*/</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/*init 最后进入了一个无限循环，不会主动退出！*/</span>
</span><span class='line'>    <span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*执行command 队列里面的一条命令!*/</span>
</span><span class='line'>        <span class="n">execute_one_command</span><span class="p">();</span>
</span><span class='line'>        <span class="n">restart_processes</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*添加property fd (socket） 到 ufds */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">property_set_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_property_set_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_property_set_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">property_set_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*添加 signal fd 到 ufds*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signal_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_signal_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_signal_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">signal_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*添加 keychord ?fd 到 ufds*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">keychord_fd_init</span> <span class="o">&amp;&amp;</span> <span class="n">get_keychord_fd</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">fd</span> <span class="o">=</span> <span class="n">get_keychord_fd</span><span class="p">();</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
</span><span class='line'>            <span class="n">ufds</span><span class="p">[</span><span class="n">fd_count</span><span class="p">].</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="n">fd_count</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>            <span class="n">keychord_fd_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*计算进程restart 时间*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">process_needs_restart</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">process_needs_restart</span> <span class="o">-</span> <span class="n">gettime</span><span class="p">())</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action_queue_empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">cur_action</span><span class="p">)</span>
</span><span class='line'>            <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#if BOOTCHART</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">bootchart_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">timeout</span> <span class="o">&gt;</span> <span class="n">BOOTCHART_POLLING_MS</span><span class="p">)</span>
</span><span class='line'>                <span class="n">timeout</span> <span class="o">=</span> <span class="n">BOOTCHART_POLLING_MS</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">bootchart_step</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">--</span><span class="n">bootchart_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">bootchart_finish</span><span class="p">();</span>
</span><span class='line'>                <span class="n">bootchart_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*poll出 ufds 的事件，等待 timeout 时间*/</span>
</span><span class='line'>        <span class="n">nr</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">ufds</span><span class="p">,</span> <span class="n">fd_count</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">nr</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>            <span class="k">continue</span><span class="p">;</span>
</span><span class='line'>       <span class="cm">/*处理 ufds 事件!(property set , signal,keychord?)*/</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">==</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_property_set_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_property_set_fd</span><span class="p">();</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_keychord_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_keychord</span><span class="p">();</span>
</span><span class='line'>                <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ufds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">==</span> <span class="n">get_signal_fd</span><span class="p">())</span>
</span><span class='line'>                    <span class="n">handle_signal</span><span class="p">();</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>代码看下来，可以看出来，init 的主要工作就是:</p>

<ol>
<li>解析 init.rc 文件并执行相应的 action/commands.</li>
<li>作为一个 Daemon 进程处理 property_set,keychord(key combo） 和 signal 事件。</li>
</ol>


<p>init.rc 的解析过程略过，详情请见 system/core/init/init_parser.c</p>

<p>下面来看看 init.rc 里面究竟干了些什么？</p>

<figure class='code'><figcaption><span>system/core/rootdir/init.rc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#导入其他 rc 文件</span>
</span><span class='line'>import /init.environ.rc
</span><span class='line'>import /init.usb.rc
</span><span class='line'>import /init.<span class="k">${</span><span class="nv">ro</span><span class="p">.hardware</span><span class="k">}</span>.rc  <span class="c">#这里保留了导入特定平台相关 rc 的接口,这里可能导入很多东西！</span>
</span><span class='line'>import /init.trace.rc
</span><span class='line'>
</span><span class='line'><span class="c">#early-init 要处理的事情</span>
</span><span class='line'>on early-init
</span><span class='line'>    <span class="c"># Set init and its forked children&#39;s oom_adj.</span>
</span><span class='line'>    write /proc/1/oom_adj -16
</span><span class='line'>
</span><span class='line'>    <span class="c"># Set the security context for the init process.</span>
</span><span class='line'>    <span class="c"># This should occur before anything else (e.g. ueventd) is started.</span>
</span><span class='line'>    setcon u:r:init:s0
</span><span class='line'>
</span><span class='line'>    start ueventd
</span><span class='line'>
</span><span class='line'><span class="c"># create mountpoints</span>
</span><span class='line'>    mkdir /mnt 0775 root system
</span><span class='line'>
</span><span class='line'><span class="c">#init 要处理的事情</span>
</span><span class='line'>on init
</span><span class='line'>
</span><span class='line'>sysclktz 0
</span><span class='line'>
</span><span class='line'>loglevel 3
</span><span class='line'>
</span><span class='line'><span class="c"># Backward compatibility</span>
</span><span class='line'>    symlink /system/etc /etc
</span><span class='line'>    symlink /sys/kernel/debug /d
</span><span class='line'>
</span><span class='line'><span class="c"># Right now vendor lives on the same filesystem as system,</span>
</span><span class='line'><span class="c"># but someday that may change.</span>
</span><span class='line'>    symlink /system/vendor /vendor
</span><span class='line'>
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>
</span><span class='line'>on post-fs
</span><span class='line'>    <span class="c"># once everything is setup, no need to modify /</span>
</span><span class='line'>    mount rootfs rootfs / ro remount
</span><span class='line'>    <span class="c"># mount shared so changes propagate into child namespaces</span>
</span><span class='line'>    mount rootfs rootfs / shared rec
</span><span class='line'>    mount tmpfs tmpfs /mnt/secure private rec
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>
</span><span class='line'>on post-fs-data
</span><span class='line'>    <span class="c"># We chown/chmod /data again so because mount is run as root + defaults</span>
</span><span class='line'>    chown system system /data
</span><span class='line'>    chmod 0771 /data
</span><span class='line'>    <span class="c"># We restorecon /data in case the userdata partition has been reset.</span>
</span><span class='line'>    restorecon /data
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>
</span><span class='line'>on boot
</span><span class='line'><span class="c"># basic network init</span>
</span><span class='line'>    ifup lo
</span><span class='line'>    hostname localhost
</span><span class='line'>    domainname localdomain
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>
</span><span class='line'><span class="c">#这两句重要！！</span>
</span><span class='line'>    class_start core
</span><span class='line'>    class_start main
</span><span class='line'>
</span><span class='line'>on nonencrypted
</span><span class='line'>    class_start late_start
</span><span class='line'>
</span><span class='line'>on charger
</span><span class='line'>    class_start charger
</span><span class='line'>
</span><span class='line'>on property:vold.decrypt<span class="o">=</span>trigger_reset_main
</span><span class='line'>    class_reset main
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>
</span><span class='line'>service console /system/bin/sh
</span><span class='line'>    class core
</span><span class='line'>    console
</span><span class='line'>    disabled
</span><span class='line'>    user shell
</span><span class='line'>    group log
</span><span class='line'>
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>
</span><span class='line'>service servicemanager /system/bin/servicemanager
</span><span class='line'>    class core
</span><span class='line'>    user system
</span><span class='line'>    group system
</span><span class='line'>    critical
</span><span class='line'>    onrestart restart healthd
</span><span class='line'>    onrestart restart zygote
</span><span class='line'>    onrestart restart media
</span><span class='line'>    onrestart restart surfaceflinger
</span><span class='line'>    onrestart restart drm
</span><span class='line'><span class="c">#...省略部分代码</span>
</span><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>    class main
</span><span class='line'>    socket zygote stream 660 root system
</span><span class='line'>    onrestart write /sys/android_power/request_state wake
</span><span class='line'>    onrestart write /sys/power/state on
</span><span class='line'>    onrestart restart media
</span><span class='line'>    onrestart restart netd
</span></code></pre></td></tr></table></div></figure>


<p>虽然 ini.rc 里面这么多内容，但是你仔细观察就会发现，这里面只有两种模式：</p>

<ul>
<li>第一种 trigger 触发</li>
</ul>


<figure class='code'><figcaption><span>system/core/rootdir/init.rc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>on trigger
</span><span class='line'>   ...
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>第二种 service</li>
</ul>


<figure class='code'><figcaption><span>system/core/rootdir/init.rc</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>service ...
</span><span class='line'>   ...
</span></code></pre></td></tr></table></div></figure>


<p><code>on xxxx</code> 这种是基于某个事件触发， init.rc 里面列举的有</p>

<ul>
<li>on early-init</li>
<li>on init</li>
<li>on post-fs</li>
<li>on boot</li>
<li>on nonencrypted</li>
<li>on charger</li>
<li>on property:key=value</li>
</ul>


<p>你一定会奇怪，这些 trigger 是如何定义的，在什么时间点触发？ 其实这些 trigger 没有定义，触发的顺序由 init.c 里面添加它们到 action queue 的顺序决定。</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;init&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'><span class="n">action_for_each_trigger</span><span class="p">(</span><span class="s">&quot;early-fs&quot;</span><span class="p">,</span> <span class="n">action_add_queue_tail</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>在 init.c 中以合适的顺序添加到 action queue 里面之后，在 init.c 最后依次从 action queue 中取出这些 action,顺序执行。</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">execute_one_command</span><span class="p">();</span>  <span class="c1">//这里取出 action 来执行。</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>on property</code> 例外，这个是在 set property 之后，查询有没有相关的 action，如果有的话添加到 action queue , 等待取出来执行。</p>

<p>那么 service 是如何启动的呢？service 并没有像 trigger 一样的方式进入 action queue.仔细观察一下 service 里面的 option 就会发现，每个 service 都有一个 class.</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">service</span> <span class="n">ueventd</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">ueventd</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">core</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">servicemanager</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">servicemanager</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">core</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">healthd</span><span class="o">-</span><span class="n">charger</span> <span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">healthd</span> <span class="o">-</span><span class="n">n</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">charger</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">netd</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">netd</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">main</span>
</span><span class='line'>
</span><span class='line'><span class="n">service</span> <span class="n">zygote</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">app_process</span> <span class="o">-</span><span class="n">Xzygote</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">bin</span> <span class="o">--</span><span class="n">zygote</span> <span class="o">--</span><span class="n">start</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">server</span>
</span><span class='line'>    <span class="n">class</span> <span class="n">main</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个 class 指的就是 service 的类别， service 不是像 trigger 一样，通过名字来查找，而是通过类别来一起启动的。</p>

<p>在 <code>on boot</code>，可以看到:</p>

<figure class='code'><figcaption><span>system/core/init/init.c</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">on</span> <span class="n">boot</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">class_start</span> <span class="n">core</span>
</span><span class='line'>    <span class="n">class_start</span> <span class="n">main</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>core</code> 和 <code>main</code> 类别的 service 在 <code>on boot</code> 的时候被一起启动了.</p>

<p>通过上面的分析，可以看得出来，虽然 init.rc 里面的内容很多，但还是很容易理解的：</p>

<ul>
<li>on xxx 是在 init.c 里面通过 xxx 关键字进入 action 队列并顺序执行的。</li>
<li>service xxx 是以 <code>class xxx</code> 分类的，一类在一起进入队列并执行的， core 和 main 类别的 service 是 on boot 的时候一起执行的。</li>
</ul>


<p>OK, 看得出来，其实那些 service 并没有什么特别的，都是 init 启动的而已。</p>

<p>那么，Android 是如何从 Native 切换到 Java 世界的呢？这依赖于 init.rc 里面启动的一个重要 service  &mdash; zygote</p>

<p>zygote 是在 init.rc 中被定义为一个 service ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>    class main
</span><span class='line'>    socket zygote stream 660 root system
</span><span class='line'>    onrestart write /sys/android_power/request_state wake
</span><span class='line'>    onrestart write /sys/power/state on
</span><span class='line'>    onrestart restart media
</span><span class='line'>    onrestart restart netd
</span></code></pre></td></tr></table></div></figure>


<p>name = <code>zygote</code>
path = <code>/system/bin/app_process</code>
arguments = <code>-Xzygote /system/bin --zygote --start-system-server</code></p>

<p>zygote 这个 service 在启动的时候实际上是执行了 /system/bin/app_process 这个二进制文件 , 这个文件的源码在:</p>

<p><code>frameworks/base/cmds/app_process/app_main.cpp</code></p>

<figure class='code'><figcaption><span>frameworks/base/cmds/app_process/app_main.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="k">const</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">//-Xzygote 传给 Vm</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">runtime</span><span class="p">.</span><span class="n">addVmArguments</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">//其他参数解析</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">arg</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parentDir</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">parentDir</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--zygote&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">zygote</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>            <span class="n">niceName</span> <span class="o">=</span> <span class="s">&quot;zygote&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--start-system-server&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">startSystemServer</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--application&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">application</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;--nice-name=&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">niceName</span> <span class="o">=</span> <span class="n">arg</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">className</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="c1">// call runtime.start 并 传了两个参数</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">zygote</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">runtime</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="s">&quot;com.android.internal.os.ZygoteInit&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="n">startSystemServer</span> <span class="o">?</span> <span class="s">&quot;start-system-server&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在最后调用了 <code>runtime</code> 的 start 方法并传入了 <code>com.android.internal.os.ZygoteInit</code> 和 <code>start-system-server</code> 两个参数。</p>

<p><code>runtime</code> 是 <code>AppRuntime</code> 的实例， <code>start</code> 是继承自基类 <code>AndroidRuntime</code> 的方法。</p>

<figure class='code'><figcaption><span>frameworks/core/jni/AndroidRuntime.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm"> * Start the Android runtime.  This involves starting the virtual machine</span>
</span><span class='line'><span class="cm"> * and calling the &quot;static void main(String[] args)&quot; method in the class</span>
</span><span class='line'><span class="cm"> * named by &quot;className&quot;.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * Passes the main function two arguments, the class name and the specified</span>
</span><span class='line'><span class="cm"> * options string.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kt">void</span> <span class="n">AndroidRuntime</span><span class="o">::</span><span class="n">start</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">className</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">options</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>     <span class="k">if</span> <span class="p">(</span><span class="n">startVm</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mJavaVM</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">env</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">onVmCreated</span><span class="p">(</span><span class="n">env</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">strArray</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewObjectArray</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">stringClass</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">strArray</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">classNameStr</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">classNameStr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">SetObjectArrayElement</span><span class="p">(</span><span class="n">strArray</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">classNameStr</span><span class="p">);</span>
</span><span class='line'>    <span class="n">optionsStr</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">NewStringUTF</span><span class="p">(</span><span class="n">options</span><span class="p">);</span>
</span><span class='line'>    <span class="n">env</span><span class="o">-&gt;</span><span class="n">SetObjectArrayElement</span><span class="p">(</span><span class="n">strArray</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">optionsStr</span><span class="p">);</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="cm">/*</span>
</span><span class='line'><span class="cm">     * Start VM.  This thread becomes the main thread of the VM, and will</span>
</span><span class='line'><span class="cm">     * not return until the VM exits.</span>
</span><span class='line'><span class="cm">     */</span>
</span><span class='line'>    <span class="kt">char</span><span class="o">*</span> <span class="n">slashClassName</span> <span class="o">=</span> <span class="n">toSlashClassName</span><span class="p">(</span><span class="n">className</span><span class="p">);</span>
</span><span class='line'>    <span class="n">jclass</span> <span class="n">startClass</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">FindClass</span><span class="p">(</span><span class="n">slashClassName</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">startClass</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;JavaVM unable to locate class &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slashClassName</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* keep going */</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">jmethodID</span> <span class="n">startMeth</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">GetStaticMethodID</span><span class="p">(</span><span class="n">startClass</span><span class="p">,</span> <span class="s">&quot;main&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="s">&quot;([Ljava/lang/String;)V&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">startMeth</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;JavaVM unable to find main() in &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">className</span><span class="p">);</span>
</span><span class='line'>            <span class="cm">/* keep going */</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">env</span><span class="o">-&gt;</span><span class="n">CallStaticVoidMethod</span><span class="p">(</span><span class="n">startClass</span><span class="p">,</span> <span class="n">startMeth</span><span class="p">,</span> <span class="n">strArray</span><span class="p">);</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>调用 <code>start</code> 的时候传递了两个参数 <code>com.android.internal.os.ZygoteInit</code> , <code>start-system-server</code>,对应 <code>start</code> 的两个形参 <code>className</code> 和 <code>options</code>。在 <code>start</code> 里面，可以看到，先是 启动了 VM , 然后将两个参数放到 VM 的 env 里面，在然后，找到 <code>com.android.internal.os.ZygoteInit</code> 并调用其  <code>main</code> 方法 !</p>

<p>哈哈！ 终于开启了 java 世界！ 来看看 <code>ZygoteInit</code> 干了些什么?</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>            <span class="n">registerZygoteSocket</span><span class="o">();</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;start-system-server&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">startSystemServer</span><span class="o">();</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(!</span><span class="n">argv</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">argv</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+</span> <span class="n">USAGE_STRING</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>            <span class="n">runSelectLoop</span><span class="o">();</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>ZygoteInit</code> 的 <code>main</code> 里面做了三件事 :</p>

<ol>
<li>注册 zygote socket</li>
<li>启动 system server</li>
<li>无限循环监听 zygote socket 消息。</li>
</ol>


<p>在 init 启动 zygote 的时候创建了一个 socket &ndash; <code>/dev/socket/zygote</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>service zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server
</span><span class='line'>    class main
</span><span class='line'>    socket zygote stream 660 root system
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p><code>registerZygoteSocket</code> 就是用这个 socket 的 fd 创建了一个 Server socket , 用来接收 client 发来的消息。</p>

<p>然后调用，<code>startSystemServer()</code> 来启动 system server 进程。</p>

<figure class='code'><figcaption><span>ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Prepare the arguments and fork for the system server process.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">boolean</span> <span class="nf">startSystemServer</span><span class="o">()</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">MethodAndArgsCaller</span><span class="o">,</span> <span class="n">RuntimeException</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>    <span class="cm">/* Hardcoded command line to start the system server */</span>
</span><span class='line'>    <span class="n">String</span> <span class="n">args</span><span class="o">[]</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>        <span class="s">&quot;--setuid=1000&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--setgid=1000&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--capabilities=&quot;</span> <span class="o">+</span> <span class="n">capabilities</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">capabilities</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--runtime-init&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;--nice-name=system_server&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;com.android.server.SystemServer&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="o">};</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>        <span class="cm">/* Request to fork the system server process */</span>
</span><span class='line'>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkSystemServer</span><span class="o">(</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span>
</span><span class='line'>                <span class="kc">null</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">permittedCapabilities</span><span class="o">,</span>
</span><span class='line'>                <span class="n">parsedArgs</span><span class="o">.</span><span class="na">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>    <span class="cm">/* For child process */</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">handleSystemServerProcess</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这一步，调用 <code>Zygote.forkSystemServer</code> , <code>forkSystemServer</code> 又调用了 <code>nativenativeForkSystemServer</code></p>

<figure class='code'><figcaption><span>libcore/dalvik/src/main/java/dalvik/system/Zygote.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkSystemServer</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">long</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="kt">long</span> <span class="n">effectiveCapabilities</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">preFork</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkSystemServer</span><span class="o">(</span>
</span><span class='line'>            <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">permittedCapabilities</span><span class="o">,</span> <span class="n">effectiveCapabilities</span><span class="o">);</span>
</span><span class='line'>    <span class="n">postFork</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>nativenativeForkSystemServer</code> 在 dalvik 里面</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">Dalvik_dalvik_system_Zygote_forkSystemServer</span><span class="p">(</span>
</span><span class='line'>        <span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* The zygote process checks whether the child process has died or not. */</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ALOGI</span><span class="p">(</span><span class="s">&quot;System server process %d has been created&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>        <span class="n">gDvm</span><span class="p">.</span><span class="n">systemServerPid</span> <span class="o">=</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/*如果 system server 没启动成功，zygote 会自杀!*/</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">waitpid</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">WNOHANG</span><span class="p">)</span> <span class="o">==</span> <span class="n">pid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;System server process %d has died. Restarting Zygote!&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">SIGKILL</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">RETURN_INT</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>来看看 <code>forkAndSpecializeCommon</code>:</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="n">pid_t</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isSystemServer</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">setSignalHandler</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">unsetSignalHandler</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里 fork 之前，注册了 signal 处理函数 <code>setSignalHandler</code>, 子进程里面又取消了signal 处理函数，说明这个是为父进程 zygote 注册的，来看看里面干了些啥：</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">sigchldHandler</span><span class="p">(</span><span class="kt">int</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * If the just-crashed process is the system_server, bring down zygote</span>
</span><span class='line'><span class="cm">         * so that it is restarted by init and system server will be restarted</span>
</span><span class='line'><span class="cm">         * from there.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">gDvm</span><span class="p">.</span><span class="n">systemServerPid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ALOG</span><span class="p">(</span><span class="n">LOG_INFO</span><span class="p">,</span> <span class="n">ZYGOTE_LOG_TAG</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&quot;Exit zygote because system server (%d) has terminated&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">pid</span><span class="p">);</span>
</span><span class='line'>            <span class="n">kill</span><span class="p">(</span><span class="n">getpid</span><span class="p">(),</span> <span class="n">SIGKILL</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里如果 system server 挂了， zygote 又要自杀!!</p>

<p>OK , 假设正常执行，继续回到 <code>startSystemServer</code>, 下一步， system server 和 zygote 分道扬镳了终于, system server 调用 <code>handleSystemServerProcess</code>, zygote 则调用 <code>runSelectLoop()</code>, 先看 zygote <code>runSelectLoop</code>:</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/** </span>
</span><span class='line'><span class="cm"> * Runs the zygote process&#39;s select loop. Accepts new connections as</span>
</span><span class='line'><span class="cm"> * they happen, and reads commands from connections one spawn-request&#39;s</span>
</span><span class='line'><span class="cm"> * worth at a time.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @throws MethodAndArgsCaller in a child process when a main() should</span>
</span><span class='line'><span class="cm"> * be executed.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">runSelectLoop</span><span class="p">()</span> <span class="k">throws</span> <span class="n">MethodAndArgsCaller</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">....</span>
</span><span class='line'>    <span class="k">while</span> <span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">ZygoteConnection</span> <span class="n">newPeer</span> <span class="o">=</span> <span class="n">acceptCommandPeer</span><span class="p">();</span>
</span><span class='line'>            <span class="n">peers</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newPeer</span><span class="p">);</span>
</span><span class='line'>            <span class="n">fds</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">newPeer</span><span class="p">.</span><span class="n">getFileDesciptor</span><span class="p">());</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">boolean</span> <span class="n">done</span><span class="p">;</span>
</span><span class='line'>            <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">runOnce</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>acceptCommandPeer()</code> 实际是在阻塞式的等待 client 来发起连接。</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Waits for and accepts a single command connection. Throws</span>
</span><span class='line'><span class="cm"> * RuntimeException on failure.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">private</span> <span class="k">static</span> <span class="n">ZygoteConnection</span> <span class="n">acceptCommandPeer</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="k">new</span> <span class="n">ZygoteConnection</span><span class="p">(</span><span class="n">sServerSocket</span><span class="p">.</span><span class="n">accept</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="p">(</span>
</span><span class='line'>                <span class="s">&quot;IOException during accept()&quot;</span><span class="p">,</span> <span class="n">ex</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>runOnce()</code> 则是 client 建立连接之后，读取 client 发过来的数据，并 fork 出新的进程。</p>

<figure class='code'><figcaption><span>dalvik/vm/native/dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="n">boolean</span> <span class="n">runOnce</span><span class="p">()</span> <span class="k">throws</span> <span class="n">ZygoteInit</span><span class="p">.</span><span class="n">MethodAndArgsCaller</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">args</span> <span class="o">=</span> <span class="n">readArgumentList</span><span class="p">();</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'>        <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="p">.</span><span class="n">forkAndSpecialize</span><span class="p">(</span><span class="n">parsedArgs</span><span class="p">.</span><span class="n">uid</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">gid</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">gids</span><span class="p">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="p">.</span><span class="n">debugFlags</span><span class="p">,</span> <span class="n">rlimits</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">mountExternal</span><span class="p">,</span> <span class="n">parsedArgs</span><span class="p">.</span><span class="n">seInfo</span><span class="p">,</span>
</span><span class='line'>        <span class="n">parsedArgs</span><span class="p">.</span><span class="n">niceName</span><span class="p">);</span>
</span><span class='line'>        <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>回过头来看 system server <code>handleSystemServerProcess</code>:</p>

<figure class='code'><figcaption><span>ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="cm">/** </span>
</span><span class='line'><span class="cm"> * Finish remaining work for the newly forked system server process.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'> <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">handleSystemServerProcess</span><span class="o">(</span> <span class="n">ZygoteConnection</span><span class="o">.</span><span class="na">Arguments</span> <span class="n">parsedArgs</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">RuntimeInit</span><span class="o">.</span><span class="na">zygoteInit</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">remainingArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>调用了 <code>RuntimeInit.zygoteInit</code>:</p>

<figure class='code'><figcaption><span>RuntimeInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">zygoteInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;RuntimeInit: Starting application from zygote&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//重定向 log</span>
</span><span class='line'>    <span class="n">redirectLogStreams</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//设置 timezone ,useragent 等等</span>
</span><span class='line'>    <span class="n">commonInit</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">//app_main.cpp 的 onZygoteInit, 初始化 Binder thread pool.</span>
</span><span class='line'>    <span class="n">nativeZygoteInit</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//</span>
</span><span class='line'>    <span class="n">applicationInit</span><span class="o">(</span><span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>继续 <code>applicationInit</code>,传入的 <code>startClass</code> 参数正是 &ldquo;com.android.server.SystemServer&rdquo; , 所以这里是掉到了 <code>SystemServer</code> 的 main 方法。</p>

<figure class='code'><figcaption><span>RuntimeInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">applicationInit</span><span class="o">(</span><span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="c1">// Remaining arguments are passed to the start class&#39;s static main</span>
</span><span class='line'>    <span class="n">invokeStaticMain</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">startClass</span><span class="o">,</span> <span class="n">args</span><span class="o">.</span><span class="na">startArgs</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>终于到了 SystemServer 里面来了 :</p>

<figure class='code'><figcaption><span>SystemServer.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">System</span><span class="o">.</span><span class="na">loadLibrary</span><span class="o">(</span><span class="s">&quot;android_servers&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="c1">// Initialize native services.</span>
</span><span class='line'>    <span class="n">nativeInit</span><span class="o">();</span>
</span><span class='line'>    <span class="c1">// This used to be its own separate thread, but now it is</span>
</span><span class='line'>    <span class="c1">// just the loop we run on the main thread.</span>
</span><span class='line'>    <span class="n">ServerThread</span> <span class="n">thr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerThread</span><span class="o">();</span>
</span><span class='line'>    <span class="n">thr</span><span class="o">.</span><span class="na">initAndLoop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>主要干了两件事：</p>

<ol>
<li>nativeInit</li>
<li>ServerThread 启动</li>
</ol>


<p>nativeInit 好像没干啥嘛</p>

<figure class='code'><figcaption><span>services/jni/com_android_server_SystemServer.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">android_server_SystemServer_nativeInit</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">char</span> <span class="n">propBuf</span><span class="p">[</span><span class="n">PROPERTY_VALUE_MAX</span><span class="p">];</span>
</span><span class='line'>    <span class="n">property_get</span><span class="p">(</span><span class="s">&quot;system_init.startsensorservice&quot;</span><span class="p">,</span> <span class="n">propBuf</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">propBuf</span><span class="p">,</span> <span class="s">&quot;1&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Start the sensor service</span>
</span><span class='line'>        <span class="n">SensorService</span><span class="o">::</span><span class="n">instantiate</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>ServerThread 里面内容可就多喽 ！</p>

<figure class='code'><figcaption><span>SystemServer.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">initAndLoop</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">prepareMainLooper</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//为 window manager 创建一个 handler.</span>
</span><span class='line'>    <span class="n">HandlerThread</span> <span class="n">wmHandlerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HandlerThread</span><span class="o">(</span><span class="s">&quot;WindowManager&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="n">wmHandlerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>    <span class="n">Handler</span> <span class="n">wmHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Handler</span><span class="o">(</span><span class="n">wmHandlerThread</span><span class="o">.</span><span class="na">getLooper</span><span class="o">());</span>
</span><span class='line'>    <span class="n">wmHandler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="nd">@Override</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_DISPLAY</span><span class="o">);</span>
</span><span class='line'>            <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setCanSelfBackground</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 启动 installd , Power Manager Activity Manager service.</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">onlyCore</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">firstBoot</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">installer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Installer</span><span class="o">();</span>
</span><span class='line'>        <span class="n">installer</span><span class="o">.</span><span class="na">ping</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">power</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PowerManagerService</span><span class="o">();</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">POWER_SERVICE</span><span class="o">,</span> <span class="n">power</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">context</span> <span class="o">=</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">factoryTest</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableStorage</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_storage&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableMedia</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_media&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableBluetooth</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_bluetooth&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableTelephony</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_telephony&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableLocation</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_location&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableSystemUI</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_systemui&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableNonCoreServices</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_noncore&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">disableNetwork</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">getBoolean</span><span class="o">(</span><span class="s">&quot;config.disable_network&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//各种 service add </span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">display</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DisplayManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wmHandler</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DISPLAY_SERVICE</span><span class="o">,</span> <span class="n">display</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">telephonyRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TelephonyRegistry</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;telephony.registry&quot;</span><span class="o">,</span> <span class="n">telephonyRegistry</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">android</span><span class="o">.</span><span class="na">telephony</span><span class="o">.</span><span class="na">MSimTelephonyManager</span><span class="o">.</span><span class="na">getDefault</span><span class="o">().</span><span class="na">isMultiSimEnabled</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">msimTelephonyRegistry</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MSimTelephonyRegistry</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;telephony.msim.registry&quot;</span><span class="o">,</span> <span class="n">msimTelephonyRegistry</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;scheduling_policy&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">SchedulingPolicyService</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">String</span> <span class="n">cryptState</span> <span class="o">=</span> <span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;vold.decrypt&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">ENCRYPTING_STATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cryptState</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">onlyCore</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ENCRYPTED_STATE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">cryptState</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">onlyCore</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pm</span> <span class="o">=</span> <span class="n">PackageManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">installer</span><span class="o">,</span>
</span><span class='line'>                <span class="n">factoryTest</span> <span class="o">!=</span> <span class="n">SystemServer</span><span class="o">.</span><span class="na">FACTORY_TEST_OFF</span><span class="o">,</span>
</span><span class='line'>                <span class="n">onlyCore</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">setSystemProcess</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;entropy&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">EntropyMixer</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">USER_SERVICE</span><span class="o">,</span>
</span><span class='line'>                <span class="n">UserManagerService</span><span class="o">.</span><span class="na">getInstance</span><span class="o">());</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mContentResolver</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="na">getContentResolver</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">accountManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AccountManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ACCOUNT_SERVICE</span><span class="o">,</span> <span class="n">accountManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">contentService</span> <span class="o">=</span> <span class="n">ContentService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span>
</span><span class='line'>                <span class="n">factoryTest</span> <span class="o">==</span> <span class="n">SystemServer</span><span class="o">.</span><span class="na">FACTORY_TEST_LOW_LEVEL</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">installSystemProviders</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">lights</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LightsService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">battery</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BatteryService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">lights</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;battery&quot;</span><span class="o">,</span> <span class="n">battery</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">vibrator</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VibratorService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;vibrator&quot;</span><span class="o">,</span> <span class="n">vibrator</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">consumerIr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ConsumerIrService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CONSUMER_IR_SERVICE</span><span class="o">,</span> <span class="n">consumerIr</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">power</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">lights</span><span class="o">,</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">(),</span> <span class="n">battery</span><span class="o">,</span>
</span><span class='line'>                <span class="n">BatteryStatsService</span><span class="o">.</span><span class="na">getService</span><span class="o">(),</span>
</span><span class='line'>                <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">getAppOpsService</span><span class="o">(),</span> <span class="n">display</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">alarm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AlarmManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ALARM_SERVICE</span><span class="o">,</span> <span class="n">alarm</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">battery</span><span class="o">,</span> <span class="n">power</span><span class="o">,</span> <span class="n">alarm</span><span class="o">,</span>
</span><span class='line'>                <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">());</span>
</span><span class='line'>        <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">addThread</span><span class="o">(</span><span class="n">wmHandler</span><span class="o">,</span> <span class="s">&quot;WindowManager thread&quot;</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">inputManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wmHandler</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">wm</span> <span class="o">=</span> <span class="n">WindowManagerService</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">power</span><span class="o">,</span> <span class="n">display</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">,</span>
</span><span class='line'>                <span class="n">wmHandler</span><span class="o">,</span> <span class="n">factoryTest</span> <span class="o">!=</span> <span class="n">SystemServer</span><span class="o">.</span><span class="na">FACTORY_TEST_LOW_LEVEL</span><span class="o">,</span>
</span><span class='line'>                <span class="o">!</span><span class="n">firstBoot</span><span class="o">,</span> <span class="n">onlyCore</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WINDOW_SERVICE</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INPUT_SERVICE</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">inputManager</span><span class="o">.</span><span class="na">setWindowManagerCallbacks</span><span class="o">(</span><span class="n">wm</span><span class="o">.</span><span class="na">getInputMonitor</span><span class="o">());</span>
</span><span class='line'>        <span class="n">inputManager</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">display</span><span class="o">.</span><span class="na">setWindowManager</span><span class="o">(</span><span class="n">wm</span><span class="o">);</span>
</span><span class='line'>        <span class="n">display</span><span class="o">.</span><span class="na">setInputManager</span><span class="o">(</span><span class="n">inputManager</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                <span class="n">imm</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InputMethodManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">INPUT_METHOD_SERVICE</span><span class="o">,</span> <span class="n">imm</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">ACCESSIBILITY_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">AccessibilityManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">wm</span><span class="o">.</span><span class="na">displayReady</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">pm</span><span class="o">.</span><span class="na">performBootDexOpt</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">mountService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MountService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;mount&quot;</span><span class="o">,</span> <span class="n">mountService</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">lockSettings</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LockSettingsService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;lock_settings&quot;</span><span class="o">,</span> <span class="n">lockSettings</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">devicePolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DevicePolicyManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DEVICE_POLICY_SERVICE</span><span class="o">,</span> <span class="n">devicePolicy</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableSystemUI</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">statusBar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StatusBarManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wm</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">STATUS_BAR_SERVICE</span><span class="o">,</span> <span class="n">statusBar</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">CLIPBOARD_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">ClipboardService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">networkManagement</span> <span class="o">=</span> <span class="n">NetworkManagementService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORKMANAGEMENT_SERVICE</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">tsms</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TextServicesManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">TEXT_SERVICES_MANAGER_SERVICE</span><span class="o">,</span> <span class="n">tsms</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">networkStats</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkStatsService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">,</span> <span class="n">alarm</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORK_STATS_SERVICE</span><span class="o">,</span> <span class="n">networkStats</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">networkPolicy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkPolicyManagerService</span><span class="o">(</span>
</span><span class='line'>                        <span class="n">context</span><span class="o">,</span> <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">(),</span> <span class="n">power</span><span class="o">,</span>
</span><span class='line'>                        <span class="n">networkStats</span><span class="o">,</span> <span class="n">networkManagement</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NETWORK_POLICY_SERVICE</span><span class="o">,</span> <span class="n">networkPolicy</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">wifiP2p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WifiP2pService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WIFI_P2P_SERVICE</span><span class="o">,</span> <span class="n">wifiP2p</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">wifi</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WifiService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WIFI_SERVICE</span><span class="o">,</span> <span class="n">wifi</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">serviceDiscovery</span> <span class="o">=</span> <span class="n">NsdService</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span>
</span><span class='line'>                        <span class="n">Context</span><span class="o">.</span><span class="na">NSD_SERVICE</span><span class="o">,</span> <span class="n">serviceDiscovery</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">UPDATE_LOCK_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">UpdateLockService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="cm">/*   </span>
</span><span class='line'><span class="cm">         * MountService has a few dependencies: Notification Manager and</span>
</span><span class='line'><span class="cm">         * AppWidget Provider. Make sure MountService is completely started</span>
</span><span class='line'><span class="cm">         * first before continuing.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">mountService</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">onlyCore</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mountService</span><span class="o">.</span><span class="na">waitForAsecScan</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">accountManager</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                <span class="n">accountManager</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">contentService</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
</span><span class='line'>                <span class="n">contentService</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">notification</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NotificationManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">statusBar</span><span class="o">,</span> <span class="n">lights</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">NOTIFICATION_SERVICE</span><span class="o">,</span> <span class="n">notification</span><span class="o">);</span>
</span><span class='line'>            <span class="n">networkPolicy</span><span class="o">.</span><span class="na">bindNotificationManager</span><span class="o">(</span><span class="n">notification</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">DeviceStorageMonitorService</span><span class="o">.</span><span class="na">SERVICE</span><span class="o">,</span>
</span><span class='line'>                    <span class="k">new</span> <span class="nf">DeviceStorageMonitorService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableLocation</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">location</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocationManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">LOCATION_SERVICE</span><span class="o">,</span> <span class="n">location</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">countryDetector</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountryDetectorService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">COUNTRY_DETECTOR</span><span class="o">,</span> <span class="n">countryDetector</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">Slog</span><span class="o">.</span><span class="na">i</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Search Service&quot;</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">SEARCH_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">SearchManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">DROPBOX_SERVICE</span><span class="o">,</span>
</span><span class='line'>                    <span class="k">new</span> <span class="nf">DropBoxManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="k">new</span> <span class="n">File</span><span class="o">(</span><span class="s">&quot;/data/system/dropbox&quot;</span><span class="o">)));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span> <span class="o">&amp;&amp;</span> <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getBoolean</span><span class="o">(</span>
</span><span class='line'>                    <span class="n">R</span><span class="o">.</span><span class="na">bool</span><span class="o">.</span><span class="na">config_enableWallpaperService</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(!</span><span class="n">headless</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">wallpaper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WallpaperManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                    <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">WALLPAPER_SERVICE</span><span class="o">,</span> <span class="n">wallpaper</span><span class="o">);</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableMedia</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">&quot;0&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">SystemProperties</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">&quot;system_init.startaudioservice&quot;</span><span class="o">)))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">AUDIO_SERVICE</span><span class="o">,</span> <span class="k">new</span> <span class="n">AudioService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Listen for dock station changes</span>
</span><span class='line'>                <span class="n">dock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DockObserver</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableMedia</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Listen for wired headset changes</span>
</span><span class='line'>                <span class="n">inputManager</span><span class="o">.</span><span class="na">setWiredAccessoryCallbacks</span><span class="o">(</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">WiredAccessoryManager</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">inputManager</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">reportWtf</span><span class="o">(</span><span class="s">&quot;starting WiredAccessoryManager&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Manage USB host and device support</span>
</span><span class='line'>                <span class="n">usb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsbService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">USB_SERVICE</span><span class="o">,</span> <span class="n">usb</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Serial port support</span>
</span><span class='line'>                <span class="n">serial</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SerialService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">SERIAL_SERVICE</span><span class="o">,</span> <span class="n">serial</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">twilight</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TwilightService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="c1">// Listen for UI mode changes</span>
</span><span class='line'>            <span class="n">uiMode</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UiModeManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">twilight</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">BACKUP_SERVICE</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">BackupManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">appWidget</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AppWidgetService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">APPWIDGET_SERVICE</span><span class="o">,</span> <span class="n">appWidget</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">recognition</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecognitionManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;diskstats&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">DiskStatsService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;samplingprofiler&quot;</span><span class="o">,</span>
</span><span class='line'>                        <span class="k">new</span> <span class="nf">SamplingProfilerService</span><span class="o">(</span><span class="n">context</span><span class="o">));</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">networkTimeUpdater</span> <span class="o">=</span> <span class="k">new</span> <span class="n">NetworkTimeUpdateService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableMedia</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">commonTimeMgmtService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CommonTimeManagementService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="s">&quot;commontime_management&quot;</span><span class="o">,</span> <span class="n">commonTimeMgmtService</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNetwork</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">CertBlacklister</span> <span class="n">blacklister</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CertBlacklister</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="n">context</span><span class="o">.</span><span class="na">getResources</span><span class="o">().</span><span class="na">getBoolean</span><span class="o">(</span><span class="n">R</span><span class="o">.</span><span class="na">bool</span><span class="o">.</span><span class="na">config_dreamsSupported</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Dreams (interactive idle-time views, a/k/a screen savers)</span>
</span><span class='line'>                <span class="n">dreamy</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DreamManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">wmHandler</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">DreamService</span><span class="o">.</span><span class="na">DREAM_SERVICE</span><span class="o">,</span> <span class="n">dreamy</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">atlas</span> <span class="o">=</span> <span class="k">new</span> <span class="n">AssetAtlasService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">AssetAtlasService</span><span class="o">.</span><span class="na">ASSET_ATLAS_SERVICE</span><span class="o">,</span> <span class="n">atlas</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">new</span> <span class="nf">IdleMaintenanceService</span><span class="o">(</span><span class="n">context</span><span class="o">,</span> <span class="n">battery</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">printManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintManagerService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>            <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">PRINT_SERVICE</span><span class="o">,</span> <span class="n">printManager</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="o">(!</span><span class="n">disableNonCoreServices</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mediaRouter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MediaRouterService</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>                <span class="n">ServiceManager</span><span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="n">Context</span><span class="o">.</span><span class="na">MEDIA_ROUTER_SERVICE</span><span class="o">,</span> <span class="n">mediaRouter</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="c1">//safe mode 相关</span>
</span><span class='line'>    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">safeMode</span> <span class="o">=</span> <span class="n">wm</span><span class="o">.</span><span class="na">detectSafeMode</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">safeMode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">enterSafeMode</span><span class="o">();</span>
</span><span class='line'>        <span class="c1">// Post the safe mode state in the Zygote class</span>
</span><span class='line'>        <span class="n">Zygote</span><span class="o">.</span><span class="na">systemInSafeMode</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>        <span class="c1">// Disable the JIT for the system_server process</span>
</span><span class='line'>        <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">disableJitCompilation</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Enable the JIT for the system_server process</span>
</span><span class='line'>        <span class="n">VMRuntime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">startJitCompilation</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//service system ready</span>
</span><span class='line'>    <span class="n">vibrator</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">lockSettings</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">devicePolicy</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">notification</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">wm</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">safeMode</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">showSafeModeOverlay</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">power</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">twilight</span><span class="o">,</span> <span class="n">dreamy</span><span class="o">);</span>
</span><span class='line'>    <span class="n">pm</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>    <span class="n">display</span><span class="o">.</span><span class="na">systemReady</span><span class="o">(</span><span class="n">safeMode</span><span class="o">,</span> <span class="n">onlyCore</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//接下来是 ActivityManagerService 的 systemReady</span>
</span><span class='line'>    <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">systemReady</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">self</span><span class="o">().</span><span class="na">startObservingNativeCrashes</span><span class="o">();</span>
</span><span class='line'>                <span class="n">startSystemUi</span><span class="o">(</span><span class="n">contextF</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mountServiceF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mountServiceF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">batteryF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">batteryF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkManagementF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkManagementF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkStatsF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkStatsF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkPolicyF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkPolicyF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">connectivityF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">connectivityF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">dockF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">dockF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">usbF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">usbF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">twilightF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">twilightF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">uiModeF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">uiModeF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">recognitionF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">recognitionF</span><span class="o">.</span><span class="na">systemReady</span><span class="o">();</span>
</span><span class='line'>            <span class="n">Watchdog</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// It is now okay to let the various system services start their</span>
</span><span class='line'>            <span class="c1">// third party code...</span>
</span><span class='line'>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">appWidgetF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">appWidgetF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">(</span><span class="n">safeMode</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">wallpaperF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">wallpaperF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">immF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">immF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">(</span><span class="n">statusBarF</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">locationF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">locationF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">countryDetectorF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">countryDetectorF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">networkTimeUpdaterF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">networkTimeUpdaterF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">commonTimeMgmtServiceF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">commonTimeMgmtServiceF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                    <span class="n">textServiceManagerServiceF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">dreamyF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">dreamyF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">atlasF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">atlasF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">inputManagerF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">inputManagerF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">telephonyRegistryF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">telephonyRegistryF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">msimTelephonyRegistryF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">msimTelephonyRegistryF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">printManagerF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">printManagerF</span><span class="o">.</span><span class="na">systemRuning</span><span class="o">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mediaRouterF</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">mediaRouterF</span><span class="o">.</span><span class="na">systemRunning</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//进入消息循环</span>
</span><span class='line'>    <span class="n">Looper</span><span class="o">.</span><span class="na">loop</span><span class="o">();</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>system server 启动了，来看下 Launcher 是怎么启动的。system server 的最后一段调用了 ActivityManagerService 的 systemReady() 回调。</p>

<p>ActivityManagerService 的 systemReady()：</p>

<figure class='code'><figcaption><span>ActivityManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kt">void</span> <span class="nf">systemReady</span><span class="o">(</span><span class="kd">final</span> <span class="n">Runnable</span> <span class="n">goingCallback</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>        <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">resumeTopActivitiesLocked</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>mStackSupervisor.resumeTopActivitiesLocked</p>

<figure class='code'><figcaption><span>ActivityStackSupervisor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">resumeTopActivitiesLocked</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">resumeTopActivitiesLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">boolean</span> <span class="nf">resumeTopActivitiesLocked</span><span class="o">(</span><span class="n">ActivityStack</span> <span class="n">targetStack</span><span class="o">,</span> <span class="n">ActivityRecord</span> <span class="n">target</span><span class="o">,</span>
</span><span class='line'>        <span class="n">Bundle</span> <span class="n">targetOptions</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">targetStack</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">targetStack</span> <span class="o">=</span> <span class="n">getFocusedStack</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="kt">boolean</span> <span class="n">result</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">stackNdx</span> <span class="o">=</span> <span class="n">mStacks</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">stackNdx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">;</span> <span class="o">--</span><span class="n">stackNdx</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">final</span> <span class="n">ActivityStack</span> <span class="n">stack</span> <span class="o">=</span> <span class="n">mStacks</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stackNdx</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">isFrontStack</span><span class="o">(</span><span class="n">stack</span><span class="o">))</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">stack</span> <span class="o">==</span> <span class="n">targetStack</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">result</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="na">resumeTopActivityLocked</span><span class="o">(</span><span class="n">target</span><span class="o">,</span> <span class="n">targetOptions</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">stack</span><span class="o">.</span><span class="na">resumeTopActivityLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>stack.resumeTopActivityLocked</p>

<figure class='code'><figcaption><span>ActivityStack.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">prev</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">resumeTopActivityLocked</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">,</span> <span class="n">Bundle</span> <span class="n">options</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">ActivityManagerService</span><span class="o">.</span><span class="na">DEBUG_LOCKSCREEN</span><span class="o">)</span> <span class="n">mService</span><span class="o">.</span><span class="na">logLockScreen</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">next</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// There are no more activities!  Let&#39;s just start up the</span>
</span><span class='line'>        <span class="c1">// Launcher...</span>
</span><span class='line'>        <span class="n">ActivityOptions</span><span class="o">.</span><span class="na">abort</span><span class="o">(</span><span class="n">options</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_STATES</span><span class="o">)</span> <span class="n">Slog</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;resumeTopActivityLocked: No more activities go home&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">DEBUG_STACK</span><span class="o">)</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">validateTopActivitiesLocked</span><span class="o">();</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">resumeHomeActivity</span><span class="o">(</span><span class="n">prev</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>mStackSupervisor.resumeHomeActivity</p>

<figure class='code'><figcaption><span>ActivityStackSupervisor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">resumeHomeActivity</span><span class="o">(</span><span class="n">ActivityRecord</span> <span class="n">prev</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">mService</span><span class="o">.</span><span class="na">startHomeActivityLocked</span><span class="o">(</span><span class="n">mCurrentUser</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>mService.startHomeActivityLocked(mCurrentUser)</p>

<figure class='code'><figcaption><span>ActivityManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">startHomeActivityLocked</span><span class="o">(</span><span class="kt">int</span> <span class="n">userId</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">Intent</span> <span class="n">intent</span> <span class="o">=</span> <span class="n">getHomeIntent</span><span class="o">();</span>
</span><span class='line'>    <span class="n">ActivityInfo</span> <span class="n">aInfo</span> <span class="o">=</span>
</span><span class='line'>        <span class="n">resolveActivityInfo</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">STOCK_PM_FLAGS</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">aInfo</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">intent</span><span class="o">.</span><span class="na">setComponent</span><span class="o">(</span><span class="k">new</span> <span class="n">ComponentName</span><span class="o">(</span>
</span><span class='line'>                <span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span> <span class="n">aInfo</span><span class="o">.</span><span class="na">name</span><span class="o">));</span>
</span><span class='line'>        <span class="c1">// Don&#39;t do this if the home app is currently being</span>
</span><span class='line'>        <span class="c1">// instrumented.</span>
</span><span class='line'>        <span class="n">aInfo</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ActivityInfo</span><span class="o">(</span><span class="n">aInfo</span><span class="o">);</span>
</span><span class='line'>        <span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span> <span class="o">=</span> <span class="n">getAppInfoForUser</span><span class="o">(</span><span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">,</span> <span class="n">userId</span><span class="o">);</span>
</span><span class='line'>        <span class="n">ProcessRecord</span> <span class="n">app</span> <span class="o">=</span> <span class="n">getProcessRecordLocked</span><span class="o">(</span><span class="n">aInfo</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span>
</span><span class='line'>                <span class="n">aInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">(</span><span class="n">app</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">app</span><span class="o">.</span><span class="na">instrumentationClass</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">intent</span><span class="o">.</span><span class="na">setFlags</span><span class="o">(</span><span class="n">intent</span><span class="o">.</span><span class="na">getFlags</span><span class="o">()</span> <span class="o">|</span> <span class="n">Intent</span><span class="o">.</span><span class="na">FLAG_ACTIVITY_NEW_TASK</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mStackSupervisor</span><span class="o">.</span><span class="na">startHomeActivity</span><span class="o">(</span><span class="n">intent</span><span class="o">,</span> <span class="n">aInfo</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;> mStackSupervisor.startHomeActivity</p>

<figure class='code'><figcaption><span>ActivityStackSupervisor.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">void</span> <span class="nf">startHomeActivity</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> <span class="n">ActivityInfo</span> <span class="n">aInfo</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">moveHomeToTop</span><span class="o">();</span>
</span><span class='line'>    <span class="n">startActivityLocked</span><span class="o">(</span><span class="kc">null</span><span class="o">,</span> <span class="n">intent</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">aInfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span>
</span><span class='line'>            <span class="kc">null</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="n">startActivityLocked</span>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="n">startActivityUncheckedLocked</span>
</span><span class='line'><span class="o">-&gt;</span>
</span><span class='line'><span class="n">resumeTopActivitiesLocked</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>ActivityStack.resumeTopActivityLocked</p>

<p>&ndash;>
ActivityStackSupervisor.startSpecificActivityLocked</p>

<p>&ndash;>
ActivityManagerService.startProcessLocked</p>

<p>&ndash;></p>

<figure class='code'><figcaption><span>ActivityManagerService.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>        <span class="c1">// Start the process.  It will either succeed and return a result containing</span>
</span><span class='line'>        <span class="c1">// the PID of the new process, or else throw a RuntimeException.</span>
</span><span class='line'>        <span class="n">Process</span><span class="o">.</span><span class="na">ProcessStartResult</span> <span class="n">startResult</span> <span class="o">=</span> <span class="n">Process</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="s">&quot;android.app.ActivityThread&quot;</span><span class="o">,</span>
</span><span class='line'>                <span class="n">app</span><span class="o">.</span><span class="na">processName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span>
</span><span class='line'>                <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">targetSdkVersion</span><span class="o">,</span> <span class="n">app</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">seinfo</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>
Process.start 注意这里传入的 processClass 是 &ldquo;android.app.ActivityThread&rdquo;</p>

<p>&ndash;>
startViaZygote</p>

<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">ProcessStartResult</span> <span class="nf">start</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span><span class="o">[]</span> <span class="n">zygoteArgs</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="n">processClass</span><span class="o">,</span> <span class="n">niceName</span><span class="o">,</span> <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                <span class="n">debugFlags</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">targetSdkVersion</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">zygoteArgs</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">ZygoteStartFailedEx</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">LOG_TAG</span><span class="o">,</span>
</span><span class='line'>                <span class="s">&quot;Starting VM process through Zygote failed&quot;</span><span class="o">);</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
</span><span class='line'>                <span class="s">&quot;Starting VM process through Zygote failed&quot;</span><span class="o">,</span> <span class="n">ex</span><span class="o">);</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;></p>

<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">ProcessStartResult</span> <span class="nf">startViaZygote</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">processClass</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span>
</span><span class='line'>                              <span class="kd">final</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span>
</span><span class='line'>                              <span class="kt">int</span> <span class="n">targetSdkVersion</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span>
</span><span class='line'>                              <span class="n">String</span><span class="o">[]</span> <span class="n">extraArgs</span><span class="o">)</span>
</span><span class='line'>                              <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>         <span class="k">return</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">argsForZygote</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="n">ProcessStartResult</span> <span class="nf">zygoteSendArgsAndGetResult</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">args</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">openZygoteSocketIfNeeded</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>        <span class="n">sZygoteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">Integer</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">args</span><span class="o">.</span><span class="na">size</span><span class="o">()));</span>            <span class="n">sZygoteWriter</span><span class="o">.</span><span class="na">newLine</span><span class="o">();</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>        <span class="n">sZygoteWriter</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">arg</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>openZygoteSocketIfNeeded?</p>

<figure class='code'><figcaption><span>Process.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">ZYGOTE_SOCKET</span> <span class="o">=</span> <span class="s">&quot;zygote&quot;</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">openZygoteSocketIfNeeded</span><span class="o">()</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteStartFailedEx</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">sZygoteSocket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LocalSocket</span><span class="o">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">sZygoteSocket</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="k">new</span> <span class="n">LocalSocketAddress</span><span class="o">(</span><span class="n">ZYGOTE_SOCKET</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">LocalSocketAddress</span><span class="o">.</span><span class="na">Namespace</span><span class="o">.</span><span class="na">RESERVED</span><span class="o">));</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>yes &ndash;> connect to &ldquo;zygote&rdquo; and send args, back to zygote:</p>

<figure class='code'><figcaption><span>ZygoteInit.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>   <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">runSelectLoop</span><span class="o">(){</span>
</span><span class='line'>                <span class="n">done</span> <span class="o">=</span> <span class="n">peers</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">index</span><span class="o">).</span><span class="na">runOnce</span><span class="o">();</span>
</span><span class='line'>   <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>runOnce?</p>

<figure class='code'><figcaption><span>ZygoteConnection.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">(){</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">pid</span> <span class="o">=</span> <span class="n">Zygote</span><span class="o">.</span><span class="na">forkAndSpecialize</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">.</span><span class="na">uid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gid</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">gids</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">mountExternal</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">.</span><span class="na">seInfo</span><span class="o">,</span>
</span><span class='line'>                    <span class="n">parsedArgs</span><span class="o">.</span><span class="na">niceName</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span> <span class="n">newStderr</span><span class="o">);</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;>
Zygote.forkAndSpecialize</p>

<figure class='code'><figcaption><span>Zygote.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">forkAndSpecialize</span><span class="o">(</span><span class="kt">int</span> <span class="n">uid</span><span class="o">,</span> <span class="kt">int</span> <span class="n">gid</span><span class="o">,</span> <span class="kt">int</span><span class="o">[]</span> <span class="n">gids</span><span class="o">,</span> <span class="kt">int</span> <span class="n">debugFlags</span><span class="o">,</span>
</span><span class='line'>        <span class="kt">int</span><span class="o">[][]</span> <span class="n">rlimits</span><span class="o">,</span> <span class="kt">int</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">String</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">String</span> <span class="n">niceName</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">preFork</span><span class="o">();</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">nativeForkAndSpecialize</span><span class="o">(</span>
</span><span class='line'>            <span class="n">uid</span><span class="o">,</span> <span class="n">gid</span><span class="o">,</span> <span class="n">gids</span><span class="o">,</span> <span class="n">debugFlags</span><span class="o">,</span> <span class="n">rlimits</span><span class="o">,</span> <span class="n">mountExternal</span><span class="o">,</span> <span class="n">seInfo</span><span class="o">,</span> <span class="n">niceName</span><span class="o">);</span>
</span><span class='line'>    <span class="n">postFork</span><span class="o">();</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">pid</span><span class="o">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&ndash;> nativeForkAndSpecialize</p>

<figure class='code'><figcaption><span>dalvik_system_Zygote.cpp</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="n">Dalvik_dalvik_system_Zygote_forkAndSpecialize</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span>
</span><span class='line'>    <span class="n">JValue</span><span class="o">*</span> <span class="n">pResult</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">pid_t</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pid</span> <span class="o">=</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">RETURN_INT</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="n">pid_t</span> <span class="n">forkAndSpecializeCommon</span><span class="p">(</span><span class="k">const</span> <span class="n">u4</span><span class="o">*</span> <span class="n">args</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">isSystemServer</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'> <span class="n">pid</span> <span class="o">=</span> <span class="n">fork</span><span class="p">();</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">return</span> <span class="n">pid</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>fork 创建新进程，返回到 ZygoteConnection 的 runOnce.</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'> <span class="kt">boolean</span> <span class="nf">runOnce</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>        <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">pid</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// in child</span>
</span><span class='line'>                <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
</span><span class='line'>                <span class="n">serverPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                <span class="n">handleChildProc</span><span class="o">(</span><span class="n">parsedArgs</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">childPipeFd</span><span class="o">,</span> <span class="n">newStderr</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// should never get here, the child is expected to either</span>
</span><span class='line'>                <span class="c1">// throw ZygoteInit.MethodAndArgsCaller or exec().</span>
</span><span class='line'>                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// in parent...pid of &lt; 0 means failure</span>
</span><span class='line'>                <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
</span><span class='line'>                <span class="n">childPipeFd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                <span class="k">return</span> <span class="nf">handleParentProc</span><span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">serverPipeFd</span><span class="o">,</span> <span class="n">parsedArgs</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">childPipeFd</span><span class="o">);</span>
</span><span class='line'>            <span class="n">IoUtils</span><span class="o">.</span><span class="na">closeQuietly</span><span class="o">(</span><span class="n">serverPipeFd</span><span class="o">);</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>子进程进入 &ndash;> handleChildProc</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">handleChildProc</span><span class="o">(</span><span class="n">Arguments</span> <span class="n">parsedArgs</span><span class="o">,</span>
</span><span class='line'>        <span class="n">FileDescriptor</span><span class="o">[]</span> <span class="n">descriptors</span><span class="o">,</span> <span class="n">FileDescriptor</span> <span class="n">pipeFd</span><span class="o">,</span> <span class="n">PrintStream</span> <span class="n">newStderr</span><span class="o">)</span>
</span><span class='line'>        <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>                <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">invokeStaticMain</span><span class="o">(</span><span class="n">cloader</span><span class="o">,</span> <span class="n">className</span><span class="o">,</span> <span class="n">mainArgs</span><span class="o">);</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>调用 className 的 main 方法, className 是哪个呢？就是上面传入的 &ldquo;android.app.ActivityThread&rdquo;</p>

<p>&ndash;></p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">invokeStaticMain</span><span class="o">(</span><span class="n">ClassLoader</span> <span class="n">loader</span><span class="o">,</span>
</span><span class='line'>            <span class="n">String</span> <span class="n">className</span><span class="o">,</span> <span class="n">String</span><span class="o">[]</span> <span class="n">argv</span><span class="o">)</span>
</span><span class='line'>            <span class="kd">throws</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span> <span class="o">{</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>         <span class="n">cl</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="na">loadClass</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
</span><span class='line'>         <span class="n">m</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">,</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]</span> <span class="o">{</span> <span class="n">String</span><span class="o">[].</span><span class="na">class</span> <span class="o">});</span>
</span><span class='line'>         <span class="o">...</span>
</span><span class='line'>        <span class="cm">/*</span>
</span><span class='line'><span class="cm">         * This throw gets caught in ZygoteInit.main(), which responds</span>
</span><span class='line'><span class="cm">         * by invoking the exception&#39;s run() method. This arrangement</span>
</span><span class='line'><span class="cm">         * clears up all the stack frames that were required in setting</span>
</span><span class='line'><span class="cm">         * up the process.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="n">ZygoteInit</span><span class="o">.</span><span class="na">MethodAndArgsCaller</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">argv</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>抛出异常，返回到 ZygoteInit.main() 里面 ;&ndash;)</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">argv</span><span class="o">[])</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MethodAndArgsCaller</span> <span class="n">caller</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">caller</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在这里执行 &ldquo;android.app.ActivityThread&rdquo; 的 main 方法.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">zhibin</span></span>

      








  


<time datetime="2014-01-09T14:23:00+08:00" pubdate data-updated="true">Jan 9<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/android/'>android</a>, <a class='category' href='/blog/categories/startup/'>startup</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://SteveVallay.github.io/blog/2014/01/09/android-start-process/" data-via="zhibin_" data-counturl="http://SteveVallay.github.io/blog/2014/01/09/android-start-process/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/12/27/alarm/" title="Previous Post: alarm">&laquo; alarm</a>
      
      
        <a class="basic-alignment right" href="/blog/2014/04/28/unlink/" title="Next Post: unlink">unlink &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/05/23/file-access-permissions/">File Access Permissions Summary</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/22/hearthstone-cards/">Hearthstone_cards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/22/sms/">Android Sms</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/12/permissions-on-folder/">Permissions on Folder</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/04/28/unlink/">Unlink</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/SteveVallay">@SteveVallay</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'SteveVallay',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - zhibin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zhibin';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://SteveVallay.github.io/blog/2014/01/09/android-start-process/';
        var disqus_url = 'http://SteveVallay.github.io/blog/2014/01/09/android-start-process/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
