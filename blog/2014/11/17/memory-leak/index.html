
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>android memory leak - Zhibin's blog</title>
  <meta name="author" content="zhibin">

  
  <meta name="description" content="Could not allocate CursorWindow due to error -12">
  <meta name="keywords" content="Could not allocate CursorWindow">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://SteveVallay.github.io/blog/2014/11/17/memory-leak">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Zhibin's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-39252101-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Zhibin's blog</a></h1>
  
    <h2>always smile :-)</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:SteveVallay.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Android Memory Leak</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-11-17T14:27:00+08:00" pubdate data-updated="true">Nov 17<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Record fix issue &ldquo;<strong>Could not allocate CursorWindow &lsquo;/data/data/com.android.providers.telephony/databases/mmssms.db&rsquo; of size 2097152 due to error -12</strong>&rdquo; issue.</p>

<!-- more -->


<h3>Issue born</h3>

<p>One day, we met an issue caused Messages application force close.</p>

<p>This issue happen when do a simple Message case (new a message &ndash;> send &ndash;> delete all, then repeat many times)  more than 10 hours.</p>

<p>Logcat info as below:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>E/CursorWindow( 1350): Could not allocate CursorWindow '/data/data/com.android.providers.telephony/databases/mmssms.db' of size 2097152 due to error -12.
</span><span class='line'>E/JavaBinder( 1350): *** Uncaught remote exception!  (Exceptions are not yet supported across processes.)
</span><span class='line'>E/JavaBinder( 1350): android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # Open Cursors=4 (# cursors opened by pid 16143=4)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.CursorWindow.&lt;init&gt;(CursorWindow.java:107)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.AbstractWindowedCursor.clearOrCreateWindow(AbstractWindowedCursor.java:198)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.sqlite.SQLiteCursor.fillWindow(SQLiteCursor.java:139)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.sqlite.SQLiteCursor.getCount(SQLiteCursor.java:133)
</span><span class='line'>E/JavaBinder( 1350):  at android.database.CursorToBulkCursorAdaptor.getBulkCursorDescriptor(CursorToBulkCursorAdaptor.java:148)
</span><span class='line'>E/JavaBinder( 1350):  at android.content.ContentProviderNative.onTransact(ContentProviderNative.java:118)
</span><span class='line'>E/JavaBinder( 1350):  at android.os.Binder.execTransact(Binder.java:404)
</span><span class='line'>E/JavaBinder( 1350):  at dalvik.system.NativeStart.run(Native Method)</span></code></pre></td></tr></table></div></figure>


<h3>Guess root cause</h3>

<p>Our experience told us there were some <code>Cursor</code> not close in this application. Then we checked the code , search keywords <code>cursor</code> , but seems all <code>Cursor</code> were <strong>closed correctly</strong>.</p>

<p>We searched <a href="www.google.com">Google</a> and  <a href="www.stackoverflow.com">StackOverflow</a> , some <strong>similar</strong> issues founded :</p>

<ol>
<li><a href="http://stackoverflow.com/questions/17495713/could-not-allocate-cursorwindow">Could not allocate CursorWindow</a></li>
<li><a href="http://stackoverflow.com/questions/11340257/sqlite-android-database-cursor-window-allocation-of-2048-kb-failed">SQLite Android Database Cursor window allocation of 2048 kb failed</a></li>
</ol>


<p>They all said you need close cursor in finally, but actually cursor already closed in finally.</p>

<p>Then we find our issue&rsquo;s log really has some difference with issues from <a href="www.stackoverflow.com">StackOverflow</a></p>

<ul>
<li>log of our issue:</li>
</ul>


<p>E/JavaBinder( 1350): android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # <strong>Open Cursors=4</strong> (# cursors opened by pid 16143=4)</p>

<ul>
<li>log of <a href="www.stackoverflow.com">StackOverflow</a> issue:</li>
</ul>


<p>android.database.CursorWindowAllocationException: Cursor window allocation of 2048 kb failed. # <strong>Open Cursors=861</strong> (# cursors opened by this proc=861)</p>

<p>Opened cursor number is totally different, our is <strong>4</strong>, issue of <a href="www.stackoverflow.com">StackOverflow</a> &rsquo;s is <strong>861</strong>. If opened cursor number is large (hundreds of), we believe your code opened many cursors without close them, but this is not our case.</p>

<h3>Check code detail</h3>

<p>Failed to create new <code>CursorWindow</code>  throw such exception.</p>

<figure class='code'><figcaption><span>frameworks/base/core/java/android/database/CursorWindow.java  CursorWindow</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">sCursorWindowSize</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="cm">/** The cursor window size. resource xml file specifies the value in kB.</span>
</span><span class='line'><span class="cm">         * convert it to bytes here by multiplying with 1024.</span>
</span><span class='line'><span class="cm">         */</span>
</span><span class='line'>        <span class="n">sCursorWindowSize</span> <span class="o">=</span> <span class="n">Resources</span><span class="o">.</span><span class="na">getSystem</span><span class="o">().</span><span class="na">getInteger</span><span class="o">(</span>
</span><span class='line'>            <span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">internal</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">integer</span><span class="o">.</span><span class="na">config_cursorWindowSize</span><span class="o">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="n">mWindowPtr</span> <span class="o">=</span> <span class="n">nativeCreate</span><span class="o">(</span><span class="n">mName</span><span class="o">,</span> <span class="n">sCursorWindowSize</span><span class="o">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">(</span><span class="n">mWindowPtr</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">throw</span> <span class="k">new</span> <span class="nf">CursorWindowAllocationException</span><span class="o">(</span><span class="s">&quot;Cursor window allocation of &quot;</span> <span class="o">+</span>
</span><span class='line'>                <span class="o">(</span><span class="n">sCursorWindowSize</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot; kb failed. &quot;</span> <span class="o">+</span> <span class="n">printStats</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>nativeCreate</code> returned  0.</p>

<figure class='code'><figcaption><span>frameworks/base/core/jni/android_database_CursorWindow.cpp nativeCreate</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">CursorWindow</span><span class="o">*</span> <span class="n">window</span><span class="p">;</span>
</span><span class='line'><span class="n">status_t</span> <span class="n">status</span> <span class="o">=</span> <span class="n">CursorWindow</span><span class="o">::</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cursorWindowSize</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">window</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">||</span> <span class="o">!</span><span class="n">window</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">ALOGE</span><span class="p">(</span><span class="s">&quot;Could not allocate CursorWindow &#39;%s&#39; of size %d due to error %d.&quot;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">name</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span> <span class="n">cursorWindowSize</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>CursorWindow::create</code> returned non-zero.</p>

<figure class='code'><figcaption><span>frameworks/base/libs/androidfw/CursorWindow.cpp  CursorWindow::create</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">status_t</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="kt">int</span> <span class="n">ashmemFd</span> <span class="o">=</span> <span class="n">ashmem_create_region</span><span class="p">(</span><span class="n">ashmemName</span><span class="p">.</span><span class="n">string</span><span class="p">(),</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="n">ashmemFd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">ashmem_set_prot_region</span><span class="p">(</span><span class="n">ashmemFd</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">void</span><span class="o">*</span> <span class="n">data</span> <span class="o">=</span> <span class="o">::</span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_SHARED</span><span class="p">,</span> <span class="n">ashmemFd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">MAP_FAILED</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">errno</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">ashmem_set_prot_region</span><span class="p">(</span><span class="n">ashmemFd</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="p">);</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">CursorWindow</span><span class="o">*</span> <span class="n">window</span> <span class="o">=</span> <span class="n">new</span> <span class="n">CursorWindow</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ashmemFd</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="nb">false</span> <span class="cm">/*readOnly*/</span><span class="p">);</span>
</span><span class='line'>                <span class="n">result</span> <span class="o">=</span> <span class="n">window</span><span class="o">-&gt;</span><span class="n">clear</span><span class="p">();</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="n">LOG_WINDOW</span><span class="p">(</span><span class="s">&quot;Created new CursorWindow: freeOffset=%d, &quot;</span>
</span><span class='line'>                            <span class="s">&quot;numRows=%d, numColumns=%d, mSize=%d, mData=%p&quot;</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mHeader</span><span class="o">-&gt;</span><span class="n">freeOffset</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mHeader</span><span class="o">-&gt;</span><span class="n">numRows</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mHeader</span><span class="o">-&gt;</span><span class="n">numColumns</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">window</span><span class="o">-&gt;</span><span class="n">mSize</span><span class="p">,</span> <span class="n">window</span><span class="o">-&gt;</span><span class="n">mData</span><span class="p">);</span>
</span><span class='line'>                    <span class="o">*</span><span class="n">outCursorWindow</span> <span class="o">=</span> <span class="n">window</span><span class="p">;</span>
</span><span class='line'>                    <span class="k">return</span> <span class="n">OK</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="n">delete</span> <span class="n">window</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="o">::</span><span class="n">munmap</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="o">::</span><span class="n">close</span><span class="p">(</span><span class="n">ashmemFd</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">*</span><span class="n">outCursorWindow</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'><span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>we can see that -12 is -errno, which means <strong>out of memory</strong>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#define ENOMEM      12  </span><span class="cm">/* Out of memory */</span><span class="cp"></span>
</span></code></pre></td></tr></table></div></figure>


<p>It must returned from <strong>mmap</strong> operation. we can check this by <code>man mmap</code> :</p>

<blockquote><p>ENOMEM No memory is available, or the process&rsquo;s maximum number of mappings would have been exceeded.</p></blockquote>

<h3>Test code</h3>

<p>Because when this issue occur after 10 hours test(on customer side) and will got message restart , so hard to check phone&rsquo;s status when this happen.</p>

<p>I decided to write some test code to reproduce similar issue.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kt">int</span> <span class="n">number</span> <span class="o">=</span><span class="mi">1000</span><span class="o">;</span>
</span><span class='line'><span class="kd">private</span> <span class="n">Cursor</span> <span class="o">[]</span> <span class="n">cursors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cursor</span><span class="o">[</span><span class="n">number</span><span class="o">];</span>
</span><span class='line'>
</span><span class='line'><span class="kd">private</span> <span class="kt">void</span> <span class="nf">testCursor</span><span class="o">(){</span>
</span><span class='line'>    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">number</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
</span><span class='line'>        <span class="n">cursors</span><span class="o">[</span><span class="n">i</span><span class="o">]=</span> <span class="n">getContentResolver</span><span class="o">().</span><span class="na">query</span><span class="o">(</span><span class="n">Uri</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="s">&quot;content://sms&quot;</span><span class="o">),</span><span class="n">SMS_PROJECTION</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="kc">null</span><span class="o">);</span>
</span><span class='line'>        <span class="n">Log</span><span class="o">.</span><span class="na">d</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;i = &quot;</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="s">&quot;  count:&quot;</span> <span class="o">+</span> <span class="n">cursors</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">getCount</span><span class="o">());</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It will generate logcat info and cause app crash:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">CursorWindow</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span> <span class="n">Could</span> <span class="n">not</span> <span class="n">allocate</span> <span class="n">CursorWindow</span> <span class="err">&#39;</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="na">android</span><span class="o">.</span><span class="na">providers</span><span class="o">.</span><span class="na">telephony</span><span class="o">/</span><span class="n">databases</span><span class="o">/</span><span class="n">mmssms</span><span class="o">.</span><span class="na">db</span><span class="err">&#39;</span> <span class="n">of</span> <span class="n">size</span> <span class="mi">2097152</span> <span class="n">due</span> <span class="n">to</span> <span class="n">error</span> <span class="o">-</span>
</span><span class='line'><span class="mi">12</span><span class="o">.</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span> <span class="o">***</span> <span class="n">Uncaught</span> <span class="n">remote</span> <span class="n">exception</span><span class="o">!</span>  <span class="o">(</span><span class="n">Exceptions</span> <span class="n">are</span> <span class="n">not</span> <span class="n">yet</span> <span class="n">supported</span> <span class="n">across</span> <span class="n">processes</span><span class="o">.)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">CursorWindowAllocationException</span><span class="o">:</span> <span class="n">Cursor</span> <span class="n">window</span> <span class="n">allocation</span> <span class="n">of</span> <span class="mi">2048</span> <span class="n">kb</span> <span class="n">failed</span><span class="o">.</span> <span class="err">#</span> <span class="n">Open</span> <span class="n">Cursors</span><span class="o">=</span><span class="mi">732</span> <span class="o">(</span><span class="err">#</span> <span class="n">cursors</span> <span class="n">opene</span>
</span><span class='line'><span class="n">d</span> <span class="n">by</span> <span class="n">pid</span> <span class="mi">845</span><span class="o">=</span><span class="mi">732</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">CursorWindow</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">CursorWindow</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">107</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">AbstractWindowedCursor</span><span class="o">.</span><span class="na">clearOrCreateWindow</span><span class="o">(</span><span class="n">AbstractWindowedCursor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">198</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">sqlite</span><span class="o">.</span><span class="na">SQLiteCursor</span><span class="o">.</span><span class="na">fillWindow</span><span class="o">(</span><span class="n">SQLiteCursor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">139</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">sqlite</span><span class="o">.</span><span class="na">SQLiteCursor</span><span class="o">.</span><span class="na">getCount</span><span class="o">(</span><span class="n">SQLiteCursor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">133</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">database</span><span class="o">.</span><span class="na">CursorToBulkCursorAdaptor</span><span class="o">.</span><span class="na">getBulkCursorDescriptor</span><span class="o">(</span><span class="n">CursorToBulkCursorAdaptor</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">148</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">content</span><span class="o">.</span><span class="na">ContentProviderNative</span><span class="o">.</span><span class="na">onTransact</span><span class="o">(</span><span class="n">ContentProviderNative</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">118</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Binder</span><span class="o">.</span><span class="na">execTransact</span><span class="o">(</span><span class="n">Binder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">404</span><span class="o">)</span>
</span><span class='line'><span class="n">E</span><span class="o">/</span><span class="n">JavaBinder</span><span class="o">(</span> <span class="mi">1147</span><span class="o">):</span>    <span class="n">at</span> <span class="n">dalvik</span><span class="o">.</span><span class="na">system</span><span class="o">.</span><span class="na">NativeStart</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">Native</span> <span class="n">Method</span><span class="o">)</span>
</span><span class='line'><span class="n">D</span><span class="o">/</span><span class="n">AndroidRuntime</span><span class="o">(</span>  <span class="mi">845</span><span class="o">):</span> <span class="n">Shutting</span> <span class="n">down</span> <span class="n">VM</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I use <code>procrank</code> (<code>top</code> or <code>ps</code> also OK)to check status, find Vss of phone(mmssms provider running in phone process) and testlink(my test app) are very high:
> 2000M</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="se">\#</span> procrank
</span><span class='line'>  PID       Vss      Rss      Pss      Uss  cmdline
</span><span class='line'>  919   643824K   61016K   33791K   30616K  system_server
</span><span class='line'> 1147  2082976K   52676K   26426K   23688K  com.android.phone
</span><span class='line'>...
</span><span class='line'>31155  2009512K   22032K    4000K    3384K  com.example.testlink
</span></code></pre></td></tr></table></div></figure>


<p>Then I use <code>cat /proc/1147/maps</code> to see the phone process&rsquo;s memory consumption for the its mappings.</p>

<p>I can see 744 records of <code>CursorWindow</code> as below (samilar in testlink process&rsquo;s maps):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>61fb5000-621b5000 rw-s 00000000 00:04 146971     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>621b5000-623b5000 rw-s 00000000 00:04 146972     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>623b5000-625b5000 rw-s 00000000 00:04 146973     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>625b5000-627b5000 rw-s 00000000 00:04 146974     /dev/ashmem/CursorWindow: /data/data/com.android.providers.telephony/databases/mmssms.db <span class="o">(</span>deleted<span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Maybe <code>procmem</code> is better for this, I find <code>procmem</code> later. Use <code>procmem</code> to check  the phone process&rsquo;s maps :</p>

<p>Also can see 744 records of <code>CursorWindow</code>, each one cost  2048K Vss.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>Vss      Rss      Pss      Uss     ShCl     ShDi     PrCl     PrDi  Name
</span><span class='line'>
</span><span class='line'>-------  -------  -------  -------  -------  -------  -------  -------
</span><span class='line'>...
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>  2048K       4K       4K       4K       0K       0K       0K       4K  /dev/ashmem/CursorWindow:
</span><span class='line'>
</span><span class='line'>   132K      36K      16K      16K      20K       0K      16K       0K  <span class="o">[</span>stack<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>     0K       0K       0K       0K       0K       0K       0K       0K  <span class="o">[</span>vectors<span class="o">]</span>
</span><span class='line'>
</span><span class='line'>-------  -------  -------  -------  -------  -------  -------  -------
</span><span class='line'>
</span><span class='line'>2079416K   39824K   20503K   19360K   20412K      52K   16592K    2976K  TOTAL
</span></code></pre></td></tr></table></div></figure>


<p>Theoretically, on 32 bit OS, Vss limit can be 4GB, but on 32 bit Android, Vss limit is 2GB. A process can not use Vss more than this limit. I do not know why.</p>

<p>Now, I can say, in case of my test app, every query try to use a new cursor which need allocate 2M
Vss . When alloacated Vss reach limit (2G) will return fail with errno 12 <code>ENOMEM</code>.</p>

<p>But for the first case , opened cursor number is only 4, most consume 8M memory, should not cause memory exhaust.</p>

<p>To find out what cost the memory, we need check maps of mms process from customer devices. Since we are not there with customer, we need a script to capture related logs.</p>

<h3>Capture logs &amp; fix first issue</h3>

<p>Then I wrote an bash script to capture related logs every half an hour.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/system/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> <span class="sb">`</span>ps| grep com.android.mms<span class="sb">`</span>
</span><span class='line'><span class="nv">pidOfMms</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;pid of mms is: $pidOfMms&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> <span class="sb">`</span>ps|grep com.android.phone<span class="sb">`</span>
</span><span class='line'><span class="nv">pidOfPhone</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;pid of phone is: $pidOfPhone&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;/sdcard/logs&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>mkdir <span class="s2">&quot;/sdcard/logs&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;create new dir /sdcard/logs&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="o">[</span> -d <span class="s2">&quot;/sdcard/logs&quot;</span> <span class="o">]</span>
</span><span class='line'><span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;start capture logs&quot;</span>
</span><span class='line'>    <span class="nv">t</span><span class="o">=</span><span class="sb">`</span>date +<span class="s2">&quot;%Y-%m-%d-%H-%M-%S&quot;</span><span class="sb">`</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="nv">$$</span> &gt; /sdcard/logs/pid.log
</span><span class='line'>    procrank &gt; <span class="s2">&quot;/sdcard/logs/procrank&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    dumpsys meminfo com.android.mms &gt; <span class="s2">&quot;/sdcard/logs/meminfo.mms&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    dumpsys meminfo com.android.phone &gt; <span class="s2">&quot;/sdcard/logs/meminfo.phone&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    cat /proc/<span class="nv">$pidOfPhone</span>/maps &gt; <span class="s2">&quot;/sdcard/logs/maps.phone&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    cat /proc/<span class="nv">$pidOfMms</span>/maps &gt; <span class="s2">&quot;/sdcard/logs/maps.mms&quot;</span><span class="nv">$t</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'>    sleep 1800
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>push</code> this script to <strong>/system/bin/</strong> and add execute permission, run this <code>sh /system/bin/log.sh &amp;</code> before test , it will capture logs ever half an hour.</p>

<p>Then I got the maps of info of phone and mms process, after analysis , find 684 records of <code>/system/framework/framework-res.apk</code> as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>b75f7000-b772a000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b7791000-b78c4000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b78c4000-b79f7000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b79f7000-b7b2a000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>b7b2a000-b7c5d000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>...
</span><span class='line'>bb165000-bb298000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span><span class='line'>bb298000-bb3cb000 r--s 00907000 b3:10 853        /system/framework/framework-res.apk
</span></code></pre></td></tr></table></div></figure>


<p>I find lots of overlay errors in adb logs as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>11-06 10:55:47: D/asset   <span class="o">(</span> 1241<span class="o">)</span>: createIdmapFileLocked: <span class="nv">originalPath</span><span class="o">=</span>/system/framework/framework-res.apk <span class="nv">overlayPath</span><span class="o">=</span>/vendor/ty/overlay/framework/framework-res.apk <span class="nv">idmapPath</span><span class="o">=</span>/data/resource-cache/vendor@ty@overlay@framework@framework-res.apk@idmap
</span><span class='line'>11-06 10:55:47: W/asset   <span class="o">(</span> 1241<span class="o">)</span>: failed to find resources.arsc in /vendor/ty/overlay/framework/framework-res.apk
</span><span class='line'>11-06 10:55:47: W/asset   <span class="o">(</span> 1241<span class="o">)</span>: failed to add overlay package /vendor/ty/overlay/framework/framework-res.apk
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Then, I think maybe <a href="http://developer.sonymobile.com/2014/04/22/sony-contributes-runtime-resource-overlay-framework-to-android-code-example/">runtime overlay</a> failure caused <strong>/system/framework/framework-res.apk</strong>  loaded every time when app try to get framework resources. Lots of times load <strong>/system/framework/framework-res.apk</strong> without free previous cost memory caused memory leak.</p>

<p><a href="http://developer.sonymobile.com/2014/04/22/sony-contributes-runtime-resource-overlay-framework-to-android-code-example/">runtime overlay</a> failure is because <strong>failed to find resources.arsc in /vendor/ty/overlay/framework/framework-res.apk</strong>. After check <strong>/vendor/ty/overlay/framework/framework-res.apk</strong>, found no resources.arsc in this package because no resource in source code of this package.</p>

<p>Then removed <strong>/vendor/ty/overlay/framework/framework-res.apk</strong> and verify, after testing 10 hours , issue not observed.</p>

<h3>Same error , another issue</h3>

<p>After running 40 hours , similar error observed. Check maps of mms process (before the error), found 576 records of <code>stack</code> as below:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>711fa000-712f7000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1851<span class="o">]</span>
</span><span class='line'>712fe000-713fb000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1852<span class="o">]</span>
</span><span class='line'>71402000-714ff000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1853<span class="o">]</span>
</span><span class='line'>7436d000-7446a000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1854<span class="o">]</span>
</span><span class='line'>7446b000-74568000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1855<span class="o">]</span>
</span><span class='line'>74569000-74666000 rw-p 00000000 00:00 0          <span class="o">[</span>stack:1856<span class="o">]</span>
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>Also checked <code>top</code> info and <code>/proc/pid-of-mms/status</code> info , find Vss is high (1607952K) and lots of  threads (576) there:</p>

<ul>
<li>top info:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> PID PR CPU% S  <span class="c">#THR     VSS     RSS PCY UID      Name</span>
</span><span class='line'> 1847 0 1%   S   576 1607952K 210208K  <span class="nb">fg </span>u0_a9    com.android.mms
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>status info:</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Name:    com.android.mms
</span><span class='line'>State:    S <span class="o">(</span>sleeping<span class="o">)</span>
</span><span class='line'>Tgid: 1847
</span><span class='line'>Pid:  1847
</span><span class='line'>PPid: 203
</span><span class='line'>...
</span><span class='line'>Threads:  578
</span></code></pre></td></tr></table></div></figure>


<p>I think there are lots of unexpected thread created, so need capture threads info. Then wrote another script to capture threads info:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/system/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="nb">set</span> <span class="sb">`</span>ps| grep com.android.mms<span class="sb">`</span>
</span><span class='line'><span class="nv">pidOfMms</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>
</span><span class='line'><span class="nv">tasks</span><span class="o">=</span><span class="sb">`</span>ls /proc/<span class="nv">$pidOfMms</span>/task<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="s2">&quot;/sdcard/logs&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>mkdir <span class="s2">&quot;/sdcard/logs&quot;</span>
</span><span class='line'>    <span class="nb">echo</span> <span class="s2">&quot;create new dir /sdcard/logs&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">for </span>var in <span class="nv">$tasks</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span>debuggerd -b <span class="nv">$var</span> &gt; <span class="s2">&quot;/sdcard/logs/mms-tid-&quot;</span><span class="nv">$var</span><span class="s2">&quot;.log&quot;</span>
</span><span class='line'><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure>


<p>When got thread info, found lots of same name threads there:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="s2">&quot;k worker thread&quot;</span> <span class="nv">sysTid</span><span class="o">=</span>10137
</span><span class='line'>  <span class="c">#00  pc 00021a58  /system/lib/libc.so (__futex_syscall3+8)</span>
</span><span class='line'>  <span class="c">#01  pc 0000f01c  /system/lib/libc.so (__pthread_cond_timedwait_relative+48)</span>
</span><span class='line'>  <span class="c">#02  pc 0000f07c  /system/lib/libc.so (__pthread_cond_timedwait+64)</span>
</span><span class='line'>  <span class="c">#03  pc 00055c67  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#04  pc 0006a5d5  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#05  pc 00029820  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#06  pc 00030cac  /system/lib/libdvm.so (dvmMterpStd(Thread*)+76)</span>
</span><span class='line'>  <span class="c">#07  pc 0002e344  /system/lib/libdvm.so (dvmInterpret(Thread*, Method const*, JValue*)+184)</span>
</span><span class='line'>  <span class="c">#08  pc 0006347d  /system/lib/libdvm.so (dvmCallMethodV(Thread*, Method const*, Object*, bool, JValue*, std::__va_list)+336)</span>
</span><span class='line'>  <span class="c">#09  pc 000634a1  /system/lib/libdvm.so (dvmCallMethod(Thread*, Method const*, Object*, JValue*, ...)+20)</span>
</span><span class='line'>  <span class="c">#10  pc 0005817f  /system/lib/libdvm.so</span>
</span><span class='line'>  <span class="c">#11  pc 0000d228  /system/lib/libc.so (__thread_entry+72)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Searched &ldquo;k worker thread&rdquo; in Mms code , find :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>./src/com/android/mms/data/Contact.java:552:                <span class="o">}</span>, <span class="s2">&quot;Contact.ContactsCache.TaskStack worker thread&quot;</span><span class="o">)</span>;
</span></code></pre></td></tr></table></div></figure>


<p>Actually &ldquo;k worker thread&rdquo; is truncated &ldquo;Contact.ContactsCache.TaskStack worker thread&rdquo;. Show its code as below:</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/data/Contact.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TaskStack</span> <span class="o">{</span>
</span><span class='line'>        <span class="n">Thread</span> <span class="n">mWorkerThread</span><span class="o">;</span>
</span><span class='line'>        <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">mThingsToLoad</span><span class="o">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">public</span> <span class="nf">TaskStack</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>            <span class="n">mThingsToLoad</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;();</span>
</span><span class='line'>            <span class="n">mWorkerThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                <span class="nd">@Override</span>
</span><span class='line'>                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class='line'>                    <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                        <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class='line'>                        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                                <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                                    <span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span><span class='line'>                                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                                    <span class="c1">// nothing to do</span>
</span><span class='line'>                                <span class="o">}</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                            <span class="k">if</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                                <span class="n">r</span> <span class="o">=</span> <span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span><span class='line'>                            <span class="o">}</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                        <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                            <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
</span><span class='line'>                        <span class="o">}</span>
</span><span class='line'>                    <span class="o">}</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>            <span class="o">},</span> <span class="s">&quot;Contact.ContactsCache.TaskStack worker thread&quot;</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mWorkerThread</span><span class="o">.</span><span class="na">setPriority</span><span class="o">(</span><span class="n">Thread</span><span class="o">.</span><span class="na">MIN_PRIORITY</span><span class="o">);</span>
</span><span class='line'>            <span class="n">mWorkerThread</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span><span class='line'>        <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can see in constructor of TaskStack, a thread (mWorkerThread) will be created and this thread  never exit, if constructor of TaskStack called multiple times, will create one thread each time.</p>

<p>TaskStack created inside ContactsCache</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/data/Contact.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">ContactsCache</span> <span class="o">{</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">TaskStack</span> <span class="n">mTaskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TaskStack</span><span class="o">();</span>
</span><span class='line'>    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">SEPARATOR</span> <span class="o">=</span> <span class="s">&quot;;&quot;</span><span class="o">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>ContactsCache created in <strong>init</strong> of Contact:</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/data/Contact.java </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">sContactCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContactsCache</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">RecipientIdCache</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally found when delete all conversations , it will call <strong>Contact.init()</strong> to rebuild contacts cache. So every time delte all conversations, will leak memory for a new thread.</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/ui/ConversationList.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'>    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDeleteComplete</span><span class="o">(</span><span class="kt">int</span> <span class="n">token</span><span class="o">,</span> <span class="n">Object</span> <span class="n">cookie</span><span class="o">,</span> <span class="kt">int</span> <span class="n">result</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="kd">super</span><span class="o">.</span><span class="na">onDeleteComplete</span><span class="o">(</span><span class="n">token</span><span class="o">,</span> <span class="n">cookie</span><span class="o">,</span> <span class="n">result</span><span class="o">);</span>
</span><span class='line'>        <span class="k">switch</span> <span class="o">(</span><span class="n">token</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">DELETE_CONVERSATION_TOKEN:</span>
</span><span class='line'>            <span class="kt">long</span> <span class="n">threadId</span> <span class="o">=</span> <span class="n">cookie</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="o">(</span><span class="n">Long</span><span class="o">)</span><span class="n">cookie</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>     <span class="c1">// default to all threads</span>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">threadId</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">threadId</span> <span class="o">==</span> <span class="n">mLastDeletedThread</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="n">mHandler</span><span class="o">.</span><span class="na">removeCallbacks</span><span class="o">(</span><span class="n">mShowProgressDialogRunnable</span><span class="o">);</span>
</span><span class='line'>                <span class="k">if</span> <span class="o">(</span><span class="n">mProgressDialog</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mProgressDialog</span><span class="o">.</span><span class="na">isShowing</span><span class="o">())</span> <span class="o">{</span>
</span><span class='line'>                    <span class="n">mProgressDialog</span><span class="o">.</span><span class="na">dismiss</span><span class="o">();</span>
</span><span class='line'>                <span class="o">}</span>
</span><span class='line'>                <span class="n">mLastDeletedThread</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span><span class='line'>            <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="o">(</span><span class="n">threadId</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>                <span class="c1">// Rebuild the contacts cache now that all threads and their associated unique</span>
</span><span class='line'>                <span class="c1">// recipients have been deleted.</span>
</span><span class='line'>                <span class="n">Contact</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">ConversationList</span><span class="o">.</span><span class="na">this</span><span class="o">);</span>
</span><span class='line'>            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span><span class='line'>            <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>To fix this issue, no need create a new thread every time or destory previous thread when you create one.</p>

<p>Google has provide a fix for this issue on Android L version:</p>

<figure class='code'><figcaption><span>packages/apps/Mms/src/com/android/mms/ui/ConversationList.java</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="nl">Author:</span> <span class="n">Emmanuel</span> <span class="n">Berthier</span> <span class="o">&lt;</span><span class="n">emmanuel</span><span class="o">.</span><span class="na">berthier</span><span class="nd">@intel.com</span><span class="o">&gt;</span>
</span><span class='line'><span class="nl">Date:</span>   <span class="n">Tue</span> <span class="n">Jul</span> <span class="mi">17</span> <span class="mi">16</span><span class="o">:</span><span class="mi">48</span><span class="o">:</span><span class="mi">10</span> <span class="mi">2012</span> <span class="o">+</span><span class="mi">0200</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Stop</span> <span class="n">previous</span> <span class="n">TaskStack</span> <span class="n">worker</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Each</span> <span class="n">time</span> <span class="n">we</span> <span class="n">delete</span> <span class="n">all</span> <span class="n">threads</span><span class="o">,</span> <span class="n">a</span> <span class="k">new</span> <span class="n">TaskStack</span> <span class="n">thread</span> <span class="n">is</span> <span class="n">started</span><span class="o">.</span>
</span><span class='line'>    <span class="n">We</span> <span class="n">need</span> <span class="n">stop</span> <span class="n">the</span> <span class="n">previous</span> <span class="n">one</span> <span class="n">to</span> <span class="n">avoid</span> <span class="n">over</span> <span class="n">memory</span> <span class="n">consumption</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Change</span><span class="o">-</span><span class="nl">Id:</span> <span class="n">Ibee8dd7b8e757df0686c7989dc7d9878f9ef5102</span>
</span><span class='line'>    <span class="n">Signed</span><span class="o">-</span><span class="n">off</span><span class="o">-</span><span class="nl">by:</span> <span class="n">Emmanuel</span> <span class="n">Berthier</span> <span class="o">&lt;</span><span class="n">emmanuel</span><span class="o">.</span><span class="na">berthier</span><span class="nd">@intel.com</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span> <span class="n">b</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span>
</span><span class='line'><span class="n">index</span> <span class="mi">5</span><span class="n">bc5bba</span><span class="o">..</span><span class="mi">87</span><span class="n">dcfe0</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">android</span><span class="o">/</span><span class="n">mms</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">Contact</span><span class="o">.</span><span class="na">java</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">355</span><span class="o">,</span><span class="mi">6</span> <span class="o">+</span><span class="mi">355</span><span class="o">,</span><span class="mi">9</span> <span class="err">@@</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Contact</span> <span class="o">{</span>
</span><span class='line'>     <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>     <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">(</span><span class="kd">final</span> <span class="n">Context</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">+</span>        <span class="k">if</span> <span class="o">(</span><span class="n">sContactCache</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// Stop previous Runnable</span>
</span><span class='line'><span class="o">+</span>            <span class="n">sContactCache</span><span class="o">.</span><span class="na">mTaskQueue</span><span class="o">.</span><span class="na">mWorkerThread</span><span class="o">.</span><span class="na">interrupt</span><span class="o">();</span>
</span><span class='line'><span class="o">+</span>        <span class="o">}</span>
</span><span class='line'>         <span class="n">sContactCache</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ContactsCache</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">RecipientIdCache</span><span class="o">.</span><span class="na">init</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">503</span><span class="o">,</span><span class="mi">7</span> <span class="o">+</span><span class="mi">506</span><span class="o">,</span><span class="mi">7</span> <span class="err">@@</span> <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Contact</span> <span class="o">{</span>
</span><span class='line'>                                     <span class="k">try</span> <span class="o">{</span>
</span><span class='line'>                                         <span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">wait</span><span class="o">();</span>
</span><span class='line'>                                     <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'><span class="o">-</span>                                        <span class="c1">// nothing to do</span>
</span><span class='line'><span class="o">+</span>                                        <span class="k">break</span><span class="o">;</span>  <span class="c1">// Exception sent by Contact.init() to stop Runnable</span>
</span><span class='line'>                                     <span class="o">}</span>
</span><span class='line'>                                 <span class="o">}</span>
</span><span class='line'>                                 <span class="k">if</span> <span class="o">(</span><span class="n">mThingsToLoad</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this fix, when new TaskStack created , it will stop previous thread inside it.</p>

<h3>Summary</h3>

<p>For such <strong>&ldquo;Could not allocate &hellip; due to -12&rdquo;</strong> issue,  need to check process memory status and make clear what consumed the memory.</p>

<p>Use <code>top</code> , <code>meminfo</code>, <code>ps</code>, <code>procrank</code>,<code>procmem</code> to check summary of memory.
Use <code>cat /proc/self/maps</code>, <code>cat /proc/self/status</code> to konw details.</p>

<h3>Appendix</h3>

<ul>
<li><code>man proc</code> to see <code>/proc/[pid]/maps</code> info:</li>
</ul>


<blockquote><p> /proc/[pid]/maps</p>

<pre><code>          A file containing the currently mapped memory regions and
          their access permissions.  See mmap(2) for some further
          information about memory mappings.
</code></pre></blockquote>

<pre><code>          The format of the file is:

   address           perms offset  dev   inode       pathname
   00400000-00452000 r-xp 00000000 08:02 173521      /usr/bin/dbus-daemon
   00651000-00652000 r--p 00051000 08:02 173521      /usr/bin/dbus-daemon
   00652000-00655000 rw-p 00052000 08:02 173521      /usr/bin/dbus-daemon
   00e03000-00e24000 rw-p 00000000 00:00 0           [heap]
   00e24000-011f7000 rw-p 00000000 00:00 0           [heap]
   ...
   35b1800000-35b1820000 r-xp 00000000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a1f000-35b1a20000 r--p 0001f000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a20000-35b1a21000 rw-p 00020000 08:02 135522  /usr/lib64/ld-2.15.so
   35b1a21000-35b1a22000 rw-p 00000000 00:00 0
   35b1c00000-35b1dac000 r-xp 00000000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1dac000-35b1fac000 ---p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1fac000-35b1fb0000 r--p 001ac000 08:02 135870  /usr/lib64/libc-2.15.so
   35b1fb0000-35b1fb2000 rw-p 001b0000 08:02 135870  /usr/lib64/libc-2.15.so
   ...
   f2c6ff8c000-7f2c7078c000 rw-p 00000000 00:00 0    [stack:986]
   ...
   7fffb2c0d000-7fffb2c2e000 rw-p 00000000 00:00 0   [stack]
   7fffb2d48000-7fffb2d49000 r-xp 00000000 00:00 0   [vdso]

          The address field is the address space in the process that the
          mapping occupies.  The perms field is a set of permissions:

               r = read
               w = write
               x = execute
               s = shared
               p = private (copy on write)

          The offset field is the offset into the file/whatever; dev is
          the device (major:minor); inode is the inode on that device.
          0 indicates that no inode is associated with the memory
          region, as would be the case with BSS (uninitialized data).

          The pathname field will usually be the file that is backing
          the mapping.  For ELF files, you can easily coordinate with
          the offset field by looking at the Offset field in the ELF
          program headers (readelf -l).

          There are additional helpful pseudo-paths:

               [stack]
                      The initial process's (also known as the main
                      thread's) stack.

               [stack:&lt;tid&gt;] (since Linux 3.4)
                      A thread's stack (where the &lt;tid&gt; is a thread ID).
                      It corresponds to the /proc/[pid]/task/[tid]/
                      path.

               [vdso] The virtual dynamically linked shared object.

               [heap] The process's heap.

          If the pathname field is blank, this is an anonymous mapping
          as obtained via the mmap(2) function.  There is no easy way to
          coordinate this back to a process's source, short of running
          it through gdb(1), strace(1), or similar.

          Under Linux 2.0, there is no field giving pathname.
</code></pre>

<h3>Useful link</h3>

<ul>
<li><a href="https://developer.android.com/training/articles/memory.html">android dev memory article</a></li>
<li><a href="http://elinux.org/Android_Memory_Usage">Android_Memory_Usage</a></li>
<li><a href="http://man7.org/linux/man-pages/man5/proc.5.html">man proc</a></li>
<li><a href="http://man7.org/linux/man-pages/man2/mmap.2.html">man mmap</a></li>
<li><a href="http://stackoverflow.com/questions/1401359/understanding-linux-proc-id-maps">understanding-linux-proc-id-maps</a></li>
<li><a href="http://elinux.org/Runtime_Memory_Measurement">Runtime_Memory_Measurement</a></li>
<li><a href="http://gauss.ececs.uc.edu/Courses/c4022/code/memory/understanding.pdf">Understanding the Linux Kernel, 3rd Edition</a></li>
<li><a href="https://www.kernel.org/doc/gorman/pdf/understand.pdf">Unserstanding the Linux Virtual Memory Manager</a></li>
</ul>

</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">zhibin</span></span>

      








  


<time datetime="2014-11-17T14:27:00+08:00" pubdate data-updated="true">Nov 17<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cursor-leak/'>cursor leak</a>, <a class='category' href='/blog/categories/memory/'>memory</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://SteveVallay.github.io/blog/2014/11/17/memory-leak/" data-via="zhibin_" data-counturl="http://SteveVallay.github.io/blog/2014/11/17/memory-leak/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2014/05/23/file-access-permissions/" title="Previous Post: file access permissions summary ">&laquo; file access permissions summary </a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/11/17/memory-leak/">Android Memory Leak</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/23/file-access-permissions/">File Access Permissions Summary</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/22/hearthstone-cards/">Hearthstone_cards</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/22/sms/">Android Sms</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/12/permissions-on-folder/">Permissions on Folder</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/SteveVallay">@SteveVallay</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'SteveVallay',
            count: 2,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - zhibin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'zhibin';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://SteveVallay.github.io/blog/2014/11/17/memory-leak/';
        var disqus_url = 'http://SteveVallay.github.io/blog/2014/11/17/memory-leak/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
